"use strict";(self.webpackChunkauditor_docs=self.webpackChunkauditor_docs||[]).push([[7746],{717(e,n,r){r.r(n),r.d(n,{assets:()=>c,contentTitle:()=>a,default:()=>l,frontMatter:()=>o,metadata:()=>i,toc:()=>u});const i=JSON.parse('{"id":"customization/user-provider","title":"User Provider","description":"Customize how the current user is identified in audit entries","source":"@site/docs/auditor-bundle/customization/user-provider.md","sourceDirName":"customization","slug":"/customization/user-provider","permalink":"/auditor-docs/auditor-bundle/customization/user-provider","draft":false,"unlisted":false,"tags":[],"version":"current","frontMatter":{},"sidebar":"auditorBundleSidebar","previous":{"title":"Customization","permalink":"/auditor-docs/auditor-bundle/customization/"},"next":{"title":"Security Provider","permalink":"/auditor-docs/auditor-bundle/customization/security-provider"}}');var t=r(4848),s=r(8453);const o={},a="User Provider",c={},u=[{value:"\ud83d\udcdd Interface",id:"-interface",level:2},{value:"\ud83d\udce6 Built-in Provider",id:"-built-in-provider",level:2},{value:"\ud83d\udda5\ufe0f Console Commands",id:"\ufe0f-console-commands",level:2},{value:"\ud83d\udd27 Creating a Custom Provider",id:"-creating-a-custom-provider",level:2},{value:"Basic Example",id:"basic-example",level:3},{value:"Registration",id:"registration",level:3},{value:"\ud83d\udcda Examples",id:"-examples",level:2},{value:"\ud83d\udd11 API Token Authentication",id:"-api-token-authentication",level:3},{value:"\ud83c\udf10 External OAuth/SSO",id:"-external-oauthsso",level:3},{value:"\ud83d\udd00 Combining Multiple Sources",id:"-combining-multiple-sources",level:3},{value:"\ud83d\ude80 Next Steps",id:"-next-steps",level:2}];function d(e){const n={a:"a",blockquote:"blockquote",code:"code",div:"div",h1:"h1",h2:"h2",h3:"h3",header:"header",hr:"hr",li:"li",p:"p",path:"path",pre:"pre",strong:"strong",svg:"svg",ul:"ul",...(0,s.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(n.header,{children:(0,t.jsx)(n.h1,{id:"user-provider",children:"User Provider"})}),"\n",(0,t.jsxs)(n.blockquote,{children:["\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Customize how the current user is identified in audit entries"})}),"\n"]}),"\n",(0,t.jsx)(n.p,{children:"A user provider returns information about the current user for audit entries."}),"\n",(0,t.jsx)(n.h2,{id:"-interface",children:"\ud83d\udcdd Interface"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-php",children:"namespace DH\\Auditor\\User;\n\ninterface UserProviderInterface\n{\n    public function __invoke(): ?UserInterface;\n}\n"})}),"\n",(0,t.jsxs)(n.p,{children:["The provider must return a ",(0,t.jsx)(n.code,{children:"UserInterface"})," or ",(0,t.jsx)(n.code,{children:"null"}),":"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-php",children:"namespace DH\\Auditor\\User;\n\ninterface UserInterface\n{\n    public function getIdentifier(): ?string;\n    public function getUsername(): ?string;\n}\n"})}),"\n",(0,t.jsx)(n.h2,{id:"-built-in-provider",children:"\ud83d\udce6 Built-in Provider"}),"\n",(0,t.jsxs)(n.p,{children:["The default ",(0,t.jsx)(n.code,{children:"DH\\AuditorBundle\\User\\UserProvider"}),":"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-php",children:"public function __invoke(): ?UserInterface\n{\n    $tokenUser = $this->getTokenUser();\n    $impersonatorUser = $this->getImpersonatorUser();\n\n    // Get identifier if getId() method exists\n    $identifier = null;\n    if ($tokenUser instanceof SymfonyUserInterface) {\n        if (method_exists($tokenUser, 'getId')) {\n            $identifier = $tokenUser->getId();\n        }\n        $username = $tokenUser->getUserIdentifier();\n    }\n\n    // Track impersonation\n    if ($impersonatorUser instanceof SymfonyUserInterface) {\n        $username .= '[impersonator '.$impersonatorUser->getUserIdentifier().']';\n    }\n\n    if (null === $identifier && null === $username) {\n        return null;\n    }\n\n    return new User((string) $identifier, $username);\n}\n"})}),"\n",(0,t.jsx)(n.h2,{id:"\ufe0f-console-commands",children:"\ud83d\udda5\ufe0f Console Commands"}),"\n",(0,t.jsxs)(n.p,{children:["For CLI commands, the bundle provides ",(0,t.jsx)(n.code,{children:"DH\\AuditorBundle\\User\\ConsoleUserProvider"})," which automatically tracks the command name:"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-php",children:"public function __invoke(): ?UserInterface\n{\n    if (null === $this->currentCommand) {\n        return null;\n    }\n\n    // Command name is used as both ID and username\n    return new User(\n        $this->currentCommand,  // e.g., 'app:import-users'\n        $this->currentCommand\n    );\n}\n"})}),"\n",(0,t.jsxs)(n.div,{className:"markdown-alert markdown-alert-tip",dir:"auto",children:["\n",(0,t.jsxs)(n.p,{className:"markdown-alert-title",dir:"auto",children:[(0,t.jsx)(n.svg,{className:"octicon",viewBox:"0 0 16 16",width:"16",height:"16","aria-hidden":"true",children:(0,t.jsx)(n.path,{d:"M8 1.5c-2.363 0-4 1.69-4 3.75 0 .984.424 1.625.984 2.304l.214.253c.223.264.47.556.673.848.284.411.537.896.621 1.49a.75.75 0 0 1-1.484.211c-.04-.282-.163-.547-.37-.847a8.456 8.456 0 0 0-.542-.68c-.084-.1-.173-.205-.268-.32C3.201 7.75 2.5 6.766 2.5 5.25 2.5 2.31 4.863 0 8 0s5.5 2.31 5.5 5.25c0 1.516-.701 2.5-1.328 3.259-.095.115-.184.22-.268.319-.207.245-.383.453-.541.681-.208.3-.33.565-.37.847a.751.751 0 0 1-1.485-.212c.084-.593.337-1.078.621-1.489.203-.292.45-.584.673-.848.075-.088.147-.173.213-.253.561-.679.985-1.32.985-2.304 0-2.06-1.637-3.75-4-3.75ZM5.75 12h4.5a.75.75 0 0 1 0 1.5h-4.5a.75.75 0 0 1 0-1.5ZM6 15.25a.75.75 0 0 1 .75-.75h2.5a.75.75 0 0 1 0 1.5h-2.5a.75.75 0 0 1-.75-.75Z"})}),"TIP"]}),"\n",(0,t.jsx)(n.p,{children:"This allows you to:"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"\ud83d\udd0d Identify which command made specific changes"}),"\n",(0,t.jsx)(n.li,{children:"\ud83d\udd0e Filter audit entries by command in the viewer"}),"\n",(0,t.jsx)(n.li,{children:"\ud83d\udcca Track automated processes separately from user actions"}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Example audit entries:"})}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"app:import-users"})," - Import command"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"doctrine:fixtures:load"})," - Fixtures loading"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"app:sync-products"})," - Sync command"]}),"\n"]}),"\n",(0,t.jsx)(n.h2,{id:"-creating-a-custom-provider",children:"\ud83d\udd27 Creating a Custom Provider"}),"\n",(0,t.jsx)(n.h3,{id:"basic-example",children:"Basic Example"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-php",children:"<?php\n\nnamespace App\\Audit;\n\nuse DH\\Auditor\\User\\User;\nuse DH\\Auditor\\User\\UserInterface;\nuse DH\\Auditor\\User\\UserProviderInterface;\n\nclass CustomUserProvider implements UserProviderInterface\n{\n    public function __construct(\n        private readonly MyAuthService $authService,\n    ) {}\n\n    public function __invoke(): ?UserInterface\n    {\n        $user = $this->authService->getCurrentUser();\n\n        if (null === $user) {\n            return null;\n        }\n\n        return new User(\n            (string) $user->getId(),\n            $user->getEmail()\n        );\n    }\n}\n"})}),"\n",(0,t.jsx)(n.h3,{id:"registration",children:"Registration"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-yaml",children:"# config/packages/dh_auditor.yaml\ndh_auditor:\n    user_provider: 'App\\Audit\\CustomUserProvider'\n"})}),"\n",(0,t.jsx)(n.p,{children:"The service is auto-wired. If you need explicit configuration:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-yaml",children:"# config/services.yaml\nservices:\n    App\\Audit\\CustomUserProvider:\n        arguments:\n            - '@App\\Security\\MyAuthService'\n"})}),"\n",(0,t.jsx)(n.h2,{id:"-examples",children:"\ud83d\udcda Examples"}),"\n",(0,t.jsx)(n.h3,{id:"-api-token-authentication",children:"\ud83d\udd11 API Token Authentication"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-php",children:"<?php\n\nnamespace App\\Audit;\n\nuse App\\Security\\ApiTokenManager;\nuse DH\\Auditor\\User\\User;\nuse DH\\Auditor\\User\\UserInterface;\nuse DH\\Auditor\\User\\UserProviderInterface;\n\nclass ApiUserProvider implements UserProviderInterface\n{\n    public function __construct(\n        private readonly ApiTokenManager $tokenManager,\n    ) {}\n\n    public function __invoke(): ?UserInterface\n    {\n        $token = $this->tokenManager->getCurrentToken();\n\n        if (null === $token) {\n            return null;\n        }\n\n        return new User(\n            $token->getClientId(),\n            sprintf('API: %s', $token->getClientName())\n        );\n    }\n}\n"})}),"\n",(0,t.jsx)(n.h3,{id:"-external-oauthsso",children:"\ud83c\udf10 External OAuth/SSO"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-php",children:"<?php\n\nnamespace App\\Audit;\n\nuse DH\\Auditor\\User\\User;\nuse DH\\Auditor\\User\\UserInterface;\nuse DH\\Auditor\\User\\UserProviderInterface;\nuse Symfony\\Component\\HttpFoundation\\RequestStack;\n\nclass OAuthUserProvider implements UserProviderInterface\n{\n    public function __construct(\n        private readonly RequestStack $requestStack,\n    ) {}\n\n    public function __invoke(): ?UserInterface\n    {\n        $request = $this->requestStack->getCurrentRequest();\n\n        if (null === $request) {\n            return null;\n        }\n\n        // User info from OAuth headers\n        $userId = $request->headers->get('X-User-Id');\n        $userName = $request->headers->get('X-User-Email');\n\n        if (null === $userId) {\n            return null;\n        }\n\n        return new User($userId, $userName ?? 'unknown');\n    }\n}\n"})}),"\n",(0,t.jsx)(n.h3,{id:"-combining-multiple-sources",children:"\ud83d\udd00 Combining Multiple Sources"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-php",children:"<?php\n\nnamespace App\\Audit;\n\nuse App\\Security\\ApiTokenManager;\nuse DH\\Auditor\\User\\User;\nuse DH\\Auditor\\User\\UserInterface;\nuse DH\\Auditor\\User\\UserProviderInterface;\nuse Symfony\\Component\\Security\\Core\\Authentication\\Token\\Storage\\TokenStorageInterface;\n\nclass CompositeUserProvider implements UserProviderInterface\n{\n    public function __construct(\n        private readonly TokenStorageInterface $tokenStorage,\n        private readonly ApiTokenManager $apiTokenManager,\n    ) {}\n\n    public function __invoke(): ?UserInterface\n    {\n        // Try Symfony security first\n        $token = $this->tokenStorage->getToken();\n        if (null !== $token && null !== $token->getUser()) {\n            $user = $token->getUser();\n            return new User(\n                method_exists($user, 'getId') ? (string) $user->getId() : '',\n                $user->getUserIdentifier()\n            );\n        }\n\n        // Fall back to API token\n        $apiToken = $this->apiTokenManager->getCurrentToken();\n        if (null !== $apiToken) {\n            return new User(\n                $apiToken->getClientId(),\n                'API: ' . $apiToken->getClientName()\n            );\n        }\n\n        return null;\n    }\n}\n"})}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h2,{id:"-next-steps",children:"\ud83d\ude80 Next Steps"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["\ud83d\udd12 ",(0,t.jsx)(n.a,{href:"/auditor-docs/auditor-bundle/customization/security-provider",children:"Security Provider"})," - Customize IP/context detection"]}),"\n",(0,t.jsxs)(n.li,{children:["\ud83d\udee1\ufe0f ",(0,t.jsx)(n.a,{href:"/auditor-docs/auditor-bundle/customization/role-checker",children:"Role Checker"})," - Customize access control"]}),"\n"]})]})}function l(e={}){const{wrapper:n}={...(0,s.R)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(d,{...e})}):d(e)}},8453(e,n,r){r.d(n,{R:()=>o,x:()=>a});var i=r(6540);const t={},s=i.createContext(t);function o(e){const n=i.useContext(s);return i.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:o(e.components),i.createElement(s.Provider,{value:n},e.children)}}}]);