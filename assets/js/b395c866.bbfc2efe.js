"use strict";(self.webpackChunkauditor_docs=self.webpackChunkauditor_docs||[]).push([[3557],{35074(e,i,r){r.r(i),r.d(i,{assets:()=>c,contentTitle:()=>d,default:()=>g,frontMatter:()=>s,metadata:()=>n,toc:()=>o});const n=JSON.parse('{"id":"providers/doctrine/services","title":"Auditing and Storage Services","description":"Understand how DoctrineProvider detects and persists audit logs","source":"@site/docs/auditor/providers/doctrine/services.md","sourceDirName":"providers/doctrine","slug":"/providers/doctrine/services","permalink":"/auditor-docs/auditor/providers/doctrine/services","draft":false,"unlisted":false,"tags":[],"version":"current","frontMatter":{},"sidebar":"auditorSidebar","previous":{"title":"Attributes Reference","permalink":"/auditor-docs/auditor/providers/doctrine/attributes"},"next":{"title":"Multi-Database Configuration","permalink":"/auditor-docs/auditor/providers/doctrine/multi-database"}}');var t=r(74848),a=r(28453);const s={},d="Auditing and Storage Services",c={},o=[{value:"\ud83d\udd0d Overview",id:"-overview",level:2},{value:"\ud83d\udcdd Auditing Service",id:"-auditing-service",level:2},{value:"Creating an Auditing Service",id:"creating-an-auditing-service",level:3},{value:"Registering with the Provider",id:"registering-with-the-provider",level:3},{value:"\ud83d\udcbe Storage Service",id:"-storage-service",level:2},{value:"Creating a Storage Service",id:"creating-a-storage-service",level:3},{value:"Registering with the Provider",id:"registering-with-the-provider-1",level:3},{value:"\ud83c\udfe0 Common Setup: Single Database",id:"-common-setup-single-database",level:2},{value:"\ud83d\uddc4\ufe0f Multi-Database Setup",id:"\ufe0f-multi-database-setup",level:2},{value:"Separate Audit Database",id:"separate-audit-database",level:3},{value:"Multiple Databases with Router",id:"multiple-databases-with-router",level:3},{value:"\ud83d\udd0d Getting Services from Provider",id:"-getting-services-from-provider",level:2},{value:"Get All Auditing Services",id:"get-all-auditing-services",level:3},{value:"Get All Storage Services",id:"get-all-storage-services",level:3},{value:"Get Service for Specific Entity",id:"get-service-for-specific-entity",level:3},{value:"\ud83d\udcdb Service Names",id:"-service-names",level:2},{value:"\ud83d\udce6 Base Service Class",id:"-base-service-class",level:2},{value:"\u26a0\ufe0f Error Handling",id:"\ufe0f-error-handling",level:2},{value:"Duplicate Service Names",id:"duplicate-service-names",level:3},{value:"Missing Storage Mapper",id:"missing-storage-mapper",level:3},{value:"\u2705 Best Practices",id:"-best-practices",level:2},{value:"Next Steps",id:"next-steps",level:2}];function l(e){const i={a:"a",blockquote:"blockquote",code:"code",div:"div",h1:"h1",h2:"h2",h3:"h3",header:"header",hr:"hr",li:"li",mermaid:"mermaid",ol:"ol",p:"p",path:"path",pre:"pre",strong:"strong",svg:"svg",ul:"ul",...(0,a.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(i.header,{children:(0,t.jsx)(i.h1,{id:"auditing-and-storage-services",children:"Auditing and Storage Services"})}),"\n",(0,t.jsxs)(i.blockquote,{children:["\n",(0,t.jsx)(i.p,{children:(0,t.jsx)(i.strong,{children:"Understand how DoctrineProvider detects and persists audit logs"})}),"\n"]}),"\n",(0,t.jsxs)(i.p,{children:["The DoctrineProvider uses two types of services: ",(0,t.jsx)(i.strong,{children:"Auditing Services"})," for detecting changes and ",(0,t.jsx)(i.strong,{children:"Storage Services"})," for persisting audit logs."]}),"\n",(0,t.jsx)(i.h2,{id:"-overview",children:"\ud83d\udd0d Overview"}),"\n",(0,t.jsx)(i.mermaid,{value:'flowchart TB\n    subgraph DoctrineProvider\n        subgraph "Auditing Services"\n            AS1["EntityManager A<br>(App entities)"]\n            AS2["EntityManager B<br>(More entities)"]\n        end\n        \n        subgraph "Storage Services"\n            SS1["EntityManager X<br>(Audit DB)"]\n            SS2["EntityManager Y<br>(Another DB)"]\n        end\n    end'}),"\n",(0,t.jsx)(i.h2,{id:"-auditing-service",children:"\ud83d\udcdd Auditing Service"}),"\n",(0,t.jsxs)(i.p,{children:["The ",(0,t.jsx)(i.code,{children:"AuditingService"})," wraps a Doctrine EntityManager and is responsible for:"]}),"\n",(0,t.jsxs)(i.ul,{children:["\n",(0,t.jsx)(i.li,{children:"Listening to entity changes (via Doctrine events)"}),"\n",(0,t.jsx)(i.li,{children:"Collecting change data (inserts, updates, deletes, associations)"}),"\n",(0,t.jsx)(i.li,{children:"Passing changes to the storage layer"}),"\n"]}),"\n",(0,t.jsx)(i.h3,{id:"creating-an-auditing-service",children:"Creating an Auditing Service"}),"\n",(0,t.jsx)(i.pre,{children:(0,t.jsx)(i.code,{className:"language-php",children:"<?php\n\nuse DH\\Auditor\\Provider\\Doctrine\\Service\\AuditingService;\n\n$auditingService = new AuditingService(\n    'default',      // Service name (unique identifier)\n    $entityManager  // The EntityManager to watch\n);\n"})}),"\n",(0,t.jsx)(i.h3,{id:"registering-with-the-provider",children:"Registering with the Provider"}),"\n",(0,t.jsx)(i.pre,{children:(0,t.jsx)(i.code,{className:"language-php",children:"$provider->registerAuditingService($auditingService);\n"})}),"\n",(0,t.jsx)(i.h2,{id:"-storage-service",children:"\ud83d\udcbe Storage Service"}),"\n",(0,t.jsxs)(i.p,{children:["The ",(0,t.jsx)(i.code,{children:"StorageService"})," wraps a Doctrine EntityManager and is responsible for:"]}),"\n",(0,t.jsxs)(i.ul,{children:["\n",(0,t.jsx)(i.li,{children:"Storing audit entries in the database"}),"\n",(0,t.jsx)(i.li,{children:"Managing audit table schemas"}),"\n"]}),"\n",(0,t.jsx)(i.h3,{id:"creating-a-storage-service",children:"Creating a Storage Service"}),"\n",(0,t.jsx)(i.pre,{children:(0,t.jsx)(i.code,{className:"language-php",children:"<?php\n\nuse DH\\Auditor\\Provider\\Doctrine\\Service\\StorageService;\n\n$storageService = new StorageService(\n    'default',      // Service name (unique identifier)\n    $entityManager  // The EntityManager for audit storage\n);\n"})}),"\n",(0,t.jsx)(i.h3,{id:"registering-with-the-provider-1",children:"Registering with the Provider"}),"\n",(0,t.jsx)(i.pre,{children:(0,t.jsx)(i.code,{className:"language-php",children:"$provider->registerStorageService($storageService);\n"})}),"\n",(0,t.jsx)(i.h2,{id:"-common-setup-single-database",children:"\ud83c\udfe0 Common Setup: Single Database"}),"\n",(0,t.jsx)(i.p,{children:"Most applications store audits in the same database as the entities:"}),"\n",(0,t.jsx)(i.pre,{children:(0,t.jsx)(i.code,{className:"language-php",children:"<?php\n\nuse DH\\Auditor\\Provider\\Doctrine\\DoctrineProvider;\nuse DH\\Auditor\\Provider\\Doctrine\\Configuration;\nuse DH\\Auditor\\Provider\\Doctrine\\Service\\AuditingService;\nuse DH\\Auditor\\Provider\\Doctrine\\Service\\StorageService;\n\n// Create provider\n$provider = new DoctrineProvider(new Configuration([\n    'table_suffix' => '_audit',\n]));\n\n// Use the same EntityManager for both\n$provider->registerAuditingService(new AuditingService('default', $entityManager));\n$provider->registerStorageService(new StorageService('default', $entityManager));\n"})}),"\n",(0,t.jsx)(i.h2,{id:"\ufe0f-multi-database-setup",children:"\ud83d\uddc4\ufe0f Multi-Database Setup"}),"\n",(0,t.jsxs)(i.div,{className:"markdown-alert markdown-alert-tip",dir:"auto",children:["\n",(0,t.jsxs)(i.p,{className:"markdown-alert-title",dir:"auto",children:[(0,t.jsx)(i.svg,{className:"octicon",viewBox:"0 0 16 16",width:"16",height:"16","aria-hidden":"true",children:(0,t.jsx)(i.path,{d:"M8 1.5c-2.363 0-4 1.69-4 3.75 0 .984.424 1.625.984 2.304l.214.253c.223.264.47.556.673.848.284.411.537.896.621 1.49a.75.75 0 0 1-1.484.211c-.04-.282-.163-.547-.37-.847a8.456 8.456 0 0 0-.542-.68c-.084-.1-.173-.205-.268-.32C3.201 7.75 2.5 6.766 2.5 5.25 2.5 2.31 4.863 0 8 0s5.5 2.31 5.5 5.25c0 1.516-.701 2.5-1.328 3.259-.095.115-.184.22-.268.319-.207.245-.383.453-.541.681-.208.3-.33.565-.37.847a.751.751 0 0 1-1.485-.212c.084-.593.337-1.078.621-1.489.203-.292.45-.584.673-.848.075-.088.147-.173.213-.253.561-.679.985-1.32.985-2.304 0-2.06-1.637-3.75-4-3.75ZM5.75 12h4.5a.75.75 0 0 1 0 1.5h-4.5a.75.75 0 0 1 0-1.5ZM6 15.25a.75.75 0 0 1 .75-.75h2.5a.75.75 0 0 1 0 1.5h-2.5a.75.75 0 0 1-.75-.75Z"})}),"TIP"]}),"\n",(0,t.jsx)(i.p,{children:"For performance or compliance reasons, you might want to store audits in a separate database."}),"\n"]}),"\n",(0,t.jsx)(i.h3,{id:"separate-audit-database",children:"Separate Audit Database"}),"\n",(0,t.jsx)(i.pre,{children:(0,t.jsx)(i.code,{className:"language-php",children:"<?php\n\n// Main application EntityManager\n$appEntityManager = $this->getDoctrine()->getManager('default');\n\n// Dedicated audit database EntityManager\n$auditEntityManager = $this->getDoctrine()->getManager('audit');\n\n$provider = new DoctrineProvider(new Configuration([\n    'table_suffix' => '_audit',\n]));\n\n// Watch entities in the main database\n$provider->registerAuditingService(new AuditingService('default', $appEntityManager));\n\n// Store audits in the audit database\n$provider->registerStorageService(new StorageService('audit', $auditEntityManager));\n"})}),"\n",(0,t.jsx)(i.h3,{id:"multiple-databases-with-router",children:"Multiple Databases with Router"}),"\n",(0,t.jsx)(i.p,{children:"When you have multiple EntityManagers and want to route audits dynamically:"}),"\n",(0,t.jsx)(i.pre,{children:(0,t.jsx)(i.code,{className:"language-php",children:"<?php\n\n$provider = new DoctrineProvider(new Configuration([\n    'table_suffix' => '_audit',\n    'storage_mapper' => function (string $entity, array $storageServices) {\n        // Route based on entity namespace\n        if (str_starts_with($entity, 'App\\\\Entity\\\\Core\\\\')) {\n            return $storageServices['core_audit'];\n        }\n        if (str_starts_with($entity, 'App\\\\Entity\\\\Finance\\\\')) {\n            return $storageServices['finance_audit'];\n        }\n        return $storageServices['default'];\n    },\n]));\n\n// Register auditing services (where changes are detected)\n$provider->registerAuditingService(new AuditingService('core', $coreEntityManager));\n$provider->registerAuditingService(new AuditingService('finance', $financeEntityManager));\n\n// Register storage services (where audits are stored)\n$provider->registerStorageService(new StorageService('default', $defaultAuditEntityManager));\n$provider->registerStorageService(new StorageService('core_audit', $coreAuditEntityManager));\n$provider->registerStorageService(new StorageService('finance_audit', $financeAuditEntityManager));\n"})}),"\n",(0,t.jsxs)(i.p,{children:["See ",(0,t.jsx)(i.a,{href:"/auditor-docs/auditor/providers/doctrine/multi-database",children:"Multi-Database Configuration"})," for more details."]}),"\n",(0,t.jsx)(i.h2,{id:"-getting-services-from-provider",children:"\ud83d\udd0d Getting Services from Provider"}),"\n",(0,t.jsx)(i.h3,{id:"get-all-auditing-services",children:"Get All Auditing Services"}),"\n",(0,t.jsx)(i.pre,{children:(0,t.jsx)(i.code,{className:"language-php",children:"$auditingServices = $provider->getAuditingServices();\n// Returns: ['service_name' => AuditingService, ...]\n"})}),"\n",(0,t.jsx)(i.h3,{id:"get-all-storage-services",children:"Get All Storage Services"}),"\n",(0,t.jsx)(i.pre,{children:(0,t.jsx)(i.code,{className:"language-php",children:"$storageServices = $provider->getStorageServices();\n// Returns: ['service_name' => StorageService, ...]\n"})}),"\n",(0,t.jsx)(i.h3,{id:"get-service-for-specific-entity",children:"Get Service for Specific Entity"}),"\n",(0,t.jsx)(i.pre,{children:(0,t.jsx)(i.code,{className:"language-php",children:"// Get the auditing service that manages this entity\n$auditingService = $provider->getAuditingServiceForEntity(User::class);\n\n// Get the storage service where this entity's audits are stored\n$storageService = $provider->getStorageServiceForEntity(User::class);\n"})}),"\n",(0,t.jsx)(i.h2,{id:"-service-names",children:"\ud83d\udcdb Service Names"}),"\n",(0,t.jsxs)(i.div,{className:"markdown-alert markdown-alert-important",dir:"auto",children:["\n",(0,t.jsxs)(i.p,{className:"markdown-alert-title",dir:"auto",children:[(0,t.jsx)(i.svg,{className:"octicon",viewBox:"0 0 16 16",width:"16",height:"16","aria-hidden":"true",children:(0,t.jsx)(i.path,{d:"M0 1.75C0 .784.784 0 1.75 0h12.5C15.216 0 16 .784 16 1.75v9.5A1.75 1.75 0 0 1 14.25 13H8.06l-2.573 2.573A1.458 1.458 0 0 1 3 14.543V13H1.75A1.75 1.75 0 0 1 0 11.25Zm1.75-.25a.25.25 0 0 0-.25.25v9.5c0 .138.112.25.25.25h2a.75.75 0 0 1 .75.75v2.19l2.72-2.72a.749.749 0 0 1 .53-.22h6.5a.25.25 0 0 0 .25-.25v-9.5a.25.25 0 0 0-.25-.25Zm7 2.25v2.5a.75.75 0 0 1-1.5 0v-2.5a.75.75 0 0 1 1.5 0ZM9 9a1 1 0 1 1-2 0 1 1 0 0 1 2 0Z"})}),"IMPORTANT"]}),"\n",(0,t.jsx)(i.p,{children:"Service names must be unique within their type (auditing or storage)."}),"\n"]}),"\n",(0,t.jsx)(i.p,{children:"They're used for:"}),"\n",(0,t.jsxs)(i.ul,{children:["\n",(0,t.jsx)(i.li,{children:"Identifying services in logs and debugging"}),"\n",(0,t.jsx)(i.li,{children:"Mapping entities to storage services"}),"\n",(0,t.jsx)(i.li,{children:"Configuration and reference"}),"\n"]}),"\n",(0,t.jsx)(i.pre,{children:(0,t.jsx)(i.code,{className:"language-php",children:"// Bad: Non-descriptive names\nnew AuditingService('a', $em);\n\n// Good: Descriptive names\nnew AuditingService('app_default', $appEm);\nnew AuditingService('legacy_crm', $crmEm);\nnew StorageService('primary_audit_storage', $auditEm);\n"})}),"\n",(0,t.jsx)(i.h2,{id:"-base-service-class",children:"\ud83d\udce6 Base Service Class"}),"\n",(0,t.jsxs)(i.p,{children:["Both ",(0,t.jsx)(i.code,{children:"AuditingService"})," and ",(0,t.jsx)(i.code,{children:"StorageService"})," extend ",(0,t.jsx)(i.code,{children:"DoctrineService"}),":"]}),"\n",(0,t.jsx)(i.pre,{children:(0,t.jsx)(i.code,{className:"language-php",children:"namespace DH\\Auditor\\Provider\\Doctrine\\Service;\n\nabstract class DoctrineService extends AbstractService\n{\n    public function __construct(string $name, EntityManagerInterface $entityManager);\n    \n    public function getEntityManager(): EntityManagerInterface;\n}\n"})}),"\n",(0,t.jsx)(i.h2,{id:"\ufe0f-error-handling",children:"\u26a0\ufe0f Error Handling"}),"\n",(0,t.jsx)(i.h3,{id:"duplicate-service-names",children:"Duplicate Service Names"}),"\n",(0,t.jsxs)(i.div,{className:"markdown-alert markdown-alert-warning",dir:"auto",children:["\n",(0,t.jsxs)(i.p,{className:"markdown-alert-title",dir:"auto",children:[(0,t.jsx)(i.svg,{className:"octicon",viewBox:"0 0 16 16",width:"16",height:"16","aria-hidden":"true",children:(0,t.jsx)(i.path,{d:"M6.457 1.047c.659-1.234 2.427-1.234 3.086 0l6.082 11.378A1.75 1.75 0 0 1 14.082 15H1.918a1.75 1.75 0 0 1-1.543-2.575Zm1.763.707a.25.25 0 0 0-.44 0L1.698 13.132a.25.25 0 0 0 .22.368h12.164a.25.25 0 0 0 .22-.368Zm.53 3.996v2.5a.75.75 0 0 1-1.5 0v-2.5a.75.75 0 0 1 1.5 0ZM9 11a1 1 0 1 1-2 0 1 1 0 0 1 2 0Z"})}),"WARNING"]}),"\n",(0,t.jsx)(i.p,{children:"Registering services with the same name will throw an exception."}),"\n"]}),"\n",(0,t.jsx)(i.pre,{children:(0,t.jsx)(i.code,{className:"language-php",children:"$provider->registerAuditingService(new AuditingService('default', $em1));\n$provider->registerAuditingService(new AuditingService('default', $em2));\n// Throws: ProviderException - 'An auditing service named \"default\" is already registered.'\n"})}),"\n",(0,t.jsx)(i.h3,{id:"missing-storage-mapper",children:"Missing Storage Mapper"}),"\n",(0,t.jsxs)(i.div,{className:"markdown-alert markdown-alert-caution",dir:"auto",children:["\n",(0,t.jsxs)(i.p,{className:"markdown-alert-title",dir:"auto",children:[(0,t.jsx)(i.svg,{className:"octicon",viewBox:"0 0 16 16",width:"16",height:"16","aria-hidden":"true",children:(0,t.jsx)(i.path,{d:"M4.47.22A.749.749 0 0 1 5 0h6c.199 0 .389.079.53.22l4.25 4.25c.141.14.22.331.22.53v6a.749.749 0 0 1-.22.53l-4.25 4.25A.749.749 0 0 1 11 16H5a.749.749 0 0 1-.53-.22L.22 11.53A.749.749 0 0 1 0 11V5c0-.199.079-.389.22-.53Zm.84 1.28L1.5 5.31v5.38l3.81 3.81h5.38l3.81-3.81V5.31L10.69 1.5ZM8 4a.75.75 0 0 1 .75.75v3.5a.75.75 0 0 1-1.5 0v-3.5A.75.75 0 0 1 8 4Zm0 8a1 1 0 1 1 0-2 1 1 0 0 1 0 2Z"})}),"CAUTION"]}),"\n",(0,t.jsx)(i.p,{children:"If you have multiple storage services but no mapper, an exception will be thrown when storing an audit."}),"\n"]}),"\n",(0,t.jsx)(i.pre,{children:(0,t.jsx)(i.code,{className:"language-php",children:"// If you have multiple storage services but no mapper\n$provider->registerStorageService(new StorageService('storage1', $em1));\n$provider->registerStorageService(new StorageService('storage2', $em2));\n\n// And no storage_mapper configured\n// When storing an audit:\n// Throws: ProviderException - 'You must provide a mapper callback to map audits to storage.'\n"})}),"\n",(0,t.jsx)(i.h2,{id:"-best-practices",children:"\u2705 Best Practices"}),"\n",(0,t.jsxs)(i.ol,{children:["\n",(0,t.jsxs)(i.li,{children:[(0,t.jsx)(i.strong,{children:"Use descriptive service names"})," - Makes debugging easier"]}),"\n",(0,t.jsxs)(i.li,{children:[(0,t.jsx)(i.strong,{children:"Keep it simple when possible"})," - Single database is often sufficient"]}),"\n",(0,t.jsxs)(i.li,{children:[(0,t.jsx)(i.strong,{children:"Consider read replicas"})," - Use replicas for reading audits to reduce load"]}),"\n",(0,t.jsxs)(i.li,{children:[(0,t.jsx)(i.strong,{children:"Test your multi-database setup"})," - Ensure transactions work correctly"]}),"\n",(0,t.jsxs)(i.li,{children:[(0,t.jsx)(i.strong,{children:"Document your architecture"})," - Especially with multiple services"]}),"\n"]}),"\n",(0,t.jsx)(i.hr,{}),"\n",(0,t.jsx)(i.h2,{id:"next-steps",children:"Next Steps"}),"\n",(0,t.jsxs)(i.ul,{children:["\n",(0,t.jsxs)(i.li,{children:["\ud83d\uddc4\ufe0f ",(0,t.jsx)(i.a,{href:"/auditor-docs/auditor/providers/doctrine/multi-database",children:"Multi-Database Configuration"})]}),"\n",(0,t.jsxs)(i.li,{children:["\ud83d\udee0\ufe0f ",(0,t.jsx)(i.a,{href:"/auditor-docs/auditor/providers/doctrine/schema",children:"Schema Management"})]}),"\n",(0,t.jsxs)(i.li,{children:["\ud83d\udd0d ",(0,t.jsx)(i.a,{href:"/auditor-docs/auditor/querying/",children:"Querying Audits"})]}),"\n"]})]})}function g(e={}){const{wrapper:i}={...(0,a.R)(),...e.components};return i?(0,t.jsx)(i,{...e,children:(0,t.jsx)(l,{...e})}):l(e)}},28453(e,i,r){r.d(i,{R:()=>s,x:()=>d});var n=r(96540);const t={},a=n.createContext(t);function s(e){const i=n.useContext(a);return n.useMemo(function(){return"function"==typeof e?e(i):{...i,...e}},[i,e])}function d(e){let i;return i=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:s(e.components),n.createElement(a.Provider,{value:i},e.children)}}}]);