"use strict";(self.webpackChunkauditor_docs=self.webpackChunkauditor_docs||[]).push([[9142],{63193(e,n,i){i.r(n),i.d(n,{assets:()=>c,contentTitle:()=>o,default:()=>u,frontMatter:()=>s,metadata:()=>r,toc:()=>d});const r=JSON.parse('{"id":"providers/doctrine/multi-database","title":"Multi-Database Configuration","description":"Store audit logs in a separate database from your application data","source":"@site/docs/auditor/providers/doctrine/multi-database.md","sourceDirName":"providers/doctrine","slug":"/providers/doctrine/multi-database","permalink":"/auditor-docs/auditor/providers/doctrine/multi-database","draft":false,"unlisted":false,"tags":[],"version":"current","frontMatter":{},"sidebar":"auditorSidebar","previous":{"title":"Auditing and Storage Services","permalink":"/auditor-docs/auditor/providers/doctrine/services"},"next":{"title":"Querying Audits","permalink":"/auditor-docs/auditor/querying/"}}');var a=i(74848),t=i(28453);const s={},o="Multi-Database Configuration",c={},d=[{value:"\ud83c\udfaf Use Cases",id:"-use-cases",level:2},{value:"\ud83c\udfd7\ufe0f Architecture Overview",id:"\ufe0f-architecture-overview",level:2},{value:"\ud83d\ude80 Basic Setup",id:"-basic-setup",level:2},{value:"1. Configure Database Connections",id:"1-configure-database-connections",level:3},{value:"2. Configure the Provider",id:"2-configure-the-provider",level:3},{value:"\ud83d\udd00 Multiple Source Databases",id:"-multiple-source-databases",level:2},{value:"\ud83d\uddc4\ufe0f Multiple Storage Databases with Routing",id:"\ufe0f-multiple-storage-databases-with-routing",level:2},{value:"\ud83d\udccd Storage Mapper Examples",id:"-storage-mapper-examples",level:2},{value:"Route by Entity Class",id:"route-by-entity-class",level:3},{value:"Route by Namespace",id:"route-by-namespace",level:3},{value:"Route by Custom Logic",id:"route-by-custom-logic",level:3},{value:"\ud83d\udee0\ufe0f Schema Management",id:"\ufe0f-schema-management",level:2},{value:"\ud83d\udcd6 Reading Audits",id:"-reading-audits",level:2},{value:"\u26a0\ufe0f Transaction Considerations",id:"\ufe0f-transaction-considerations",level:2},{value:"Same Transaction (Not Possible)",id:"same-transaction-not-possible",level:3},{value:"\ud83d\udee1\ufe0f Handling Failures",id:"\ufe0f-handling-failures",level:3},{value:"\ud83d\udcdd Configuration Summary",id:"-configuration-summary",level:2},{value:"\u2705 Best Practices",id:"-best-practices",level:2},{value:"Related",id:"related",level:2}];function l(e){const n={a:"a",blockquote:"blockquote",code:"code",div:"div",h1:"h1",h2:"h2",h3:"h3",header:"header",hr:"hr",li:"li",mermaid:"mermaid",ol:"ol",p:"p",path:"path",pre:"pre",strong:"strong",svg:"svg",ul:"ul",...(0,t.R)(),...e.components};return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(n.header,{children:(0,a.jsx)(n.h1,{id:"multi-database-configuration",children:"Multi-Database Configuration"})}),"\n",(0,a.jsxs)(n.blockquote,{children:["\n",(0,a.jsx)(n.p,{children:(0,a.jsx)(n.strong,{children:"Store audit logs in a separate database from your application data"})}),"\n"]}),"\n",(0,a.jsx)(n.p,{children:"This guide explains how to store audit logs in a separate database from your application data."}),"\n",(0,a.jsx)(n.h2,{id:"-use-cases",children:"\ud83c\udfaf Use Cases"}),"\n",(0,a.jsx)(n.p,{children:"Storing audits in a separate database can be beneficial for:"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.strong,{children:"Performance"})," - Audit writes don't compete with application queries"]}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.strong,{children:"Compliance"})," - Separate storage for regulatory requirements"]}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.strong,{children:"Security"})," - Different access controls for audit data"]}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.strong,{children:"Scalability"})," - Independent scaling of audit storage"]}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.strong,{children:"Retention"})," - Different backup/retention policies"]}),"\n"]}),"\n",(0,a.jsx)(n.h2,{id:"\ufe0f-architecture-overview",children:"\ud83c\udfd7\ufe0f Architecture Overview"}),"\n",(0,a.jsx)(n.mermaid,{value:'flowchart TB\n    APP["Application"]\n    \n    subgraph DoctrineProvider\n        AS["Auditing Service<br>EntityManager (App Database)"]\n        SS["Storage Service<br>EntityManager (Audit DB)"]\n    end\n    \n    APP --\x3e DoctrineProvider\n    AS --\x3e DB1[("App Database<br>users, posts")]\n    SS --\x3e DB2[("Audit Database<br>users_audit, posts_audit")]'}),"\n",(0,a.jsx)(n.h2,{id:"-basic-setup",children:"\ud83d\ude80 Basic Setup"}),"\n",(0,a.jsx)(n.h3,{id:"1-configure-database-connections",children:"1. Configure Database Connections"}),"\n",(0,a.jsx)(n.p,{children:"In your Symfony configuration:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-yaml",children:"# config/packages/doctrine.yaml\ndoctrine:\n    dbal:\n        default_connection: default\n        connections:\n            default:\n                url: '%env(DATABASE_URL)%'\n            audit:\n                url: '%env(AUDIT_DATABASE_URL)%'\n\n    orm:\n        default_entity_manager: default\n        entity_managers:\n            default:\n                connection: default\n                mappings:\n                    App:\n                        is_bundle: false\n                        dir: '%kernel.project_dir%/src/Entity'\n                        prefix: 'App\\Entity'\n                        alias: App\n            \n            audit:\n                connection: audit\n                # No entity mappings - only stores audit tables\n"})}),"\n",(0,a.jsx)(n.h3,{id:"2-configure-the-provider",children:"2. Configure the Provider"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-php",children:"<?php\n\nuse DH\\Auditor\\Provider\\Doctrine\\Configuration;\nuse DH\\Auditor\\Provider\\Doctrine\\DoctrineProvider;\nuse DH\\Auditor\\Provider\\Doctrine\\Service\\AuditingService;\nuse DH\\Auditor\\Provider\\Doctrine\\Service\\StorageService;\n\n// Create provider configuration\n$configuration = new Configuration([\n    'table_suffix' => '_audit',\n]);\n\n$provider = new DoctrineProvider($configuration);\n\n// Auditing service watches the application EntityManager\n$provider->registerAuditingService(\n    new AuditingService('default', $appEntityManager)\n);\n\n// Storage service uses the dedicated audit EntityManager\n$provider->registerStorageService(\n    new StorageService('audit', $auditEntityManager)\n);\n"})}),"\n",(0,a.jsx)(n.h2,{id:"-multiple-source-databases",children:"\ud83d\udd00 Multiple Source Databases"}),"\n",(0,a.jsx)(n.p,{children:"If you have multiple application databases:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-php",children:"<?php\n\n$provider = new DoctrineProvider(new Configuration([\n    'table_suffix' => '_audit',\n]));\n\n// Watch multiple application databases\n$provider->registerAuditingService(\n    new AuditingService('app', $appEntityManager)\n);\n$provider->registerAuditingService(\n    new AuditingService('crm', $crmEntityManager)\n);\n$provider->registerAuditingService(\n    new AuditingService('legacy', $legacyEntityManager)\n);\n\n// Single audit storage\n$provider->registerStorageService(\n    new StorageService('audit', $auditEntityManager)\n);\n"})}),"\n",(0,a.jsx)(n.h2,{id:"\ufe0f-multiple-storage-databases-with-routing",children:"\ud83d\uddc4\ufe0f Multiple Storage Databases with Routing"}),"\n",(0,a.jsx)(n.p,{children:"For complex scenarios, use a storage mapper to route audits:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-php",children:"<?php\n\nuse DH\\Auditor\\Provider\\Doctrine\\Service\\StorageService;\n\n$configuration = new Configuration([\n    'table_suffix' => '_audit',\n    \n    'storage_mapper' => function (string $entity, array $storageServices): StorageService {\n        // Route based on entity type\n        if (str_starts_with($entity, 'App\\\\Entity\\\\Financial\\\\')) {\n            return $storageServices['financial_audit'];\n        }\n        \n        if (str_starts_with($entity, 'App\\\\Entity\\\\User\\\\')) {\n            return $storageServices['user_audit'];\n        }\n        \n        // Default storage\n        return $storageServices['default_audit'];\n    },\n]);\n\n$provider = new DoctrineProvider($configuration);\n\n// Register auditing services\n$provider->registerAuditingService(new AuditingService('app', $appEntityManager));\n\n// Register multiple storage services\n$provider->registerStorageService(new StorageService('default_audit', $defaultAuditEM));\n$provider->registerStorageService(new StorageService('financial_audit', $financialAuditEM));\n$provider->registerStorageService(new StorageService('user_audit', $userAuditEM));\n"})}),"\n",(0,a.jsx)(n.h2,{id:"-storage-mapper-examples",children:"\ud83d\udccd Storage Mapper Examples"}),"\n",(0,a.jsx)(n.h3,{id:"route-by-entity-class",children:"Route by Entity Class"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-php",children:"'storage_mapper' => function (string $entity, array $storageServices): StorageService {\n    return match ($entity) {\n        User::class, Profile::class => $storageServices['sensitive'],\n        Payment::class, Invoice::class => $storageServices['financial'],\n        default => $storageServices['default'],\n    };\n}\n"})}),"\n",(0,a.jsx)(n.h3,{id:"route-by-namespace",children:"Route by Namespace"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-php",children:"'storage_mapper' => function (string $entity, array $storageServices): StorageService {\n    $namespace = substr($entity, 0, strrpos($entity, '\\\\'));\n    \n    return match ($namespace) {\n        'App\\\\Entity\\\\Admin' => $storageServices['admin_audit'],\n        'App\\\\Entity\\\\Api' => $storageServices['api_audit'],\n        default => $storageServices['default'],\n    };\n}\n"})}),"\n",(0,a.jsx)(n.h3,{id:"route-by-custom-logic",children:"Route by Custom Logic"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-php",children:"'storage_mapper' => function (string $entity, array $storageServices) use ($sensitiveEntities): StorageService {\n    // Check if entity is in the sensitive list\n    if (in_array($entity, $sensitiveEntities, true)) {\n        return $storageServices['secure'];\n    }\n    \n    // Check for specific interface\n    if (is_subclass_of($entity, FinancialEntityInterface::class)) {\n        return $storageServices['financial'];\n    }\n    \n    return $storageServices['default'];\n}\n"})}),"\n",(0,a.jsx)(n.h2,{id:"\ufe0f-schema-management",children:"\ud83d\udee0\ufe0f Schema Management"}),"\n",(0,a.jsx)(n.p,{children:"When using multiple storage databases, the schema manager handles each one:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"# Preview SQL for all storage databases\nphp bin/console audit:schema:update --dump-sql\n\n# Update all storage databases\nphp bin/console audit:schema:update --force\n"})}),"\n",(0,a.jsx)(n.p,{children:"Or programmatically:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-php",children:"$schemaManager = new SchemaManager($provider);\n\n// Get SQL grouped by storage service\n$sqls = $schemaManager->getUpdateAuditSchemaSql();\n// Returns: ['storage_name' => ['SQL1', 'SQL2', ...], ...]\n\n// Update all\n$schemaManager->updateAuditSchema();\n"})}),"\n",(0,a.jsx)(n.h2,{id:"-reading-audits",children:"\ud83d\udcd6 Reading Audits"}),"\n",(0,a.jsx)(n.p,{children:"When reading audits, the Reader automatically uses the correct storage:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-php",children:"$reader = new Reader($provider);\n\n// This automatically queries the correct audit database\n$query = $reader->createQuery(User::class);\n$audits = $query->execute();\n"})}),"\n",(0,a.jsx)(n.h2,{id:"\ufe0f-transaction-considerations",children:"\u26a0\ufe0f Transaction Considerations"}),"\n",(0,a.jsx)(n.h3,{id:"same-transaction-not-possible",children:"Same Transaction (Not Possible)"}),"\n",(0,a.jsxs)(n.div,{className:"markdown-alert markdown-alert-important",dir:"auto",children:["\n",(0,a.jsxs)(n.p,{className:"markdown-alert-title",dir:"auto",children:[(0,a.jsx)(n.svg,{className:"octicon",viewBox:"0 0 16 16",width:"16",height:"16","aria-hidden":"true",children:(0,a.jsx)(n.path,{d:"M0 1.75C0 .784.784 0 1.75 0h12.5C15.216 0 16 .784 16 1.75v9.5A1.75 1.75 0 0 1 14.25 13H8.06l-2.573 2.573A1.458 1.458 0 0 1 3 14.543V13H1.75A1.75 1.75 0 0 1 0 11.25Zm1.75-.25a.25.25 0 0 0-.25.25v9.5c0 .138.112.25.25.25h2a.75.75 0 0 1 .75.75v2.19l2.72-2.72a.749.749 0 0 1 .53-.22h6.5a.25.25 0 0 0 .25-.25v-9.5a.25.25 0 0 0-.25-.25Zm7 2.25v2.5a.75.75 0 0 1-1.5 0v-2.5a.75.75 0 0 1 1.5 0ZM9 9a1 1 0 1 1-2 0 1 1 0 0 1 2 0Z"})}),"IMPORTANT"]}),"\n",(0,a.jsxs)(n.p,{children:["When using separate databases, audit entries ",(0,a.jsx)(n.strong,{children:"cannot"})," be in the same transaction as entity changes."]}),"\n"]}),"\n",(0,a.jsx)(n.p,{children:"This means:"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsx)(n.li,{children:"\u2705 Audit entries are written after successful entity changes"}),"\n",(0,a.jsx)(n.li,{children:"\u26a0\ufe0f If audit write fails, entity changes are still committed"}),"\n",(0,a.jsx)(n.li,{children:"\u26a0\ufe0f No automatic rollback of entity changes on audit failure"}),"\n"]}),"\n",(0,a.jsx)(n.h3,{id:"\ufe0f-handling-failures",children:"\ud83d\udee1\ufe0f Handling Failures"}),"\n",(0,a.jsx)(n.p,{children:"Consider implementing:"}),"\n",(0,a.jsxs)(n.ol,{children:["\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.strong,{children:"Retry mechanism"})," for failed audit writes"]}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.strong,{children:"Fallback storage"})," (e.g., file-based logging)"]}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.strong,{children:"Monitoring"})," for audit write failures"]}),"\n"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-php",children:"// Example: Custom event listener for audit failures\n$dispatcher->addListener(LifecycleEvent::class, function (LifecycleEvent $event) use ($logger) {\n    try {\n        // Audit write happens here...\n    } catch (\\Exception $e) {\n        $logger->critical('Audit write failed', [\n            'entity' => $event->getPayload()['entity'],\n            'error' => $e->getMessage(),\n        ]);\n        \n        // Write to fallback storage\n        $this->fallbackStorage->store($event->getPayload());\n    }\n});\n"})}),"\n",(0,a.jsx)(n.h2,{id:"-configuration-summary",children:"\ud83d\udcdd Configuration Summary"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-php",children:"<?php\n\nuse DH\\Auditor\\Auditor;\nuse DH\\Auditor\\Configuration as AuditorConfiguration;\nuse DH\\Auditor\\Provider\\Doctrine\\Configuration as DoctrineConfiguration;\nuse DH\\Auditor\\Provider\\Doctrine\\DoctrineProvider;\nuse DH\\Auditor\\Provider\\Doctrine\\Service\\AuditingService;\nuse DH\\Auditor\\Provider\\Doctrine\\Service\\StorageService;\n\n// Main auditor config\n$auditorConfig = new AuditorConfiguration([\n    'enabled' => true,\n    'timezone' => 'UTC',\n]);\n\n$auditor = new Auditor($auditorConfig, $eventDispatcher);\n\n// Provider config with storage mapper\n$providerConfig = new DoctrineConfiguration([\n    'table_suffix' => '_audit',\n    'storage_mapper' => function (string $entity, array $services): StorageService {\n        // Your routing logic here\n        return $services['default'];\n    },\n]);\n\n$provider = new DoctrineProvider($providerConfig);\n\n// Register services\n$provider->registerAuditingService(new AuditingService('app', $appEM));\n$provider->registerStorageService(new StorageService('default', $auditEM));\n$provider->registerStorageService(new StorageService('sensitive', $sensitiveAuditEM));\n\n// Register provider\n$auditor->registerProvider($provider);\n"})}),"\n",(0,a.jsx)(n.h2,{id:"-best-practices",children:"\u2705 Best Practices"}),"\n",(0,a.jsxs)(n.ol,{children:["\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.strong,{children:"Use connection pooling"})," - Multiple databases mean more connections"]}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.strong,{children:"Monitor both databases"})," - Ensure audit DB has adequate resources"]}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.strong,{children:"Separate backups"})," - Audit data may have different retention needs"]}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.strong,{children:"Test failover scenarios"})," - What happens when audit DB is unavailable?"]}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.strong,{children:"Document your setup"})," - Complex routing logic should be well-documented"]}),"\n"]}),"\n",(0,a.jsxs)(n.div,{className:"markdown-alert markdown-alert-tip",dir:"auto",children:["\n",(0,a.jsxs)(n.p,{className:"markdown-alert-title",dir:"auto",children:[(0,a.jsx)(n.svg,{className:"octicon",viewBox:"0 0 16 16",width:"16",height:"16","aria-hidden":"true",children:(0,a.jsx)(n.path,{d:"M8 1.5c-2.363 0-4 1.69-4 3.75 0 .984.424 1.625.984 2.304l.214.253c.223.264.47.556.673.848.284.411.537.896.621 1.49a.75.75 0 0 1-1.484.211c-.04-.282-.163-.547-.37-.847a8.456 8.456 0 0 0-.542-.68c-.084-.1-.173-.205-.268-.32C3.201 7.75 2.5 6.766 2.5 5.25 2.5 2.31 4.863 0 8 0s5.5 2.31 5.5 5.25c0 1.516-.701 2.5-1.328 3.259-.095.115-.184.22-.268.319-.207.245-.383.453-.541.681-.208.3-.33.565-.37.847a.751.751 0 0 1-1.485-.212c.084-.593.337-1.078.621-1.489.203-.292.45-.584.673-.848.075-.088.147-.173.213-.253.561-.679.985-1.32.985-2.304 0-2.06-1.637-3.75-4-3.75ZM5.75 12h4.5a.75.75 0 0 1 0 1.5h-4.5a.75.75 0 0 1 0-1.5ZM6 15.25a.75.75 0 0 1 .75-.75h2.5a.75.75 0 0 1 0 1.5h-2.5a.75.75 0 0 1-.75-.75Z"})}),"TIP"]}),"\n",(0,a.jsx)(n.p,{children:"Consider using a message queue (like Symfony Messenger) for audit persistence to improve application response times and handle failures gracefully."}),"\n"]}),"\n",(0,a.jsx)(n.hr,{}),"\n",(0,a.jsx)(n.h2,{id:"related",children:"Related"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsxs)(n.li,{children:["\u2699\ufe0f ",(0,a.jsx)(n.a,{href:"/auditor-docs/auditor/providers/doctrine/services",children:"Services Reference"})]}),"\n",(0,a.jsxs)(n.li,{children:["\ud83d\udee0\ufe0f ",(0,a.jsx)(n.a,{href:"/auditor-docs/auditor/providers/doctrine/schema",children:"Schema Management"})]}),"\n",(0,a.jsxs)(n.li,{children:["\ud83d\udccb ",(0,a.jsx)(n.a,{href:"/auditor-docs/auditor/providers/doctrine/configuration",children:"Configuration Reference"})]}),"\n"]})]})}function u(e={}){const{wrapper:n}={...(0,t.R)(),...e.components};return n?(0,a.jsx)(n,{...e,children:(0,a.jsx)(l,{...e})}):l(e)}},28453(e,n,i){i.d(n,{R:()=>s,x:()=>o});var r=i(96540);const a={},t=r.createContext(a);function s(e){const n=r.useContext(t);return r.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(a):e.components||a:s(e.components),r.createElement(t.Provider,{value:n},e.children)}}}]);