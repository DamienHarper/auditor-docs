"use strict";(self.webpackChunkauditor_docs=self.webpackChunkauditor_docs||[]).push([[8360],{57083(e,i,r){r.r(i),r.d(i,{assets:()=>o,contentTitle:()=>c,default:()=>h,frontMatter:()=>d,metadata:()=>n,toc:()=>a});const n=JSON.parse('{"id":"providers/doctrine/index","title":"DoctrineProvider","description":"The default provider for auditing Doctrine ORM entities","source":"@site/docs/auditor/providers/doctrine/index.md","sourceDirName":"providers/doctrine","slug":"/providers/doctrine/","permalink":"/auditor-docs/auditor/providers/doctrine/","draft":false,"unlisted":false,"tags":[],"version":"current","frontMatter":{},"sidebar":"auditorSidebar","previous":{"title":"Role Checker Configuration","permalink":"/auditor-docs/auditor/configuration/role-checker"},"next":{"title":"DoctrineProvider Configuration","permalink":"/auditor-docs/auditor/providers/doctrine/configuration"}}');var t=r(74848),s=r(28453);const d={},c="DoctrineProvider",o={},a=[{value:"\ud83d\udd0d Overview",id:"-overview",level:2},{value:"\u2728 Key Features",id:"-key-features",level:2},{value:"Automatic Change Detection",id:"automatic-change-detection",level:3},{value:"Audit Table Structure",id:"audit-table-structure",level:3},{value:"Action Types",id:"action-types",level:3},{value:"\ud83c\udfd7\ufe0f Architecture",id:"\ufe0f-architecture",level:2},{value:"\ud83d\uddc4\ufe0f Supported Databases",id:"\ufe0f-supported-databases",level:2},{value:"\u26a0\ufe0f Limitations",id:"\ufe0f-limitations",level:2},{value:"\ud83d\udcda Sections",id:"-sections",level:2},{value:"\ud83d\ude80 Basic Usage",id:"-basic-usage",level:2},{value:"Next Steps",id:"next-steps",level:2}];function l(e){const i={a:"a",blockquote:"blockquote",code:"code",div:"div",h1:"h1",h2:"h2",h3:"h3",header:"header",hr:"hr",li:"li",mermaid:"mermaid",ol:"ol",p:"p",path:"path",pre:"pre",strong:"strong",svg:"svg",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,s.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(i.header,{children:(0,t.jsx)(i.h1,{id:"doctrineprovider",children:"DoctrineProvider"})}),"\n",(0,t.jsxs)(i.blockquote,{children:["\n",(0,t.jsx)(i.p,{children:(0,t.jsx)(i.strong,{children:"The default provider for auditing Doctrine ORM entities"})}),"\n"]}),"\n",(0,t.jsxs)(i.p,{children:["The ",(0,t.jsx)(i.code,{children:"DoctrineProvider"})," is the default and primary provider shipped with auditor. It provides both ",(0,t.jsx)(i.strong,{children:"auditing"})," and ",(0,t.jsx)(i.strong,{children:"storage"})," capabilities for Doctrine ORM entities."]}),"\n",(0,t.jsx)(i.h2,{id:"-overview",children:"\ud83d\udd0d Overview"}),"\n",(0,t.jsx)(i.p,{children:"The DoctrineProvider:"}),"\n",(0,t.jsxs)(i.ul,{children:["\n",(0,t.jsxs)(i.li,{children:["\ud83d\udcdd ",(0,t.jsx)(i.strong,{children:"Tracks entity changes"})," - Inserts, updates, and deletes"]}),"\n",(0,t.jsxs)(i.li,{children:["\ud83d\udd17 ",(0,t.jsx)(i.strong,{children:"Tracks relationships"})," - Many-to-many associations and dissociations"]}),"\n",(0,t.jsxs)(i.li,{children:["\ud83d\udcbe ",(0,t.jsx)(i.strong,{children:"Persists audit logs"})," - Stores audits in dedicated audit tables"]}),"\n",(0,t.jsxs)(i.li,{children:["\ud83d\udd04 ",(0,t.jsx)(i.strong,{children:"Transactional integrity"})," - Audit entries are part of the same transaction as your changes"]}),"\n"]}),"\n",(0,t.jsx)(i.h2,{id:"-key-features",children:"\u2728 Key Features"}),"\n",(0,t.jsx)(i.h3,{id:"automatic-change-detection",children:"Automatic Change Detection"}),"\n",(0,t.jsx)(i.p,{children:"The provider hooks into Doctrine's event system to automatically detect:"}),"\n",(0,t.jsxs)(i.ul,{children:["\n",(0,t.jsxs)(i.li,{children:[(0,t.jsx)(i.strong,{children:"Insertions"})," - New entities being persisted"]}),"\n",(0,t.jsxs)(i.li,{children:[(0,t.jsx)(i.strong,{children:"Updates"})," - Changes to existing entities with full diff"]}),"\n",(0,t.jsxs)(i.li,{children:[(0,t.jsx)(i.strong,{children:"Deletions"})," - Entities being removed"]}),"\n",(0,t.jsxs)(i.li,{children:[(0,t.jsx)(i.strong,{children:"Associations"})," - Relationships being created"]}),"\n",(0,t.jsxs)(i.li,{children:[(0,t.jsx)(i.strong,{children:"Dissociations"})," - Relationships being removed"]}),"\n"]}),"\n",(0,t.jsx)(i.h3,{id:"audit-table-structure",children:"Audit Table Structure"}),"\n",(0,t.jsx)(i.p,{children:"For each audited entity, a corresponding audit table is created:"}),"\n",(0,t.jsxs)(i.table,{children:[(0,t.jsx)(i.thead,{children:(0,t.jsxs)(i.tr,{children:[(0,t.jsx)(i.th,{children:"Column"}),(0,t.jsx)(i.th,{children:"Type"}),(0,t.jsx)(i.th,{children:"Description"})]})}),(0,t.jsxs)(i.tbody,{children:[(0,t.jsxs)(i.tr,{children:[(0,t.jsx)(i.td,{children:(0,t.jsx)(i.code,{children:"id"})}),(0,t.jsx)(i.td,{children:(0,t.jsx)(i.code,{children:"integer"})}),(0,t.jsx)(i.td,{children:"Auto-increment primary key"})]}),(0,t.jsxs)(i.tr,{children:[(0,t.jsx)(i.td,{children:(0,t.jsx)(i.code,{children:"type"})}),(0,t.jsx)(i.td,{children:(0,t.jsx)(i.code,{children:"string(10)"})}),(0,t.jsx)(i.td,{children:"Action type (insert/update/remove/etc)"})]}),(0,t.jsxs)(i.tr,{children:[(0,t.jsx)(i.td,{children:(0,t.jsx)(i.code,{children:"object_id"})}),(0,t.jsx)(i.td,{children:(0,t.jsx)(i.code,{children:"string(255)"})}),(0,t.jsx)(i.td,{children:"ID of the audited entity"})]}),(0,t.jsxs)(i.tr,{children:[(0,t.jsx)(i.td,{children:(0,t.jsx)(i.code,{children:"discriminator"})}),(0,t.jsx)(i.td,{children:(0,t.jsx)(i.code,{children:"string(255)"})}),(0,t.jsx)(i.td,{children:"Entity class (for inheritance)"})]}),(0,t.jsxs)(i.tr,{children:[(0,t.jsx)(i.td,{children:(0,t.jsx)(i.code,{children:"transaction_hash"})}),(0,t.jsx)(i.td,{children:(0,t.jsx)(i.code,{children:"string(40)"})}),(0,t.jsx)(i.td,{children:"Hash grouping related changes"})]}),(0,t.jsxs)(i.tr,{children:[(0,t.jsx)(i.td,{children:(0,t.jsx)(i.code,{children:"diffs"})}),(0,t.jsx)(i.td,{children:(0,t.jsx)(i.code,{children:"json/text"})}),(0,t.jsx)(i.td,{children:"The actual changes (JSON)"})]}),(0,t.jsxs)(i.tr,{children:[(0,t.jsx)(i.td,{children:(0,t.jsx)(i.code,{children:"blame_id"})}),(0,t.jsx)(i.td,{children:(0,t.jsx)(i.code,{children:"string(255)"})}),(0,t.jsx)(i.td,{children:"User identifier"})]}),(0,t.jsxs)(i.tr,{children:[(0,t.jsx)(i.td,{children:(0,t.jsx)(i.code,{children:"blame_user"})}),(0,t.jsx)(i.td,{children:(0,t.jsx)(i.code,{children:"string(255)"})}),(0,t.jsx)(i.td,{children:"Username"})]}),(0,t.jsxs)(i.tr,{children:[(0,t.jsx)(i.td,{children:(0,t.jsx)(i.code,{children:"blame_user_fqdn"})}),(0,t.jsx)(i.td,{children:(0,t.jsx)(i.code,{children:"string(255)"})}),(0,t.jsx)(i.td,{children:"User class name"})]}),(0,t.jsxs)(i.tr,{children:[(0,t.jsx)(i.td,{children:(0,t.jsx)(i.code,{children:"blame_user_firewall"})}),(0,t.jsx)(i.td,{children:(0,t.jsx)(i.code,{children:"string(100)"})}),(0,t.jsx)(i.td,{children:"Firewall name"})]}),(0,t.jsxs)(i.tr,{children:[(0,t.jsx)(i.td,{children:(0,t.jsx)(i.code,{children:"ip"})}),(0,t.jsx)(i.td,{children:(0,t.jsx)(i.code,{children:"string(45)"})}),(0,t.jsx)(i.td,{children:"Client IP address"})]}),(0,t.jsxs)(i.tr,{children:[(0,t.jsx)(i.td,{children:(0,t.jsx)(i.code,{children:"created_at"})}),(0,t.jsx)(i.td,{children:(0,t.jsx)(i.code,{children:"datetime"})}),(0,t.jsx)(i.td,{children:"When the audit was created"})]})]})]}),"\n",(0,t.jsx)(i.h3,{id:"action-types",children:"Action Types"}),"\n",(0,t.jsxs)(i.table,{children:[(0,t.jsx)(i.thead,{children:(0,t.jsxs)(i.tr,{children:[(0,t.jsx)(i.th,{children:"Type"}),(0,t.jsx)(i.th,{children:"Description"})]})}),(0,t.jsxs)(i.tbody,{children:[(0,t.jsxs)(i.tr,{children:[(0,t.jsx)(i.td,{children:(0,t.jsx)(i.code,{children:"insert"})}),(0,t.jsx)(i.td,{children:"A new entity was created"})]}),(0,t.jsxs)(i.tr,{children:[(0,t.jsx)(i.td,{children:(0,t.jsx)(i.code,{children:"update"})}),(0,t.jsx)(i.td,{children:"An existing entity was modified"})]}),(0,t.jsxs)(i.tr,{children:[(0,t.jsx)(i.td,{children:(0,t.jsx)(i.code,{children:"remove"})}),(0,t.jsx)(i.td,{children:"An entity was deleted"})]}),(0,t.jsxs)(i.tr,{children:[(0,t.jsx)(i.td,{children:(0,t.jsx)(i.code,{children:"associate"})}),(0,t.jsx)(i.td,{children:"A many-to-many relationship was created"})]}),(0,t.jsxs)(i.tr,{children:[(0,t.jsx)(i.td,{children:(0,t.jsx)(i.code,{children:"dissociate"})}),(0,t.jsx)(i.td,{children:"A many-to-many relationship was removed"})]})]})]}),"\n",(0,t.jsx)(i.h2,{id:"\ufe0f-architecture",children:"\ud83c\udfd7\ufe0f Architecture"}),"\n",(0,t.jsx)(i.mermaid,{value:'flowchart TB\n    subgraph DoctrineProvider\n        direction TB\n        \n        subgraph Configuration\n            table_prefix\n            table_suffix\n            ignored_columns\n            entities\n            storage_mapper\n        end\n        \n        subgraph Services\n            AS["AuditingService(s)<br>\u2192 EntityManager(s) for detection"]\n            SS["StorageService(s)<br>\u2192 EntityManager(s) for storage"]\n        end\n        \n        subgraph Components\n            TM["TransactionManager"]\n            TP["TransactionProcessor"]\n            SM["SchemaManager"]\n            RD["Reader"]\n            AL["AttributeLoader"]\n        end\n    end'}),"\n",(0,t.jsx)(i.h2,{id:"\ufe0f-supported-databases",children:"\ud83d\uddc4\ufe0f Supported Databases"}),"\n",(0,t.jsxs)(i.table,{children:[(0,t.jsx)(i.thead,{children:(0,t.jsxs)(i.tr,{children:[(0,t.jsx)(i.th,{children:"Database"}),(0,t.jsx)(i.th,{children:"Support"}),(0,t.jsx)(i.th,{children:"Notes"})]})}),(0,t.jsxs)(i.tbody,{children:[(0,t.jsxs)(i.tr,{children:[(0,t.jsx)(i.td,{children:"MySQL"}),(0,t.jsx)(i.td,{children:"\u2705"}),(0,t.jsx)(i.td,{children:"Full support with JSON column type"})]}),(0,t.jsxs)(i.tr,{children:[(0,t.jsx)(i.td,{children:"MariaDB"}),(0,t.jsx)(i.td,{children:"\u2705"}),(0,t.jsx)(i.td,{children:"Full support with JSON column type"})]}),(0,t.jsxs)(i.tr,{children:[(0,t.jsx)(i.td,{children:"PostgreSQL"}),(0,t.jsx)(i.td,{children:"\u2705"}),(0,t.jsx)(i.td,{children:"Full support with JSON column type"})]}),(0,t.jsxs)(i.tr,{children:[(0,t.jsx)(i.td,{children:"SQLite"}),(0,t.jsx)(i.td,{children:"\u2705"}),(0,t.jsx)(i.td,{children:"JSON stored as TEXT"})]})]})]}),"\n",(0,t.jsx)(i.h2,{id:"\ufe0f-limitations",children:"\u26a0\ufe0f Limitations"}),"\n",(0,t.jsxs)(i.div,{className:"markdown-alert markdown-alert-caution",dir:"auto",children:["\n",(0,t.jsxs)(i.p,{className:"markdown-alert-title",dir:"auto",children:[(0,t.jsx)(i.svg,{className:"octicon",viewBox:"0 0 16 16",width:"16",height:"16","aria-hidden":"true",children:(0,t.jsx)(i.path,{d:"M4.47.22A.749.749 0 0 1 5 0h6c.199 0 .389.079.53.22l4.25 4.25c.141.14.22.331.22.53v6a.749.749 0 0 1-.22.53l-4.25 4.25A.749.749 0 0 1 11 16H5a.749.749 0 0 1-.53-.22L.22 11.53A.749.749 0 0 1 0 11V5c0-.199.079-.389.22-.53Zm.84 1.28L1.5 5.31v5.38l3.81 3.81h5.38l3.81-3.81V5.31L10.69 1.5ZM8 4a.75.75 0 0 1 .75.75v3.5a.75.75 0 0 1-1.5 0v-3.5A.75.75 0 0 1 8 4Zm0 8a1 1 0 1 1 0-2 1 1 0 0 1 0 2Z"})}),"CAUTION"]}),"\n",(0,t.jsx)(i.p,{children:"Important limitations to be aware of:"}),"\n"]}),"\n",(0,t.jsxs)(i.ol,{children:["\n",(0,t.jsx)(i.li,{children:(0,t.jsx)(i.strong,{children:"Composite primary keys are not supported"})}),"\n",(0,t.jsxs)(i.li,{children:[(0,t.jsx)(i.strong,{children:"DQL/SQL direct queries are not tracked"})," - Only changes through EntityManager"]}),"\n",(0,t.jsxs)(i.li,{children:[(0,t.jsx)(i.strong,{children:"Bulk operations are not tracked"})," - Use ",(0,t.jsx)(i.code,{children:"EntityManager::flush()"})," after each entity"]}),"\n"]}),"\n",(0,t.jsx)(i.h2,{id:"-sections",children:"\ud83d\udcda Sections"}),"\n",(0,t.jsxs)(i.ul,{children:["\n",(0,t.jsxs)(i.li,{children:[(0,t.jsx)(i.a,{href:"/auditor-docs/auditor/providers/doctrine/configuration",children:"Configuration"})," - Configure the DoctrineProvider"]}),"\n",(0,t.jsxs)(i.li,{children:[(0,t.jsx)(i.a,{href:"/auditor-docs/auditor/providers/doctrine/attributes",children:"Attributes"})," - Mark entities and fields for auditing"]}),"\n",(0,t.jsxs)(i.li,{children:[(0,t.jsx)(i.a,{href:"/auditor-docs/auditor/providers/doctrine/services",children:"Services"})," - Auditing and storage services"]}),"\n",(0,t.jsxs)(i.li,{children:[(0,t.jsx)(i.a,{href:"/auditor-docs/auditor/providers/doctrine/schema",children:"Schema Management"})," - Audit table management"]}),"\n",(0,t.jsxs)(i.li,{children:[(0,t.jsx)(i.a,{href:"/auditor-docs/auditor/providers/doctrine/multi-database",children:"Multi-Database"})," - Store audits in separate databases"]}),"\n"]}),"\n",(0,t.jsx)(i.h2,{id:"-basic-usage",children:"\ud83d\ude80 Basic Usage"}),"\n",(0,t.jsx)(i.pre,{children:(0,t.jsx)(i.code,{className:"language-php",children:"<?php\n\nuse DH\\Auditor\\Provider\\Doctrine\\Configuration;\nuse DH\\Auditor\\Provider\\Doctrine\\DoctrineProvider;\nuse DH\\Auditor\\Provider\\Doctrine\\Service\\AuditingService;\nuse DH\\Auditor\\Provider\\Doctrine\\Service\\StorageService;\n\n// Create configuration\n$configuration = new Configuration([\n    'table_suffix' => '_audit',\n    'entities' => [\n        App\\Entity\\User::class => ['enabled' => true],\n        App\\Entity\\Post::class => ['enabled' => true],\n    ],\n]);\n\n// Create provider\n$provider = new DoctrineProvider($configuration);\n\n// Register services\n$provider->registerAuditingService(new AuditingService('default', $entityManager));\n$provider->registerStorageService(new StorageService('default', $entityManager));\n\n// Register with auditor\n$auditor->registerProvider($provider);\n"})}),"\n",(0,t.jsx)(i.hr,{}),"\n",(0,t.jsx)(i.h2,{id:"next-steps",children:"Next Steps"}),"\n",(0,t.jsxs)(i.ul,{children:["\n",(0,t.jsxs)(i.li,{children:["\u2699\ufe0f ",(0,t.jsx)(i.a,{href:"/auditor-docs/auditor/providers/doctrine/configuration",children:"Configuration Reference"})]}),"\n",(0,t.jsxs)(i.li,{children:["\ud83c\udff7\ufe0f ",(0,t.jsx)(i.a,{href:"/auditor-docs/auditor/providers/doctrine/attributes",children:"Attributes Reference"})]}),"\n",(0,t.jsxs)(i.li,{children:["\ud83d\udd0d ",(0,t.jsx)(i.a,{href:"/auditor-docs/auditor/querying/",children:"Querying Audits"})]}),"\n"]})]})}function h(e={}){const{wrapper:i}={...(0,s.R)(),...e.components};return i?(0,t.jsx)(i,{...e,children:(0,t.jsx)(l,{...e})}):l(e)}},28453(e,i,r){r.d(i,{R:()=>d,x:()=>c});var n=r(96540);const t={},s=n.createContext(t);function d(e){const i=n.useContext(s);return n.useMemo(function(){return"function"==typeof e?e(i):{...i,...e}},[i,e])}function c(e){let i;return i=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:d(e.components),n.createElement(s.Provider,{value:i},e.children)}}}]);