"use strict";(self.webpackChunkauditor_docs=self.webpackChunkauditor_docs||[]).push([[4232],{19933(e,n,r){r.r(n),r.d(n,{assets:()=>c,contentTitle:()=>o,default:()=>l,frontMatter:()=>a,metadata:()=>i,toc:()=>d});const i=JSON.parse('{"id":"configuration/user-provider","title":"User Provider Configuration","description":"Identify who made changes to audited entities","source":"@site/docs/auditor/configuration/user-provider.md","sourceDirName":"configuration","slug":"/configuration/user-provider","permalink":"/auditor-docs/auditor/configuration/user-provider","draft":false,"unlisted":false,"tags":[],"version":"current","frontMatter":{},"sidebar":"auditorSidebar","previous":{"title":"Configuration Reference","permalink":"/auditor-docs/auditor/configuration/"},"next":{"title":"Security Provider Configuration","permalink":"/auditor-docs/auditor/configuration/security-provider"}}');var s=r(74848),t=r(28453);const a={},o="User Provider Configuration",c={},d=[{value:"\ud83d\udd0d Overview",id:"-overview",level:2},{value:"\ud83d\ude80 Setting Up a User Provider",id:"-setting-up-a-user-provider",level:2},{value:"Basic Example",id:"basic-example",level:3},{value:"Symfony Security Integration",id:"symfony-security-integration",level:3},{value:"With User Entity ID",id:"with-user-entity-id",level:3},{value:"\ud83d\udce6 The User Class",id:"-the-user-class",level:2},{value:"\ud83e\udde9 Custom User Implementation",id:"-custom-user-implementation",level:2},{value:"\ud83c\udf10 API/CLI Context",id:"-apicli-context",level:2},{value:"\ud83d\udd0d Accessing User Info from Audit Entries",id:"-accessing-user-info-from-audit-entries",level:2},{value:"\u2705 Best Practices",id:"-best-practices",level:2},{value:"Related",id:"related",level:2}];function u(e){const n={a:"a",blockquote:"blockquote",code:"code",div:"div",h1:"h1",h2:"h2",h3:"h3",header:"header",hr:"hr",li:"li",ol:"ol",p:"p",path:"path",pre:"pre",strong:"strong",svg:"svg",ul:"ul",...(0,t.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.header,{children:(0,s.jsx)(n.h1,{id:"user-provider-configuration",children:"User Provider Configuration"})}),"\n",(0,s.jsxs)(n.blockquote,{children:["\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Identify who made changes to audited entities"})}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:"The user provider is responsible for identifying who made changes to audited entities."}),"\n",(0,s.jsx)(n.h2,{id:"-overview",children:"\ud83d\udd0d Overview"}),"\n",(0,s.jsx)(n.p,{children:"When an audit entry is created, auditor can record:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"blame_id"})," - The unique identifier of the user"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"blame_user"})," - The username or display name"]}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:"This information comes from the user provider callback."}),"\n",(0,s.jsx)(n.h2,{id:"-setting-up-a-user-provider",children:"\ud83d\ude80 Setting Up a User Provider"}),"\n",(0,s.jsx)(n.h3,{id:"basic-example",children:"Basic Example"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-php",children:"<?php\n\nuse DH\\Auditor\\Configuration;\nuse DH\\Auditor\\User\\User;\n\n$configuration = new Configuration([\n    'enabled' => true,\n]);\n\n$configuration->setUserProvider(function (): ?User {\n    // Get the currently authenticated user from your application\n    $currentUser = $this->getAuthenticatedUser();\n    \n    if (null === $currentUser) {\n        return null;  // No user authenticated\n    }\n    \n    return new User(\n        (string) $currentUser->getId(),    // User ID (stored as blame_id)\n        $currentUser->getUsername()         // Username (stored as blame_user)\n    );\n});\n"})}),"\n",(0,s.jsx)(n.h3,{id:"symfony-security-integration",children:"Symfony Security Integration"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-php",children:"<?php\n\nuse DH\\Auditor\\User\\User;\nuse Symfony\\Component\\Security\\Core\\Security;\n\n// In a service or controller\n$configuration->setUserProvider(function () use ($security): ?User {\n    $user = $security->getUser();\n    \n    if (null === $user) {\n        return null;\n    }\n    \n    return new User(\n        $user->getUserIdentifier(),\n        $user->getUserIdentifier()\n    );\n});\n"})}),"\n",(0,s.jsx)(n.h3,{id:"with-user-entity-id",children:"With User Entity ID"}),"\n",(0,s.jsx)(n.p,{children:"If your user has a database ID:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-php",children:"<?php\n\nuse DH\\Auditor\\User\\User;\n\n$configuration->setUserProvider(function () use ($security, $entityManager): ?User {\n    $user = $security->getUser();\n    \n    if (null === $user) {\n        return null;\n    }\n    \n    // Get the user ID from the database entity\n    $userId = $entityManager\n        ->getRepository(User::class)\n        ->findOneBy(['email' => $user->getUserIdentifier()])\n        ?->getId();\n    \n    return new User(\n        (string) ($userId ?? $user->getUserIdentifier()),\n        $user->getUserIdentifier()\n    );\n});\n"})}),"\n",(0,s.jsx)(n.h2,{id:"-the-user-class",children:"\ud83d\udce6 The User Class"}),"\n",(0,s.jsxs)(n.p,{children:["The built-in ",(0,s.jsx)(n.code,{children:"User"})," class is a simple value object:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-php",children:"<?php\n\nnamespace DH\\Auditor\\User;\n\nclass User implements UserInterface\n{\n    public function __construct(\n        private ?string $identifier,\n        private ?string $username\n    ) {}\n\n    public function getIdentifier(): ?string\n    {\n        return $this->identifier;\n    }\n\n    public function getUsername(): ?string\n    {\n        return $this->username;\n    }\n}\n"})}),"\n",(0,s.jsx)(n.h2,{id:"-custom-user-implementation",children:"\ud83e\udde9 Custom User Implementation"}),"\n",(0,s.jsxs)(n.p,{children:["You can create your own user class by implementing ",(0,s.jsx)(n.code,{children:"UserInterface"}),":"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-php",children:"<?php\n\nnamespace App\\Audit;\n\nuse DH\\Auditor\\User\\UserInterface;\n\nclass CustomUser implements UserInterface\n{\n    public function __construct(\n        private string $id,\n        private string $username,\n        private string $email,\n        private array $roles\n    ) {}\n\n    public function getIdentifier(): ?string\n    {\n        return $this->id;\n    }\n\n    public function getUsername(): ?string\n    {\n        return sprintf('%s (%s)', $this->username, $this->email);\n    }\n    \n    // Additional methods for your needs\n    public function getEmail(): string\n    {\n        return $this->email;\n    }\n    \n    public function getRoles(): array\n    {\n        return $this->roles;\n    }\n}\n"})}),"\n",(0,s.jsx)(n.h2,{id:"-apicli-context",children:"\ud83c\udf10 API/CLI Context"}),"\n",(0,s.jsxs)(n.div,{className:"markdown-alert markdown-alert-tip",dir:"auto",children:["\n",(0,s.jsxs)(n.p,{className:"markdown-alert-title",dir:"auto",children:[(0,s.jsx)(n.svg,{className:"octicon",viewBox:"0 0 16 16",width:"16",height:"16","aria-hidden":"true",children:(0,s.jsx)(n.path,{d:"M8 1.5c-2.363 0-4 1.69-4 3.75 0 .984.424 1.625.984 2.304l.214.253c.223.264.47.556.673.848.284.411.537.896.621 1.49a.75.75 0 0 1-1.484.211c-.04-.282-.163-.547-.37-.847a8.456 8.456 0 0 0-.542-.68c-.084-.1-.173-.205-.268-.32C3.201 7.75 2.5 6.766 2.5 5.25 2.5 2.31 4.863 0 8 0s5.5 2.31 5.5 5.25c0 1.516-.701 2.5-1.328 3.259-.095.115-.184.22-.268.319-.207.245-.383.453-.541.681-.208.3-.33.565-.37.847a.751.751 0 0 1-1.485-.212c.084-.593.337-1.078.621-1.489.203-.292.45-.584.673-.848.075-.088.147-.173.213-.253.561-.679.985-1.32.985-2.304 0-2.06-1.637-3.75-4-3.75ZM5.75 12h4.5a.75.75 0 0 1 0 1.5h-4.5a.75.75 0 0 1 0-1.5ZM6 15.25a.75.75 0 0 1 .75-.75h2.5a.75.75 0 0 1 0 1.5h-2.5a.75.75 0 0 1-.75-.75Z"})}),"TIP"]}),"\n",(0,s.jsx)(n.p,{children:"For API requests or CLI commands, consider identifying the context (API token, CLI user) rather than leaving it empty."}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-php",children:"<?php\n\n$configuration->setUserProvider(function (): ?User {\n    // Check for CLI context\n    if (PHP_SAPI === 'cli') {\n        return new User('CLI', 'System (CLI)');\n    }\n    \n    // Check for API token\n    $apiToken = $_SERVER['HTTP_X_API_TOKEN'] ?? null;\n    if ($apiToken) {\n        $apiUser = $this->apiUserRepository->findByToken($apiToken);\n        if ($apiUser) {\n            return new User(\n                (string) $apiUser->getId(),\n                sprintf('API: %s', $apiUser->getName())\n            );\n        }\n    }\n    \n    // Regular web user\n    $user = $this->security->getUser();\n    if ($user) {\n        return new User(\n            $user->getUserIdentifier(),\n            $user->getUserIdentifier()\n        );\n    }\n    \n    return null;\n});\n"})}),"\n",(0,s.jsx)(n.h2,{id:"-accessing-user-info-from-audit-entries",children:"\ud83d\udd0d Accessing User Info from Audit Entries"}),"\n",(0,s.jsx)(n.p,{children:"When reading audit entries, you can access the recorded user information:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-php",children:'<?php\n\n$reader = new Reader($provider);\n$query = $reader->createQuery(Post::class, [\'object_id\' => 123]);\n$audits = $query->execute();\n\nforeach ($audits as $entry) {\n    echo "User ID: " . $entry->getUserId();       // blame_id\n    echo "Username: " . $entry->getUsername();    // blame_user\n    echo "User FQDN: " . $entry->getUserFqdn();   // blame_user_fqdn\n}\n'})}),"\n",(0,s.jsx)(n.h2,{id:"-best-practices",children:"\u2705 Best Practices"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsxs)(n.strong,{children:["Always return ",(0,s.jsx)(n.code,{children:"null"})," when no user is available"]})," - Don't create fake users"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Use meaningful identifiers"})," - Use the actual user ID, not just the username"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Include useful context in the username"})," - Consider including role or context info"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Handle all authentication methods"})," - Consider API tokens, CLI, impersonation, etc."]}),"\n"]}),"\n",(0,s.jsxs)(n.div,{className:"markdown-alert markdown-alert-important",dir:"auto",children:["\n",(0,s.jsxs)(n.p,{className:"markdown-alert-title",dir:"auto",children:[(0,s.jsx)(n.svg,{className:"octicon",viewBox:"0 0 16 16",width:"16",height:"16","aria-hidden":"true",children:(0,s.jsx)(n.path,{d:"M0 1.75C0 .784.784 0 1.75 0h12.5C15.216 0 16 .784 16 1.75v9.5A1.75 1.75 0 0 1 14.25 13H8.06l-2.573 2.573A1.458 1.458 0 0 1 3 14.543V13H1.75A1.75 1.75 0 0 1 0 11.25Zm1.75-.25a.25.25 0 0 0-.25.25v9.5c0 .138.112.25.25.25h2a.75.75 0 0 1 .75.75v2.19l2.72-2.72a.749.749 0 0 1 .53-.22h6.5a.25.25 0 0 0 .25-.25v-9.5a.25.25 0 0 0-.25-.25Zm7 2.25v2.5a.75.75 0 0 1-1.5 0v-2.5a.75.75 0 0 1 1.5 0ZM9 9a1 1 0 1 1-2 0 1 1 0 0 1 2 0Z"})}),"IMPORTANT"]}),"\n",(0,s.jsxs)(n.p,{children:["Always return ",(0,s.jsx)(n.code,{children:"null"})," when there's no authenticated user. Don't create placeholder users as this can lead to confusing audit trails."]}),"\n"]}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"related",children:"Related"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["\ud83d\udd10 ",(0,s.jsx)(n.a,{href:"/auditor-docs/auditor/configuration/security-provider",children:"Security Provider Configuration"})]}),"\n",(0,s.jsxs)(n.li,{children:["\ud83d\udee1\ufe0f ",(0,s.jsx)(n.a,{href:"/auditor-docs/auditor/configuration/role-checker",children:"Role Checker Configuration"})]}),"\n"]})]})}function l(e={}){const{wrapper:n}={...(0,t.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(u,{...e})}):u(e)}},28453(e,n,r){r.d(n,{R:()=>a,x:()=>o});var i=r(96540);const s={},t=i.createContext(s);function a(e){const n=i.useContext(t);return i.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:a(e.components),i.createElement(t.Provider,{value:n},e.children)}}}]);