"use strict";(self.webpackChunkauditor_docs=self.webpackChunkauditor_docs||[]).push([[723],{18056(e,n,t){t.r(n),t.d(n,{assets:()=>l,contentTitle:()=>s,default:()=>d,frontMatter:()=>o,metadata:()=>r,toc:()=>c});const r=JSON.parse('{"id":"customization/security-provider","title":"Security Provider","description":"Customize IP address and context detection for audit entries","source":"@site/docs/auditor-bundle/customization/security-provider.md","sourceDirName":"customization","slug":"/customization/security-provider","permalink":"/auditor-docs/auditor-bundle/customization/security-provider","draft":false,"unlisted":false,"tags":[],"version":"current","frontMatter":{},"sidebar":"auditorBundleSidebar","previous":{"title":"User Provider","permalink":"/auditor-docs/auditor-bundle/customization/user-provider"},"next":{"title":"Role Checker","permalink":"/auditor-docs/auditor-bundle/customization/role-checker"}}');var i=t(74848),a=t(28453);const o={},s="Security Provider",l={},c=[{value:"\ud83d\udcdd Interface",id:"-interface",level:2},{value:"\ud83d\udce6 Built-in Provider",id:"-built-in-provider",level:2},{value:"\ud83d\udd27 Creating a Custom Provider",id:"-creating-a-custom-provider",level:2},{value:"Basic Example",id:"basic-example",level:3},{value:"Registration",id:"registration",level:3},{value:"\ud83d\udcda Examples",id:"-examples",level:2},{value:"\ud83d\udd04 Behind a Proxy/Load Balancer",id:"-behind-a-proxyload-balancer",level:3},{value:"\u2601\ufe0f Cloudflare",id:"\ufe0f-cloudflare",level:3},{value:"\ud83c\udf29\ufe0f AWS ALB / API Gateway",id:"\ufe0f-aws-alb--api-gateway",level:3},{value:"\ud83d\udda5\ufe0f Console Context Aware",id:"\ufe0f-console-context-aware",level:3},{value:"\ud83d\ude80 Next Steps",id:"-next-steps",level:2}];function u(e){const n={a:"a",blockquote:"blockquote",code:"code",div:"div",h1:"h1",h2:"h2",h3:"h3",header:"header",hr:"hr",li:"li",p:"p",path:"path",pre:"pre",strong:"strong",svg:"svg",ul:"ul",...(0,a.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.header,{children:(0,i.jsx)(n.h1,{id:"security-provider",children:"Security Provider"})}),"\n",(0,i.jsxs)(n.blockquote,{children:["\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Customize IP address and context detection for audit entries"})}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"A security provider returns contextual security information for audit entries."}),"\n",(0,i.jsx)(n.h2,{id:"-interface",children:"\ud83d\udcdd Interface"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-php",children:"namespace DH\\Auditor\\Security;\n\ninterface SecurityProviderInterface\n{\n    public function __invoke(): array;\n}\n"})}),"\n",(0,i.jsx)(n.p,{children:"Returns an array with two elements:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-php",children:"return [\n    $clientIp,      // string|null - Client IP address\n    $firewallName,  // string|null - Firewall or context name\n];\n"})}),"\n",(0,i.jsx)(n.h2,{id:"-built-in-provider",children:"\ud83d\udce6 Built-in Provider"}),"\n",(0,i.jsxs)(n.p,{children:["The default ",(0,i.jsx)(n.code,{children:"DH\\AuditorBundle\\Security\\SecurityProvider"}),":"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-php",children:"public function __invoke(): array\n{\n    $request = $this->requestStack->getCurrentRequest();\n\n    if (!$request instanceof Request) {\n        return [null, null];\n    }\n\n    $firewallConfig = $this->firewallMap->getFirewallConfig($request);\n\n    return [\n        $request->getClientIp(),\n        $firewallConfig?->getName(),\n    ];\n}\n"})}),"\n",(0,i.jsx)(n.h2,{id:"-creating-a-custom-provider",children:"\ud83d\udd27 Creating a Custom Provider"}),"\n",(0,i.jsx)(n.h3,{id:"basic-example",children:"Basic Example"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-php",children:"<?php\n\nnamespace App\\Audit;\n\nuse DH\\Auditor\\Security\\SecurityProviderInterface;\nuse Symfony\\Component\\HttpFoundation\\RequestStack;\n\nclass CustomSecurityProvider implements SecurityProviderInterface\n{\n    public function __construct(\n        private readonly RequestStack $requestStack,\n    ) {}\n\n    public function __invoke(): array\n    {\n        $request = $this->requestStack->getCurrentRequest();\n\n        if (null === $request) {\n            return [null, null];\n        }\n\n        return [\n            $request->getClientIp(),\n            'my-app',\n        ];\n    }\n}\n"})}),"\n",(0,i.jsx)(n.h3,{id:"registration",children:"Registration"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:"# config/packages/dh_auditor.yaml\ndh_auditor:\n    security_provider: 'App\\Audit\\CustomSecurityProvider'\n"})}),"\n",(0,i.jsx)(n.h2,{id:"-examples",children:"\ud83d\udcda Examples"}),"\n",(0,i.jsx)(n.h3,{id:"-behind-a-proxyload-balancer",children:"\ud83d\udd04 Behind a Proxy/Load Balancer"}),"\n",(0,i.jsxs)(n.div,{className:"markdown-alert markdown-alert-important",dir:"auto",children:["\n",(0,i.jsxs)(n.p,{className:"markdown-alert-title",dir:"auto",children:[(0,i.jsx)(n.svg,{className:"octicon",viewBox:"0 0 16 16",width:"16",height:"16","aria-hidden":"true",children:(0,i.jsx)(n.path,{d:"M0 1.75C0 .784.784 0 1.75 0h12.5C15.216 0 16 .784 16 1.75v9.5A1.75 1.75 0 0 1 14.25 13H8.06l-2.573 2.573A1.458 1.458 0 0 1 3 14.543V13H1.75A1.75 1.75 0 0 1 0 11.25Zm1.75-.25a.25.25 0 0 0-.25.25v9.5c0 .138.112.25.25.25h2a.75.75 0 0 1 .75.75v2.19l2.72-2.72a.749.749 0 0 1 .53-.22h6.5a.25.25 0 0 0 .25-.25v-9.5a.25.25 0 0 0-.25-.25Zm7 2.25v2.5a.75.75 0 0 1-1.5 0v-2.5a.75.75 0 0 1 1.5 0ZM9 9a1 1 0 1 1-2 0 1 1 0 0 1 2 0Z"})}),"IMPORTANT"]}),"\n",(0,i.jsx)(n.p,{children:"When behind a proxy, the client IP may be in forwarded headers rather than the direct connection IP."}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-php",children:"<?php\n\nnamespace App\\Audit;\n\nuse DH\\Auditor\\Security\\SecurityProviderInterface;\nuse Symfony\\Bundle\\SecurityBundle\\Security\\FirewallMap;\nuse Symfony\\Component\\HttpFoundation\\Request;\nuse Symfony\\Component\\HttpFoundation\\RequestStack;\n\nclass ProxyAwareSecurityProvider implements SecurityProviderInterface\n{\n    public function __construct(\n        private readonly RequestStack $requestStack,\n        private readonly FirewallMap $firewallMap,\n    ) {}\n\n    public function __invoke(): array\n    {\n        $request = $this->requestStack->getCurrentRequest();\n\n        if (!$request instanceof Request) {\n            return [null, null];\n        }\n\n        // Check proxy headers in order of preference\n        $clientIp = $request->headers->get('X-Real-IP')\n            ?? $request->headers->get('X-Forwarded-For')\n            ?? $request->getClientIp();\n\n        // Handle X-Forwarded-For with multiple IPs\n        if (str_contains($clientIp ?? '', ',')) {\n            $clientIp = trim(explode(',', $clientIp)[0]);\n        }\n\n        $firewallConfig = $this->firewallMap->getFirewallConfig($request);\n\n        return [$clientIp, $firewallConfig?->getName()];\n    }\n}\n"})}),"\n",(0,i.jsx)(n.h3,{id:"\ufe0f-cloudflare",children:"\u2601\ufe0f Cloudflare"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-php",children:"<?php\n\nnamespace App\\Audit;\n\nuse DH\\Auditor\\Security\\SecurityProviderInterface;\nuse Symfony\\Bundle\\SecurityBundle\\Security\\FirewallMap;\nuse Symfony\\Component\\HttpFoundation\\Request;\nuse Symfony\\Component\\HttpFoundation\\RequestStack;\n\nclass CloudflareSecurityProvider implements SecurityProviderInterface\n{\n    public function __construct(\n        private readonly RequestStack $requestStack,\n        private readonly FirewallMap $firewallMap,\n    ) {}\n\n    public function __invoke(): array\n    {\n        $request = $this->requestStack->getCurrentRequest();\n\n        if (!$request instanceof Request) {\n            return [null, null];\n        }\n\n        // Cloudflare provides original IP in CF-Connecting-IP\n        $clientIp = $request->headers->get('CF-Connecting-IP')\n            ?? $request->getClientIp();\n\n        $firewallConfig = $this->firewallMap->getFirewallConfig($request);\n\n        return [$clientIp, $firewallConfig?->getName()];\n    }\n}\n"})}),"\n",(0,i.jsx)(n.h3,{id:"\ufe0f-aws-alb--api-gateway",children:"\ud83c\udf29\ufe0f AWS ALB / API Gateway"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-php",children:"<?php\n\nnamespace App\\Audit;\n\nuse DH\\Auditor\\Security\\SecurityProviderInterface;\nuse Symfony\\Component\\HttpFoundation\\RequestStack;\n\nclass AwsSecurityProvider implements SecurityProviderInterface\n{\n    public function __construct(\n        private readonly RequestStack $requestStack,\n    ) {}\n\n    public function __invoke(): array\n    {\n        $request = $this->requestStack->getCurrentRequest();\n\n        if (null === $request) {\n            return [null, null];\n        }\n\n        // AWS ALB/API Gateway headers\n        $clientIp = $request->headers->get('X-Forwarded-For');\n        if (null !== $clientIp && str_contains($clientIp, ',')) {\n            // First IP is the original client\n            $clientIp = trim(explode(',', $clientIp)[0]);\n        }\n\n        // Use API Gateway stage as context\n        $context = $request->headers->get('X-Amzn-Api-Gateway-Stage', 'unknown');\n\n        return [$clientIp ?? $request->getClientIp(), $context];\n    }\n}\n"})}),"\n",(0,i.jsx)(n.h3,{id:"\ufe0f-console-context-aware",children:"\ud83d\udda5\ufe0f Console Context Aware"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-php",children:"<?php\n\nnamespace App\\Audit;\n\nuse DH\\Auditor\\Security\\SecurityProviderInterface;\nuse Symfony\\Component\\HttpFoundation\\RequestStack;\n\nclass ConsoleAwareSecurityProvider implements SecurityProviderInterface\n{\n    private ?string $consoleContext = null;\n\n    public function __construct(\n        private readonly RequestStack $requestStack,\n    ) {}\n\n    public function __invoke(): array\n    {\n        $request = $this->requestStack->getCurrentRequest();\n\n        // HTTP context\n        if (null !== $request) {\n            return [$request->getClientIp(), 'http'];\n        }\n\n        // Console context\n        return ['127.0.0.1', $this->consoleContext ?? 'console'];\n    }\n\n    public function setConsoleContext(?string $context): void\n    {\n        $this->consoleContext = $context;\n    }\n}\n"})}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h2,{id:"-next-steps",children:"\ud83d\ude80 Next Steps"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["\ud83d\udee1\ufe0f ",(0,i.jsx)(n.a,{href:"/auditor-docs/auditor-bundle/customization/role-checker",children:"Role Checker"})," - Customize access control"]}),"\n",(0,i.jsxs)(n.li,{children:["\ud83d\udc64 ",(0,i.jsx)(n.a,{href:"/auditor-docs/auditor-bundle/customization/user-provider",children:"User Provider"})," - Customize user identification"]}),"\n"]})]})}function d(e={}){const{wrapper:n}={...(0,a.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(u,{...e})}):u(e)}},28453(e,n,t){t.d(n,{R:()=>o,x:()=>s});var r=t(96540);const i={},a=r.createContext(i);function o(e){const n=r.useContext(a);return r.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function s(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:o(e.components),r.createElement(a.Provider,{value:n},e.children)}}}]);