"use strict";(self.webpackChunkauditor_docs=self.webpackChunkauditor_docs||[]).push([[365],{82891(e,n,t){t.r(n),t.d(n,{assets:()=>l,contentTitle:()=>s,default:()=>h,frontMatter:()=>d,metadata:()=>r,toc:()=>c});const r=JSON.parse('{"id":"extra-data","title":"Extra Data","description":"The extra_data column allows you to store arbitrary supplementary information alongside each audit entry. This is useful for capturing contextual data that isn\'t part of the entity\'s fields, such as department, role, request metadata, or any business-specific information.","source":"@site/docs/auditor/extra-data.md","sourceDirName":".","slug":"/extra-data","permalink":"/auditor-docs/auditor/extra-data","draft":false,"unlisted":false,"tags":[],"version":"current","frontMatter":{},"sidebar":"auditorSidebar","previous":{"title":"API Reference","permalink":"/auditor-docs/auditor/api/"},"next":{"title":"Contributing","permalink":"/auditor-docs/auditor/contributing"}}');var a=t(74848),i=t(28453);const d={},s="Extra Data",l={},c=[{value:"How It Works",id:"how-it-works",level:2},{value:"Data Flow",id:"data-flow",level:3},{value:"Approach 1: <code>extra_data_provider</code> Callable",id:"approach-1-extra_data_provider-callable",level:2},{value:"When to use this approach",id:"when-to-use-this-approach",level:3},{value:"Approach 2: <code>LifecycleEvent</code> Listener",id:"approach-2-lifecycleevent-listener",level:2},{value:"With Service Injection",id:"with-service-injection",level:3},{value:"Merging Provider and Listener Data",id:"merging-provider-and-listener-data",level:3},{value:"When to use this approach",id:"when-to-use-this-approach-1",level:3},{value:"Reading Extra Data",id:"reading-extra-data",level:2},{value:"Schema Update",id:"schema-update",level:2},{value:"Important Caveats",id:"important-caveats",level:2},{value:"Entity State in <code>remove()</code> Operations",id:"entity-state-in-remove-operations",level:3},{value:"Do Not Write to the Audited EntityManager",id:"do-not-write-to-the-audited-entitymanager",level:3},{value:"JSON Encoding",id:"json-encoding",level:3},{value:"Performance",id:"performance",level:3},{value:"Filtering by Extra Data",id:"filtering-by-extra-data",level:2},{value:"Basic Usage",id:"basic-usage",level:3},{value:"Supported Operators",id:"supported-operators",level:3},{value:"Supported Databases",id:"supported-databases",level:3},{value:"Strict Mode",id:"strict-mode",level:3},{value:"Limitations",id:"limitations",level:3},{value:"JSON Indexing for Performance",id:"json-indexing-for-performance",level:2},{value:"MySQL 8.0+",id:"mysql-80",level:3},{value:"MariaDB 10.2+",id:"mariadb-102",level:3},{value:"PostgreSQL",id:"postgresql",level:3},{value:"SQLite",id:"sqlite",level:3},{value:"Next Steps",id:"next-steps",level:2}];function o(e){const n={a:"a",code:"code",div:"div",h1:"h1",h2:"h2",h3:"h3",header:"header",hr:"hr",li:"li",mermaid:"mermaid",ol:"ol",p:"p",path:"path",pre:"pre",strong:"strong",svg:"svg",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,i.R)(),...e.components};return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(n.header,{children:(0,a.jsx)(n.h1,{id:"extra-data",children:"Extra Data"})}),"\n",(0,a.jsxs)(n.p,{children:["The ",(0,a.jsx)(n.code,{children:"extra_data"})," column allows you to store arbitrary supplementary information alongside each audit entry. This is useful for capturing contextual data that isn't part of the entity's fields, such as department, role, request metadata, or any business-specific information."]}),"\n",(0,a.jsx)(n.h2,{id:"how-it-works",children:"How It Works"}),"\n",(0,a.jsxs)(n.p,{children:["Each audit entry has a nullable JSON ",(0,a.jsx)(n.code,{children:"extra_data"})," column. By default, it is ",(0,a.jsx)(n.code,{children:"NULL"})," (zero overhead when not used)."]}),"\n",(0,a.jsx)(n.p,{children:"There are two complementary ways to populate it \u2014 you can use either or both:"}),"\n",(0,a.jsxs)(n.ol,{children:["\n",(0,a.jsxs)(n.li,{children:[(0,a.jsxs)(n.strong,{children:[(0,a.jsx)(n.code,{children:"extra_data_provider"})," callable"]})," (global): configured once on ",(0,a.jsx)(n.code,{children:"Configuration"}),", automatically applied to every audit entry. Ideal for request-level context such as the current route name, request ID, or tenant identifier."]}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsxs)(n.strong,{children:[(0,a.jsx)(n.code,{children:"LifecycleEvent"})," listener"]})," (per-entity): an event listener that intercepts each audit entry just before it is persisted and sets (or enriches) ",(0,a.jsx)(n.code,{children:"extra_data"})," based on the entity class or its properties."]}),"\n"]}),"\n",(0,a.jsx)(n.h3,{id:"data-flow",children:"Data Flow"}),"\n",(0,a.jsx)(n.mermaid,{value:'flowchart TD\n    A["Entity Change\n    persist / update / remove + flush"] --\x3e B\n\n    B["TransactionProcessor\n    Builds payload: diffs, blame\n    Calls extra_data_provider (if set)\n    \u2192 extra_data = JSON string or null"] --\x3e C\n\n    C["LifecycleEvent dispatched"]\n    C --- D["payload\n    diffs, blame, extra_data"]\n    C --- E["entity\n    the audited object"]\n    C --\x3e F\n\n    F["Your Listener \u2014 optional\n    Can read/override/merge extra_data\n    Calls $event->setPayload()"]:::optional --\x3e G\n\n    G[("Audit Table\n    INSERT INTO *_audit\n    (..., extra_data, ...)")]\n\n    classDef optional stroke-dasharray: 5 5'}),"\n",(0,a.jsxs)(n.div,{className:"markdown-alert markdown-alert-note",dir:"auto",children:["\n",(0,a.jsxs)(n.p,{className:"markdown-alert-title",dir:"auto",children:[(0,a.jsx)(n.svg,{className:"octicon",viewBox:"0 0 16 16",width:"16",height:"16","aria-hidden":"true",children:(0,a.jsx)(n.path,{d:"M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8Zm8-6.5a6.5 6.5 0 1 0 0 13 6.5 6.5 0 0 0 0-13ZM6.5 7.75A.75.75 0 0 1 7.25 7h1a.75.75 0 0 1 .75.75v2.75h.25a.75.75 0 0 1 0 1.5h-2a.75.75 0 0 1 0-1.5h.25v-2h-.25a.75.75 0 0 1-.75-.75ZM8 6a1 1 0 1 1 0-2 1 1 0 0 1 0 2Z"})}),"NOTE"]}),"\n",(0,a.jsxs)(n.p,{children:["When both a provider and a listener are configured, the listener ",(0,a.jsx)(n.strong,{children:"takes precedence"})," because it fires after the provider. You can use the listener to enrich or override data set by the provider."]}),"\n"]}),"\n",(0,a.jsx)(n.hr,{}),"\n",(0,a.jsxs)(n.h2,{id:"approach-1-extra_data_provider-callable",children:["Approach 1: ",(0,a.jsx)(n.code,{children:"extra_data_provider"})," Callable"]}),"\n",(0,a.jsxs)(n.p,{children:["Register a callable on the ",(0,a.jsx)(n.code,{children:"Configuration"})," object. It is invoked for every audit entry in every transaction. The callable must return ",(0,a.jsx)(n.code,{children:"?array"})," \u2014 return ",(0,a.jsx)(n.code,{children:"null"})," to leave ",(0,a.jsx)(n.code,{children:"extra_data"})," empty."]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-php",children:"$auditor->getConfiguration()->setExtraDataProvider(\n    static fn (): ?array => ['route' => 'app_order_edit', 'env' => 'prod']\n);\n"})}),"\n",(0,a.jsxs)(n.p,{children:["The returned array is automatically JSON-encoded and stored in ",(0,a.jsx)(n.code,{children:"extra_data"}),". If the callable returns ",(0,a.jsx)(n.code,{children:"null"}),", ",(0,a.jsx)(n.code,{children:"extra_data"})," is stored as ",(0,a.jsx)(n.code,{children:"NULL"}),"."]}),"\n",(0,a.jsx)(n.h3,{id:"when-to-use-this-approach",children:"When to use this approach"}),"\n",(0,a.jsxs)(n.table,{children:[(0,a.jsx)(n.thead,{children:(0,a.jsxs)(n.tr,{children:[(0,a.jsx)(n.th,{children:"Use case"}),(0,a.jsx)(n.th,{children:"Suitable?"})]})}),(0,a.jsxs)(n.tbody,{children:[(0,a.jsxs)(n.tr,{children:[(0,a.jsx)(n.td,{children:"Capture the current route name for every entry"}),(0,a.jsx)(n.td,{children:"\u2705"})]}),(0,a.jsxs)(n.tr,{children:[(0,a.jsx)(n.td,{children:"Attach a request ID / correlation ID"}),(0,a.jsx)(n.td,{children:"\u2705"})]}),(0,a.jsxs)(n.tr,{children:[(0,a.jsx)(n.td,{children:"Attach tenant / organisation context"}),(0,a.jsx)(n.td,{children:"\u2705"})]}),(0,a.jsxs)(n.tr,{children:[(0,a.jsxs)(n.td,{children:["Attach entity-specific data (e.g. ",(0,a.jsx)(n.code,{children:"$entity->getDepartment()"}),")"]}),(0,a.jsx)(n.td,{children:"\u274c Use a listener instead"})]})]})]}),"\n",(0,a.jsx)(n.hr,{}),"\n",(0,a.jsxs)(n.h2,{id:"approach-2-lifecycleevent-listener",children:["Approach 2: ",(0,a.jsx)(n.code,{children:"LifecycleEvent"})," Listener"]}),"\n",(0,a.jsxs)(n.p,{children:["Create an event listener that listens to ",(0,a.jsx)(n.code,{children:"LifecycleEvent"}),". The event provides access to both the payload and the original entity object."]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-php",children:"<?php\n\nnamespace App\\EventListener;\n\nuse App\\Entity\\User;\nuse DH\\Auditor\\Event\\LifecycleEvent;\nuse Symfony\\Component\\EventDispatcher\\Attribute\\AsEventListener;\n\n#[AsEventListener(event: LifecycleEvent::class, priority: 10)]\nfinal class AuditExtraDataListener\n{\n    public function __invoke(LifecycleEvent $event): void\n    {\n        $payload = $event->getPayload();\n\n        // Filter by entity class\n        if ($payload['entity'] !== User::class || null === $event->entity) {\n            return;\n        }\n\n        // Attach extra data as a JSON string\n        $payload['extra_data'] = json_encode([\n            'department' => $event->entity->getDepartment(),\n            'role' => $event->entity->getRole(),\n        ], JSON_THROW_ON_ERROR);\n\n        $event->setPayload($payload);\n    }\n}\n"})}),"\n",(0,a.jsx)(n.h3,{id:"with-service-injection",children:"With Service Injection"}),"\n",(0,a.jsx)(n.p,{children:"Since the listener is a standard Symfony service, you can inject any dependency:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-php",children:"<?php\n\nnamespace App\\EventListener;\n\nuse App\\Entity\\Order;\nuse DH\\Auditor\\Event\\LifecycleEvent;\nuse Symfony\\Bundle\\SecurityBundle\\Security;\nuse Symfony\\Component\\EventDispatcher\\Attribute\\AsEventListener;\nuse Symfony\\Component\\HttpFoundation\\RequestStack;\n\n#[AsEventListener(event: LifecycleEvent::class, priority: 10)]\nfinal class OrderAuditExtraDataListener\n{\n    public function __construct(\n        private readonly Security $security,\n        private readonly RequestStack $requestStack,\n    ) {}\n\n    public function __invoke(LifecycleEvent $event): void\n    {\n        $payload = $event->getPayload();\n\n        if ($payload['entity'] !== Order::class) {\n            return;\n        }\n\n        $request = $this->requestStack->getCurrentRequest();\n\n        $payload['extra_data'] = json_encode([\n            'admin_user' => $this->security->getUser()?->getUserIdentifier(),\n            'route' => $request?->attributes->get('_route'),\n            'reason' => $request?->headers->get('X-Audit-Reason'),\n        ], JSON_THROW_ON_ERROR);\n\n        $event->setPayload($payload);\n    }\n}\n"})}),"\n",(0,a.jsx)(n.h3,{id:"merging-provider-and-listener-data",children:"Merging Provider and Listener Data"}),"\n",(0,a.jsx)(n.p,{children:"When both a provider and a listener are active, you can merge their contributions in the listener:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-php",children:"public function __invoke(LifecycleEvent $event): void\n{\n    $payload = $event->getPayload();\n\n    if ($payload['entity'] !== User::class) {\n        return;\n    }\n\n    // Decode what the provider already set (if anything)\n    $existing = null !== $payload['extra_data']\n        ? json_decode($payload['extra_data'], true, 512, JSON_THROW_ON_ERROR)\n        : [];\n\n    // Merge entity-specific data\n    $merged = array_merge($existing, [\n        'department' => $event->entity->getDepartment(),\n    ]);\n\n    $payload['extra_data'] = json_encode($merged, JSON_THROW_ON_ERROR);\n    $event->setPayload($payload);\n}\n"})}),"\n",(0,a.jsx)(n.h3,{id:"when-to-use-this-approach-1",children:"When to use this approach"}),"\n",(0,a.jsxs)(n.table,{children:[(0,a.jsx)(n.thead,{children:(0,a.jsxs)(n.tr,{children:[(0,a.jsx)(n.th,{children:"Use case"}),(0,a.jsx)(n.th,{children:"Suitable?"})]})}),(0,a.jsxs)(n.tbody,{children:[(0,a.jsxs)(n.tr,{children:[(0,a.jsxs)(n.td,{children:["Attach entity-specific data (e.g. ",(0,a.jsx)(n.code,{children:"$entity->getDepartment()"}),")"]}),(0,a.jsx)(n.td,{children:"\u2705"})]}),(0,a.jsxs)(n.tr,{children:[(0,a.jsx)(n.td,{children:"Filter by entity class"}),(0,a.jsx)(n.td,{children:"\u2705"})]}),(0,a.jsxs)(n.tr,{children:[(0,a.jsxs)(n.td,{children:["Conditionally skip ",(0,a.jsx)(n.code,{children:"extra_data"})," for certain entities"]}),(0,a.jsx)(n.td,{children:"\u2705"})]}),(0,a.jsxs)(n.tr,{children:[(0,a.jsx)(n.td,{children:"Apply the same data to every entity without conditions"}),(0,a.jsx)(n.td,{children:"\u274c Use a provider instead"})]})]})]}),"\n",(0,a.jsx)(n.hr,{}),"\n",(0,a.jsx)(n.h2,{id:"reading-extra-data",children:"Reading Extra Data"}),"\n",(0,a.jsxs)(n.p,{children:["The ",(0,a.jsx)(n.code,{children:"Entry"})," model provides access via the ",(0,a.jsx)(n.code,{children:"extraData"})," property or the ",(0,a.jsx)(n.code,{children:"getExtraData()"})," method:"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-php",children:"$reader = new Reader($provider);\n$entries = $reader->createQuery(User::class)->execute();\n\nforeach ($entries as $entry) {\n    $extraData = $entry->extraData; // ?array (decoded JSON)\n\n    if (null !== $extraData) {\n        echo sprintf(\n            \"Department: %s, Role: %s\\n\",\n            $extraData['department'] ?? 'N/A',\n            $extraData['role'] ?? 'N/A',\n        );\n    }\n}\n"})}),"\n",(0,a.jsxs)(n.p,{children:["Both ",(0,a.jsx)(n.code,{children:"$entry->extraData"})," and ",(0,a.jsx)(n.code,{children:"$entry->getExtraData()"})," return:"]}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.code,{children:"null"})," if no extra data was set"]}),"\n",(0,a.jsx)(n.li,{children:"An associative array (decoded from JSON) otherwise"}),"\n"]}),"\n",(0,a.jsx)(n.hr,{}),"\n",(0,a.jsx)(n.h2,{id:"schema-update",children:"Schema Update"}),"\n",(0,a.jsxs)(n.p,{children:["The ",(0,a.jsx)(n.code,{children:"extra_data"})," column is added automatically when you run the schema update command:"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"# Preview the SQL that will be executed\nphp bin/console audit:schema:update --dump-sql\n\n# Apply the change\nphp bin/console audit:schema:update --force\n"})}),"\n",(0,a.jsxs)(n.div,{className:"markdown-alert markdown-alert-tip",dir:"auto",children:["\n",(0,a.jsxs)(n.p,{className:"markdown-alert-title",dir:"auto",children:[(0,a.jsx)(n.svg,{className:"octicon",viewBox:"0 0 16 16",width:"16",height:"16","aria-hidden":"true",children:(0,a.jsx)(n.path,{d:"M8 1.5c-2.363 0-4 1.69-4 3.75 0 .984.424 1.625.984 2.304l.214.253c.223.264.47.556.673.848.284.411.537.896.621 1.49a.75.75 0 0 1-1.484.211c-.04-.282-.163-.547-.37-.847a8.456 8.456 0 0 0-.542-.68c-.084-.1-.173-.205-.268-.32C3.201 7.75 2.5 6.766 2.5 5.25 2.5 2.31 4.863 0 8 0s5.5 2.31 5.5 5.25c0 1.516-.701 2.5-1.328 3.259-.095.115-.184.22-.268.319-.207.245-.383.453-.541.681-.208.3-.33.565-.37.847a.751.751 0 0 1-1.485-.212c.084-.593.337-1.078.621-1.489.203-.292.45-.584.673-.848.075-.088.147-.173.213-.253.561-.679.985-1.32.985-2.304 0-2.06-1.637-3.75-4-3.75ZM5.75 12h4.5a.75.75 0 0 1 0 1.5h-4.5a.75.75 0 0 1 0-1.5ZM6 15.25a.75.75 0 0 1 .75-.75h2.5a.75.75 0 0 1 0 1.5h-2.5a.75.75 0 0 1-.75-.75Z"})}),"TIP"]}),"\n",(0,a.jsxs)(n.p,{children:["No manual migration is needed. The column uses the same JSON type as ",(0,a.jsx)(n.code,{children:"diffs"})," (with automatic TEXT fallback on platforms that don't support native JSON)."]}),"\n"]}),"\n",(0,a.jsx)(n.hr,{}),"\n",(0,a.jsx)(n.h2,{id:"important-caveats",children:"Important Caveats"}),"\n",(0,a.jsxs)(n.h3,{id:"entity-state-in-remove-operations",children:["Entity State in ",(0,a.jsx)(n.code,{children:"remove()"})," Operations"]}),"\n",(0,a.jsxs)(n.div,{className:"markdown-alert markdown-alert-warning",dir:"auto",children:["\n",(0,a.jsxs)(n.p,{className:"markdown-alert-title",dir:"auto",children:[(0,a.jsx)(n.svg,{className:"octicon",viewBox:"0 0 16 16",width:"16",height:"16","aria-hidden":"true",children:(0,a.jsx)(n.path,{d:"M6.457 1.047c.659-1.234 2.427-1.234 3.086 0l6.082 11.378A1.75 1.75 0 0 1 14.082 15H1.918a1.75 1.75 0 0 1-1.543-2.575Zm1.763.707a.25.25 0 0 0-.44 0L1.698 13.132a.25.25 0 0 0 .22.368h12.164a.25.25 0 0 0 .22-.368Zm.53 3.996v2.5a.75.75 0 0 1-1.5 0v-2.5a.75.75 0 0 1 1.5 0ZM9 11a1 1 0 1 1-2 0 1 1 0 0 1 2 0Z"})}),"WARNING"]}),"\n",(0,a.jsxs)(n.p,{children:["During a ",(0,a.jsx)(n.code,{children:"remove"})," operation, the entity object is still in memory but has been ",(0,a.jsx)(n.strong,{children:"detached from the Unit of Work"}),"."]}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsxs)(n.li,{children:["Direct property access works (e.g., ",(0,a.jsx)(n.code,{children:"$entity->getName()"}),")"]}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.strong,{children:"Lazy-loaded associations may not be accessible"})," (they will throw or return ",(0,a.jsx)(n.code,{children:"null"}),")"]}),"\n"]}),"\n",(0,a.jsx)(n.p,{children:"If you need association data during deletions, ensure those associations are eagerly loaded or fetch the data before the flush."}),"\n"]}),"\n",(0,a.jsx)(n.h3,{id:"do-not-write-to-the-audited-entitymanager",children:"Do Not Write to the Audited EntityManager"}),"\n",(0,a.jsxs)(n.div,{className:"markdown-alert markdown-alert-caution",dir:"auto",children:["\n",(0,a.jsxs)(n.p,{className:"markdown-alert-title",dir:"auto",children:[(0,a.jsx)(n.svg,{className:"octicon",viewBox:"0 0 16 16",width:"16",height:"16","aria-hidden":"true",children:(0,a.jsx)(n.path,{d:"M4.47.22A.749.749 0 0 1 5 0h6c.199 0 .389.079.53.22l4.25 4.25c.141.14.22.331.22.53v6a.749.749 0 0 1-.22.53l-4.25 4.25A.749.749 0 0 1 11 16H5a.749.749 0 0 1-.53-.22L.22 11.53A.749.749 0 0 1 0 11V5c0-.199.079-.389.22-.53Zm.84 1.28L1.5 5.31v5.38l3.81 3.81h5.38l3.81-3.81V5.31L10.69 1.5ZM8 4a.75.75 0 0 1 .75.75v3.5a.75.75 0 0 1-1.5 0v-3.5A.75.75 0 0 1 8 4Zm0 8a1 1 0 1 1 0-2 1 1 0 0 1 0 2Z"})}),"CAUTION"]}),"\n",(0,a.jsxs)(n.p,{children:["The ",(0,a.jsx)(n.code,{children:"LifecycleEvent"})," is dispatched ",(0,a.jsx)(n.strong,{children:"during"})," a flush. The listener executes synchronously between ",(0,a.jsx)(n.code,{children:"notify()"})," and ",(0,a.jsx)(n.code,{children:"persist()"}),", within the same database transaction."]}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.strong,{children:"SELECTs are safe"})," (reading from another entity manager or connection)"]}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.strong,{children:"INSERT/UPDATE/DELETE on the audited EntityManager will interfere"})," with the ongoing flush and may cause unexpected behavior"]}),"\n"]}),"\n",(0,a.jsx)(n.p,{children:"If you need to perform write operations based on audit data, defer them (e.g., using a Symfony Messenger message)."}),"\n"]}),"\n",(0,a.jsx)(n.h3,{id:"json-encoding",children:"JSON Encoding"}),"\n",(0,a.jsxs)(n.div,{className:"markdown-alert markdown-alert-warning",dir:"auto",children:["\n",(0,a.jsxs)(n.p,{className:"markdown-alert-title",dir:"auto",children:[(0,a.jsx)(n.svg,{className:"octicon",viewBox:"0 0 16 16",width:"16",height:"16","aria-hidden":"true",children:(0,a.jsx)(n.path,{d:"M6.457 1.047c.659-1.234 2.427-1.234 3.086 0l6.082 11.378A1.75 1.75 0 0 1 14.082 15H1.918a1.75 1.75 0 0 1-1.543-2.575Zm1.763.707a.25.25 0 0 0-.44 0L1.698 13.132a.25.25 0 0 0 .22.368h12.164a.25.25 0 0 0 .22-.368Zm.53 3.996v2.5a.75.75 0 0 1-1.5 0v-2.5a.75.75 0 0 1 1.5 0ZM9 11a1 1 0 1 1-2 0 1 1 0 0 1 2 0Z"})}),"WARNING"]}),"\n",(0,a.jsxs)(n.p,{children:["The ",(0,a.jsx)(n.code,{children:"extra_data"})," value in the payload must be either ",(0,a.jsx)(n.code,{children:"null"})," or a ",(0,a.jsx)(n.strong,{children:"JSON-encoded string"})," (not an array). Always use ",(0,a.jsx)(n.code,{children:"json_encode()"})," when setting it in a listener:"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-php",children:"// Correct\n$payload['extra_data'] = json_encode(['key' => 'value'], JSON_THROW_ON_ERROR);\n\n// Incorrect - will not be stored properly\n$payload['extra_data'] = ['key' => 'value'];\n"})}),"\n",(0,a.jsxs)(n.p,{children:["The ",(0,a.jsx)(n.code,{children:"extra_data_provider"})," callable is exempt from this \u2014 it must return ",(0,a.jsx)(n.code,{children:"?array"})," and the encoding is done automatically."]}),"\n"]}),"\n",(0,a.jsx)(n.h3,{id:"performance",children:"Performance"}),"\n",(0,a.jsxs)(n.table,{children:[(0,a.jsx)(n.thead,{children:(0,a.jsxs)(n.tr,{children:[(0,a.jsx)(n.th,{children:"Aspect"}),(0,a.jsx)(n.th,{children:"Impact"})]})}),(0,a.jsxs)(n.tbody,{children:[(0,a.jsxs)(n.tr,{children:[(0,a.jsx)(n.td,{children:"Write"}),(0,a.jsx)(n.td,{children:"Negligible (+1 column in INSERT)"})]}),(0,a.jsxs)(n.tr,{children:[(0,a.jsx)(n.td,{children:"Read"}),(0,a.jsx)(n.td,{children:"Negligible (+1 column in SELECT, lazy decoding)"})]}),(0,a.jsxs)(n.tr,{children:[(0,a.jsx)(n.td,{children:"Storage"}),(0,a.jsxs)(n.td,{children:[(0,a.jsx)(n.code,{children:"NULL"})," when neither provider nor listener is active (zero overhead)"]})]})]})]}),"\n",(0,a.jsx)(n.hr,{}),"\n",(0,a.jsx)(n.h2,{id:"filtering-by-extra-data",children:"Filtering by Extra Data"}),"\n",(0,a.jsxs)(n.p,{children:["You can filter audit entries by ",(0,a.jsx)(n.code,{children:"extra_data"})," content using the ",(0,a.jsx)(n.code,{children:"JsonFilter"})," class. This generates platform-specific SQL for optimal performance."]}),"\n",(0,a.jsx)(n.h3,{id:"basic-usage",children:"Basic Usage"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-php",children:"use DH\\Auditor\\Provider\\Doctrine\\Persistence\\Reader\\Filter\\JsonFilter;\nuse DH\\Auditor\\Provider\\Doctrine\\Persistence\\Reader\\Query;\n\n$reader = new Reader($provider);\n$query = $reader->createQuery(User::class, ['page_size' => null]);\n\n// Filter by exact value\n$query->addFilter(new JsonFilter('extra_data', 'department', 'IT'));\n\n// Filter with LIKE pattern\n$query->addFilter(new JsonFilter('extra_data', 'department', 'IT%', 'LIKE'));\n\n// Filter by multiple values (IN)\n$query->addFilter(new JsonFilter('extra_data', 'status', ['active', 'pending'], 'IN'));\n\n// Filter where value is NULL\n$query->addFilter(new JsonFilter('extra_data', 'deleted_by', null, 'IS NULL'));\n\n// Nested JSON path\n$query->addFilter(new JsonFilter('extra_data', 'user.role', 'admin'));\n\n$entries = $query->execute();\n"})}),"\n",(0,a.jsx)(n.h3,{id:"supported-operators",children:"Supported Operators"}),"\n",(0,a.jsxs)(n.table,{children:[(0,a.jsx)(n.thead,{children:(0,a.jsxs)(n.tr,{children:[(0,a.jsx)(n.th,{children:"Operator"}),(0,a.jsx)(n.th,{children:"Description"}),(0,a.jsx)(n.th,{children:"Example"})]})}),(0,a.jsxs)(n.tbody,{children:[(0,a.jsxs)(n.tr,{children:[(0,a.jsx)(n.td,{children:(0,a.jsx)(n.code,{children:"="})}),(0,a.jsx)(n.td,{children:"Exact match (default)"}),(0,a.jsx)(n.td,{children:(0,a.jsx)(n.code,{children:"new JsonFilter('extra_data', 'dept', 'IT')"})})]}),(0,a.jsxs)(n.tr,{children:[(0,a.jsxs)(n.td,{children:[(0,a.jsx)(n.code,{children:"!="})," or ",(0,a.jsx)(n.code,{children:"<>"})]}),(0,a.jsx)(n.td,{children:"Not equal"}),(0,a.jsx)(n.td,{children:(0,a.jsx)(n.code,{children:"new JsonFilter('extra_data', 'dept', 'IT', '!=')"})})]}),(0,a.jsxs)(n.tr,{children:[(0,a.jsx)(n.td,{children:(0,a.jsx)(n.code,{children:"LIKE"})}),(0,a.jsx)(n.td,{children:"Pattern matching"}),(0,a.jsx)(n.td,{children:(0,a.jsx)(n.code,{children:"new JsonFilter('extra_data', 'dept', 'IT%', 'LIKE')"})})]}),(0,a.jsxs)(n.tr,{children:[(0,a.jsx)(n.td,{children:(0,a.jsx)(n.code,{children:"NOT LIKE"})}),(0,a.jsx)(n.td,{children:"Negative pattern"}),(0,a.jsx)(n.td,{children:(0,a.jsx)(n.code,{children:"new JsonFilter('extra_data', 'dept', '%temp%', 'NOT LIKE')"})})]}),(0,a.jsxs)(n.tr,{children:[(0,a.jsx)(n.td,{children:(0,a.jsx)(n.code,{children:"IN"})}),(0,a.jsx)(n.td,{children:"Multiple values"}),(0,a.jsx)(n.td,{children:(0,a.jsx)(n.code,{children:"new JsonFilter('extra_data', 'dept', ['IT', 'HR'], 'IN')"})})]}),(0,a.jsxs)(n.tr,{children:[(0,a.jsx)(n.td,{children:(0,a.jsx)(n.code,{children:"NOT IN"})}),(0,a.jsx)(n.td,{children:"Exclude values"}),(0,a.jsx)(n.td,{children:(0,a.jsx)(n.code,{children:"new JsonFilter('extra_data', 'dept', ['IT'], 'NOT IN')"})})]}),(0,a.jsxs)(n.tr,{children:[(0,a.jsx)(n.td,{children:(0,a.jsx)(n.code,{children:"IS NULL"})}),(0,a.jsx)(n.td,{children:"Value is null"}),(0,a.jsx)(n.td,{children:(0,a.jsx)(n.code,{children:"new JsonFilter('extra_data', 'dept', null, 'IS NULL')"})})]}),(0,a.jsxs)(n.tr,{children:[(0,a.jsx)(n.td,{children:(0,a.jsx)(n.code,{children:"IS NOT NULL"})}),(0,a.jsx)(n.td,{children:"Value exists"}),(0,a.jsx)(n.td,{children:(0,a.jsx)(n.code,{children:"new JsonFilter('extra_data', 'dept', null, 'IS NOT NULL')"})})]})]})]}),"\n",(0,a.jsx)(n.h3,{id:"supported-databases",children:"Supported Databases"}),"\n",(0,a.jsxs)(n.table,{children:[(0,a.jsx)(n.thead,{children:(0,a.jsxs)(n.tr,{children:[(0,a.jsx)(n.th,{children:"Database"}),(0,a.jsx)(n.th,{children:"Minimum Version"}),(0,a.jsx)(n.th,{children:"JSON Function Used"})]})}),(0,a.jsxs)(n.tbody,{children:[(0,a.jsxs)(n.tr,{children:[(0,a.jsx)(n.td,{children:"MySQL"}),(0,a.jsx)(n.td,{children:"5.7.0"}),(0,a.jsx)(n.td,{children:(0,a.jsx)(n.code,{children:"JSON_UNQUOTE(JSON_EXTRACT())"})})]}),(0,a.jsxs)(n.tr,{children:[(0,a.jsx)(n.td,{children:"MariaDB"}),(0,a.jsx)(n.td,{children:"10.2.3"}),(0,a.jsx)(n.td,{children:(0,a.jsx)(n.code,{children:"JSON_UNQUOTE(JSON_EXTRACT())"})})]}),(0,a.jsxs)(n.tr,{children:[(0,a.jsx)(n.td,{children:"PostgreSQL"}),(0,a.jsx)(n.td,{children:"9.4.0"}),(0,a.jsxs)(n.td,{children:[(0,a.jsx)(n.code,{children:"->>"})," operator"]})]}),(0,a.jsxs)(n.tr,{children:[(0,a.jsx)(n.td,{children:"SQLite"}),(0,a.jsx)(n.td,{children:"3.38.0"}),(0,a.jsx)(n.td,{children:(0,a.jsx)(n.code,{children:"json_extract()"})})]})]})]}),"\n",(0,a.jsx)(n.h3,{id:"strict-mode",children:"Strict Mode"}),"\n",(0,a.jsxs)(n.p,{children:["By default, if the database doesn't support JSON functions, the filter falls back to ",(0,a.jsx)(n.code,{children:"LIKE"})," pattern matching with a warning. This fallback may produce inaccurate results."]}),"\n",(0,a.jsx)(n.p,{children:"To enforce JSON support and throw an exception instead:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-php",children:"// Enable strict mode (5th parameter)\n$filter = new JsonFilter('extra_data', 'department', 'IT', '=', strict: true);\n\n// Throws InvalidArgumentException if JSON is not supported\n$query->addFilter($filter);\n"})}),"\n",(0,a.jsx)(n.h3,{id:"limitations",children:"Limitations"}),"\n",(0,a.jsxs)(n.div,{className:"markdown-alert markdown-alert-note",dir:"auto",children:["\n",(0,a.jsxs)(n.p,{className:"markdown-alert-title",dir:"auto",children:[(0,a.jsx)(n.svg,{className:"octicon",viewBox:"0 0 16 16",width:"16",height:"16","aria-hidden":"true",children:(0,a.jsx)(n.path,{d:"M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8Zm8-6.5a6.5 6.5 0 1 0 0 13 6.5 6.5 0 0 0 0-13ZM6.5 7.75A.75.75 0 0 1 7.25 7h1a.75.75 0 0 1 .75.75v2.75h.25a.75.75 0 0 1 0 1.5h-2a.75.75 0 0 1 0-1.5h.25v-2h-.25a.75.75 0 0 1-.75-.75ZM8 6a1 1 0 1 1 0-2 1 1 0 0 1 0 2Z"})}),"NOTE"]}),"\n",(0,a.jsxs)(n.p,{children:["This version only supports ",(0,a.jsx)(n.strong,{children:"scalar value extraction"})," from JSON. Nested array/object comparisons (e.g., ",(0,a.jsx)(n.code,{children:"JSON_CONTAINS"}),") are not yet implemented."]}),"\n"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-php",children:"// \u2705 Supported: scalar values\nnew JsonFilter('extra_data', 'department', 'IT');\nnew JsonFilter('extra_data', 'user.role', 'admin');\n\n// \u274c Not supported: array contains\n// new JsonFilter('extra_data', 'tags', ['php', 'symfony'], 'CONTAINS');\n"})}),"\n",(0,a.jsx)(n.hr,{}),"\n",(0,a.jsx)(n.h2,{id:"json-indexing-for-performance",children:"JSON Indexing for Performance"}),"\n",(0,a.jsx)(n.p,{children:"For frequently queried JSON paths, consider adding database indexes to improve performance."}),"\n",(0,a.jsx)(n.h3,{id:"mysql-80",children:"MySQL 8.0+"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-sql",children:"-- Functional index on a JSON path\nALTER TABLE user_audit\nADD INDEX idx_extra_department ((\n    CAST(extra_data->>'$.department' AS CHAR(50) COLLATE utf8mb4_bin)\n));\n\n-- For nested paths\nALTER TABLE user_audit\nADD INDEX idx_extra_user_role ((\n    CAST(extra_data->>'$.user.role' AS CHAR(50) COLLATE utf8mb4_bin)\n));\n"})}),"\n",(0,a.jsx)(n.h3,{id:"mariadb-102",children:"MariaDB 10.2+"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-sql",children:"-- Virtual column with index\nALTER TABLE user_audit\nADD COLUMN extra_department VARCHAR(50) AS (JSON_VALUE(extra_data, '$.department')) VIRTUAL,\nADD INDEX idx_extra_department (extra_department);\n"})}),"\n",(0,a.jsx)(n.h3,{id:"postgresql",children:"PostgreSQL"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-sql",children:"-- GIN index for general JSON queries\nCREATE INDEX idx_extra_data_gin ON user_audit USING GIN (extra_data jsonb_path_ops);\n\n-- B-tree index for specific path (equality queries)\nCREATE INDEX idx_extra_department ON user_audit ((extra_data->>'department'));\n"})}),"\n",(0,a.jsx)(n.h3,{id:"sqlite",children:"SQLite"}),"\n",(0,a.jsxs)(n.div,{className:"markdown-alert markdown-alert-warning",dir:"auto",children:["\n",(0,a.jsxs)(n.p,{className:"markdown-alert-title",dir:"auto",children:[(0,a.jsx)(n.svg,{className:"octicon",viewBox:"0 0 16 16",width:"16",height:"16","aria-hidden":"true",children:(0,a.jsx)(n.path,{d:"M6.457 1.047c.659-1.234 2.427-1.234 3.086 0l6.082 11.378A1.75 1.75 0 0 1 14.082 15H1.918a1.75 1.75 0 0 1-1.543-2.575Zm1.763.707a.25.25 0 0 0-.44 0L1.698 13.132a.25.25 0 0 0 .22.368h12.164a.25.25 0 0 0 .22-.368Zm.53 3.996v2.5a.75.75 0 0 1-1.5 0v-2.5a.75.75 0 0 1 1.5 0ZM9 11a1 1 0 1 1-2 0 1 1 0 0 1 2 0Z"})}),"WARNING"]}),"\n",(0,a.jsx)(n.p,{children:"SQLite does not support indexes on JSON expressions. For high-volume audit tables, consider using a different database or denormalizing frequently queried values into separate columns."}),"\n"]}),"\n",(0,a.jsx)(n.hr,{}),"\n",(0,a.jsx)(n.h2,{id:"next-steps",children:"Next Steps"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsx)(n.li,{children:(0,a.jsx)(n.a,{href:"/auditor-docs/auditor/querying/entry",children:"Entry Model Reference"})}),"\n",(0,a.jsx)(n.li,{children:(0,a.jsx)(n.a,{href:"/auditor-docs/auditor/querying/",children:"Querying Overview"})}),"\n",(0,a.jsx)(n.li,{children:(0,a.jsx)(n.a,{href:"/auditor-docs/auditor/querying/filters",children:"Filters Reference"})}),"\n",(0,a.jsx)(n.li,{children:(0,a.jsx)(n.a,{href:"/auditor-docs/auditor/upgrade/v4",children:"Upgrade Guide"})}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,a.jsx)(n,{...e,children:(0,a.jsx)(o,{...e})}):o(e)}},28453(e,n,t){t.d(n,{R:()=>d,x:()=>s});var r=t(96540);const a={},i=r.createContext(a);function d(e){const n=r.useContext(i);return r.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function s(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(a):e.components||a:d(e.components),r.createElement(i.Provider,{value:n},e.children)}}}]);