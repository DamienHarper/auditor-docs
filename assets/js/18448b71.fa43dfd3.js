"use strict";(self.webpackChunkauditor_docs=self.webpackChunkauditor_docs||[]).push([[5758],{78862(e,n,r){r.r(n),r.d(n,{assets:()=>d,contentTitle:()=>l,default:()=>u,frontMatter:()=>a,metadata:()=>i,toc:()=>c});const i=JSON.parse('{"id":"configuration/security-provider","title":"Security Provider Configuration","description":"Capture contextual security information for each audit event","source":"@site/docs/auditor/configuration/security-provider.md","sourceDirName":"configuration","slug":"/configuration/security-provider","permalink":"/auditor-docs/auditor/configuration/security-provider","draft":false,"unlisted":false,"tags":[],"version":"current","frontMatter":{},"sidebar":"auditorSidebar","previous":{"title":"User Provider Configuration","permalink":"/auditor-docs/auditor/configuration/user-provider"},"next":{"title":"Role Checker Configuration","permalink":"/auditor-docs/auditor/configuration/role-checker"}}');var t=r(74848),s=r(28453);const a={},l="Security Provider Configuration",d={},c=[{value:"\ud83d\udd0d Overview",id:"-overview",level:2},{value:"\ud83d\ude80 Setting Up a Security Provider",id:"-setting-up-a-security-provider",level:2},{value:"Basic Example",id:"basic-example",level:3},{value:"Complete Symfony Example",id:"complete-symfony-example",level:3},{value:"\ud83d\udccb Return Value Structure",id:"-return-value-structure",level:2},{value:"\ud83c\udf10 Handling Different Contexts",id:"-handling-different-contexts",level:2},{value:"Web Requests",id:"web-requests",level:3},{value:"Behind a Proxy",id:"behind-a-proxy",level:3},{value:"CLI Commands",id:"cli-commands",level:3},{value:"API Requests",id:"api-requests",level:3},{value:"\ud83d\udd0d Accessing Security Info from Audit Entries",id:"-accessing-security-info-from-audit-entries",level:2},{value:"\ud83c\udf10 IP Address Format",id:"-ip-address-format",level:2},{value:"\u2705 Best Practices",id:"-best-practices",level:2},{value:"Related",id:"related",level:2}];function o(e){const n={a:"a",blockquote:"blockquote",code:"code",div:"div",h1:"h1",h2:"h2",h3:"h3",header:"header",hr:"hr",li:"li",ol:"ol",p:"p",path:"path",pre:"pre",strong:"strong",svg:"svg",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,s.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(n.header,{children:(0,t.jsx)(n.h1,{id:"security-provider-configuration",children:"Security Provider Configuration"})}),"\n",(0,t.jsxs)(n.blockquote,{children:["\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Capture contextual security information for each audit event"})}),"\n"]}),"\n",(0,t.jsx)(n.p,{children:"The security provider captures additional contextual information about each audit event, such as the client IP address and firewall name."}),"\n",(0,t.jsx)(n.h2,{id:"-overview",children:"\ud83d\udd0d Overview"}),"\n",(0,t.jsx)(n.p,{children:"When an audit entry is created, the security provider can supply:"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"ip"})," - The client's IP address"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"blame_user_fqdn"})," - The fully qualified class name of the user"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"blame_user_firewall"})," - The Symfony firewall name (if applicable)"]}),"\n"]}),"\n",(0,t.jsx)(n.h2,{id:"-setting-up-a-security-provider",children:"\ud83d\ude80 Setting Up a Security Provider"}),"\n",(0,t.jsx)(n.h3,{id:"basic-example",children:"Basic Example"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-php",children:"<?php\n\nuse DH\\Auditor\\Configuration;\n\n$configuration = new Configuration(['enabled' => true]);\n\n$configuration->setSecurityProvider(function (): array {\n    return [\n        'client_ip' => $_SERVER['REMOTE_ADDR'] ?? null,\n        'user_fqdn' => null,\n        'user_firewall' => null,\n    ];\n});\n"})}),"\n",(0,t.jsx)(n.h3,{id:"complete-symfony-example",children:"Complete Symfony Example"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-php",children:"<?php\n\nuse DH\\Auditor\\Configuration;\nuse Symfony\\Component\\HttpFoundation\\RequestStack;\nuse Symfony\\Component\\Security\\Core\\Authentication\\Token\\Storage\\TokenStorageInterface;\nuse Symfony\\Bundle\\SecurityBundle\\Security\\FirewallMap;\n\n$configuration->setSecurityProvider(\n    function () use ($requestStack, $tokenStorage, $firewallMap): array {\n        $request = $requestStack->getCurrentRequest();\n        $token = $tokenStorage->getToken();\n        \n        return [\n            'client_ip' => $request?->getClientIp(),\n            'user_fqdn' => $token?->getUser()?::class,\n            'user_firewall' => $this->getFirewallName($request, $firewallMap),\n        ];\n    }\n);\n\n// Helper method to get firewall name\nfunction getFirewallName(?Request $request, FirewallMap $firewallMap): ?string\n{\n    if (null === $request) {\n        return null;\n    }\n    \n    $firewallConfig = $firewallMap->getFirewallConfig($request);\n    \n    return $firewallConfig?->getName();\n}\n"})}),"\n",(0,t.jsx)(n.h2,{id:"-return-value-structure",children:"\ud83d\udccb Return Value Structure"}),"\n",(0,t.jsx)(n.p,{children:"The security provider must return an array with these keys:"}),"\n",(0,t.jsxs)(n.table,{children:[(0,t.jsx)(n.thead,{children:(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.th,{children:"Key"}),(0,t.jsx)(n.th,{children:"Type"}),(0,t.jsx)(n.th,{children:"Description"})]})}),(0,t.jsxs)(n.tbody,{children:[(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"client_ip"})}),(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"string|null"})}),(0,t.jsx)(n.td,{children:"The IP address of the client making the request"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"user_fqdn"})}),(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"string|null"})}),(0,t.jsx)(n.td,{children:"The fully qualified class name of the user object"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"user_firewall"})}),(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"string|null"})}),(0,t.jsx)(n.td,{children:"The name of the security firewall used"})]})]})]}),"\n",(0,t.jsx)(n.h2,{id:"-handling-different-contexts",children:"\ud83c\udf10 Handling Different Contexts"}),"\n",(0,t.jsx)(n.h3,{id:"web-requests",children:"Web Requests"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-php",children:"$configuration->setSecurityProvider(function () use ($requestStack): array {\n    $request = $requestStack->getCurrentRequest();\n    \n    return [\n        'client_ip' => $request?->getClientIp(),\n        'user_fqdn' => $this->security->getUser()?::class,\n        'user_firewall' => $this->getFirewallName($request),\n    ];\n});\n"})}),"\n",(0,t.jsx)(n.h3,{id:"behind-a-proxy",children:"Behind a Proxy"}),"\n",(0,t.jsxs)(n.div,{className:"markdown-alert markdown-alert-tip",dir:"auto",children:["\n",(0,t.jsxs)(n.p,{className:"markdown-alert-title",dir:"auto",children:[(0,t.jsx)(n.svg,{className:"octicon",viewBox:"0 0 16 16",width:"16",height:"16","aria-hidden":"true",children:(0,t.jsx)(n.path,{d:"M8 1.5c-2.363 0-4 1.69-4 3.75 0 .984.424 1.625.984 2.304l.214.253c.223.264.47.556.673.848.284.411.537.896.621 1.49a.75.75 0 0 1-1.484.211c-.04-.282-.163-.547-.37-.847a8.456 8.456 0 0 0-.542-.68c-.084-.1-.173-.205-.268-.32C3.201 7.75 2.5 6.766 2.5 5.25 2.5 2.31 4.863 0 8 0s5.5 2.31 5.5 5.25c0 1.516-.701 2.5-1.328 3.259-.095.115-.184.22-.268.319-.207.245-.383.453-.541.681-.208.3-.33.565-.37.847a.751.751 0 0 1-1.485-.212c.084-.593.337-1.078.621-1.489.203-.292.45-.584.673-.848.075-.088.147-.173.213-.253.561-.679.985-1.32.985-2.304 0-2.06-1.637-3.75-4-3.75ZM5.75 12h4.5a.75.75 0 0 1 0 1.5h-4.5a.75.75 0 0 1 0-1.5ZM6 15.25a.75.75 0 0 1 .75-.75h2.5a.75.75 0 0 1 0 1.5h-2.5a.75.75 0 0 1-.75-.75Z"})}),"TIP"]}),"\n",(0,t.jsxs)(n.p,{children:["When behind a load balancer or reverse proxy, ensure trusted proxies are configured in Symfony. The ",(0,t.jsx)(n.code,{children:"getClientIp()"})," method will automatically handle ",(0,t.jsx)(n.code,{children:"X-Forwarded-For"}),"."]}),"\n"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-php",children:"$configuration->setSecurityProvider(function () use ($requestStack): array {\n    $request = $requestStack->getCurrentRequest();\n    \n    // Ensure trusted proxies are configured in Symfony\n    // The getClientIp() method will automatically handle X-Forwarded-For\n    $clientIp = $request?->getClientIp();\n    \n    return [\n        'client_ip' => $clientIp,\n        'user_fqdn' => null,\n        'user_firewall' => null,\n    ];\n});\n"})}),"\n",(0,t.jsx)(n.h3,{id:"cli-commands",children:"CLI Commands"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-php",children:"$configuration->setSecurityProvider(function (): array {\n    if (PHP_SAPI === 'cli') {\n        return [\n            'client_ip' => gethostbyname(gethostname()) ?: '127.0.0.1',\n            'user_fqdn' => 'CLI',\n            'user_firewall' => null,\n        ];\n    }\n    \n    // Regular web handling...\n    return [\n        'client_ip' => $_SERVER['REMOTE_ADDR'] ?? null,\n        'user_fqdn' => null,\n        'user_firewall' => null,\n    ];\n});\n"})}),"\n",(0,t.jsx)(n.h3,{id:"api-requests",children:"API Requests"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-php",children:"$configuration->setSecurityProvider(function () use ($requestStack): array {\n    $request = $requestStack->getCurrentRequest();\n    \n    // Check if this is an API request\n    $isApi = str_starts_with($request?->getPathInfo() ?? '', '/api');\n    \n    return [\n        'client_ip' => $request?->getClientIp(),\n        'user_fqdn' => $this->security->getUser()?::class,\n        'user_firewall' => $isApi ? 'api' : 'main',\n    ];\n});\n"})}),"\n",(0,t.jsx)(n.h2,{id:"-accessing-security-info-from-audit-entries",children:"\ud83d\udd0d Accessing Security Info from Audit Entries"}),"\n",(0,t.jsx)(n.p,{children:"When reading audit entries:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-php",children:'<?php\n\n$reader = new Reader($provider);\n$audits = $reader->createQuery(Post::class)->execute();\n\nforeach ($audits as $entry) {\n    echo "IP Address: " . $entry->getIp();\n    echo "User Class: " . $entry->getUserFqdn();\n    echo "Firewall: " . $entry->getUserFirewall();\n}\n'})}),"\n",(0,t.jsx)(n.h2,{id:"-ip-address-format",children:"\ud83c\udf10 IP Address Format"}),"\n",(0,t.jsxs)(n.p,{children:["The ",(0,t.jsx)(n.code,{children:"ip"})," column supports both IPv4 and IPv6 addresses (max 45 characters):"]}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["IPv4: ",(0,t.jsx)(n.code,{children:"192.168.1.1"})]}),"\n",(0,t.jsxs)(n.li,{children:["IPv6: ",(0,t.jsx)(n.code,{children:"2001:0db8:85a3:0000:0000:8a2e:0370:7334"})]}),"\n"]}),"\n",(0,t.jsx)(n.h2,{id:"-best-practices",children:"\u2705 Best Practices"}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Always handle null request"})," - The request may not be available (CLI, async jobs)"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Configure trusted proxies"})," - When behind a reverse proxy"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Return consistent data types"})," - Always return an array with all three keys"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Consider privacy regulations"})," - IP logging may be subject to GDPR or similar laws"]}),"\n"]}),"\n",(0,t.jsxs)(n.div,{className:"markdown-alert markdown-alert-note",dir:"auto",children:["\n",(0,t.jsxs)(n.p,{className:"markdown-alert-title",dir:"auto",children:[(0,t.jsx)(n.svg,{className:"octicon",viewBox:"0 0 16 16",width:"16",height:"16","aria-hidden":"true",children:(0,t.jsx)(n.path,{d:"M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8Zm8-6.5a6.5 6.5 0 1 0 0 13 6.5 6.5 0 0 0 0-13ZM6.5 7.75A.75.75 0 0 1 7.25 7h1a.75.75 0 0 1 .75.75v2.75h.25a.75.75 0 0 1 0 1.5h-2a.75.75 0 0 1 0-1.5h.25v-2h-.25a.75.75 0 0 1-.75-.75ZM8 6a1 1 0 1 1 0-2 1 1 0 0 1 0 2Z"})}),"NOTE"]}),"\n",(0,t.jsx)(n.p,{children:"Remember to comply with privacy regulations when storing IP addresses. Consider implementing data retention policies."}),"\n"]}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h2,{id:"related",children:"Related"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["\ud83d\udc64 ",(0,t.jsx)(n.a,{href:"/auditor-docs/auditor/configuration/user-provider",children:"User Provider Configuration"})]}),"\n",(0,t.jsxs)(n.li,{children:["\ud83d\udee1\ufe0f ",(0,t.jsx)(n.a,{href:"/auditor-docs/auditor/configuration/role-checker",children:"Role Checker Configuration"})]}),"\n"]})]})}function u(e={}){const{wrapper:n}={...(0,s.R)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(o,{...e})}):o(e)}},28453(e,n,r){r.d(n,{R:()=>a,x:()=>l});var i=r(96540);const t={},s=i.createContext(t);function a(e){const n=i.useContext(s);return i.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:a(e.components),i.createElement(s.Provider,{value:n},e.children)}}}]);