"use strict";(self.webpackChunkauditor_docs=self.webpackChunkauditor_docs||[]).push([[3327],{829(e,n,i){i.r(n),i.d(n,{assets:()=>a,contentTitle:()=>c,default:()=>u,frontMatter:()=>o,metadata:()=>r,toc:()=>l});const r=JSON.parse('{"id":"configuration/role-checker","title":"Role Checker Configuration","description":"Control access to audit logs with fine-grained permissions","source":"@site/docs/auditor/configuration/role-checker.md","sourceDirName":"configuration","slug":"/configuration/role-checker","permalink":"/auditor-docs/auditor/configuration/role-checker","draft":false,"unlisted":false,"tags":[],"version":"current","frontMatter":{},"sidebar":"auditorSidebar","previous":{"title":"Security Provider Configuration","permalink":"/auditor-docs/auditor/configuration/security-provider"},"next":{"title":"DoctrineProvider","permalink":"/auditor-docs/auditor/providers/doctrine/"}}');var t=i(74848),s=i(28453);const o={},c="Role Checker Configuration",a={},l=[{value:"\ud83d\udd0d Overview",id:"-overview",level:2},{value:"\ud83d\ude80 Setting Up a Role Checker",id:"-setting-up-a-role-checker",level:2},{value:"Basic Example",id:"basic-example",level:3},{value:"Symfony Security Integration",id:"symfony-security-integration",level:3},{value:"\ud83d\udccb Parameters",id:"-parameters",level:2},{value:"Available Scopes",id:"available-scopes",level:3},{value:"\ud83c\udff7\ufe0f Using Entity-Level Security Attributes",id:"\ufe0f-using-entity-level-security-attributes",level:2},{value:"\ud83e\udde9 Complex Authorization Logic",id:"-complex-authorization-logic",level:2},{value:"Per-Entity Custom Rules",id:"per-entity-custom-rules",level:3},{value:"Time-Based Restrictions",id:"time-based-restrictions",level:3},{value:"\u26a0\ufe0f Error Handling",id:"\ufe0f-error-handling",level:2},{value:"\ud83d\udeab No Role Checker",id:"-no-role-checker",level:2},{value:"\u2705 Best Practices",id:"-best-practices",level:2},{value:"Related",id:"related",level:2}];function d(e){const n={a:"a",blockquote:"blockquote",code:"code",div:"div",h1:"h1",h2:"h2",h3:"h3",header:"header",hr:"hr",li:"li",ol:"ol",p:"p",path:"path",pre:"pre",strong:"strong",svg:"svg",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,s.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(n.header,{children:(0,t.jsx)(n.h1,{id:"role-checker-configuration",children:"Role Checker Configuration"})}),"\n",(0,t.jsxs)(n.blockquote,{children:["\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Control access to audit logs with fine-grained permissions"})}),"\n"]}),"\n",(0,t.jsx)(n.p,{children:"The role checker controls access to audit logs, allowing you to restrict who can view audits for specific entities."}),"\n",(0,t.jsx)(n.h2,{id:"-overview",children:"\ud83d\udd0d Overview"}),"\n",(0,t.jsx)(n.p,{children:"The role checker is a callback that is invoked when someone attempts to read audit entries. It determines whether the current user has permission to view the requested audits."}),"\n",(0,t.jsxs)(n.div,{className:"markdown-alert markdown-alert-warning",dir:"auto",children:["\n",(0,t.jsxs)(n.p,{className:"markdown-alert-title",dir:"auto",children:[(0,t.jsx)(n.svg,{className:"octicon",viewBox:"0 0 16 16",width:"16",height:"16","aria-hidden":"true",children:(0,t.jsx)(n.path,{d:"M6.457 1.047c.659-1.234 2.427-1.234 3.086 0l6.082 11.378A1.75 1.75 0 0 1 14.082 15H1.918a1.75 1.75 0 0 1-1.543-2.575Zm1.763.707a.25.25 0 0 0-.44 0L1.698 13.132a.25.25 0 0 0 .22.368h12.164a.25.25 0 0 0 .22-.368Zm.53 3.996v2.5a.75.75 0 0 1-1.5 0v-2.5a.75.75 0 0 1 1.5 0ZM9 11a1 1 0 1 1-2 0 1 1 0 0 1 2 0Z"})}),"WARNING"]}),"\n",(0,t.jsxs)(n.p,{children:["If access is denied, an ",(0,t.jsx)(n.code,{children:"AccessDeniedException"})," is thrown."]}),"\n"]}),"\n",(0,t.jsx)(n.h2,{id:"-setting-up-a-role-checker",children:"\ud83d\ude80 Setting Up a Role Checker"}),"\n",(0,t.jsx)(n.h3,{id:"basic-example",children:"Basic Example"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-php",children:"<?php\n\nuse DH\\Auditor\\Configuration;\n\n$configuration = new Configuration(['enabled' => true]);\n\n$configuration->setRoleChecker(function (string $entity, string $scope): bool {\n    // $entity - The fully qualified class name of the entity being audited\n    // $scope  - The action being performed (e.g., 'view')\n    \n    // Return true to allow access, false to deny\n    return true;\n});\n"})}),"\n",(0,t.jsx)(n.h3,{id:"symfony-security-integration",children:"Symfony Security Integration"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-php",children:"<?php\n\nuse App\\Entity\\User;\nuse App\\Entity\\Payment;\nuse Symfony\\Component\\Security\\Core\\Security;\n\n$configuration->setRoleChecker(function (string $entity, string $scope) use ($security): bool {\n    // Admins can view all audits\n    if ($security->isGranted('ROLE_ADMIN')) {\n        return true;\n    }\n    \n    // Managers can view most audits\n    if ($security->isGranted('ROLE_MANAGER')) {\n        // But not User audits (sensitive)\n        return $entity !== User::class;\n    }\n    \n    // Accountants can only view Payment audits\n    if ($security->isGranted('ROLE_ACCOUNTANT')) {\n        return $entity === Payment::class;\n    }\n    \n    // Deny all other users\n    return false;\n});\n"})}),"\n",(0,t.jsx)(n.h2,{id:"-parameters",children:"\ud83d\udccb Parameters"}),"\n",(0,t.jsx)(n.p,{children:"The role checker receives two parameters:"}),"\n",(0,t.jsxs)(n.table,{children:[(0,t.jsx)(n.thead,{children:(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.th,{children:"Parameter"}),(0,t.jsx)(n.th,{children:"Type"}),(0,t.jsx)(n.th,{children:"Description"})]})}),(0,t.jsxs)(n.tbody,{children:[(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"$entity"})}),(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"string"})}),(0,t.jsx)(n.td,{children:"The FQCN of the entity being queried"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"$scope"})}),(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"string"})}),(0,t.jsxs)(n.td,{children:["The action scope (currently only ",(0,t.jsx)(n.code,{children:"'view'"}),")"]})]})]})]}),"\n",(0,t.jsx)(n.h3,{id:"available-scopes",children:"Available Scopes"}),"\n",(0,t.jsxs)(n.table,{children:[(0,t.jsx)(n.thead,{children:(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.th,{children:"Scope"}),(0,t.jsx)(n.th,{children:"Constant"}),(0,t.jsx)(n.th,{children:"Description"})]})}),(0,t.jsx)(n.tbody,{children:(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"view"})}),(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"Security::VIEW_SCOPE"})}),(0,t.jsx)(n.td,{children:"Viewing audit entries"})]})})]}),"\n",(0,t.jsx)(n.h2,{id:"\ufe0f-using-entity-level-security-attributes",children:"\ud83c\udff7\ufe0f Using Entity-Level Security Attributes"}),"\n",(0,t.jsxs)(n.p,{children:["You can also define view permissions directly on entities using the ",(0,t.jsx)(n.code,{children:"#[Security]"})," attribute:"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-php",children:"<?php\n\nuse DH\\Auditor\\Provider\\Doctrine\\Auditing\\Annotation\\Auditable;\nuse DH\\Auditor\\Provider\\Doctrine\\Auditing\\Annotation\\Security;\nuse Doctrine\\ORM\\Mapping as ORM;\n\n#[ORM\\Entity]\n#[Auditable]\n#[Security(view: ['ROLE_ADMIN', 'ROLE_AUDIT_VIEWER'])]\nclass SensitiveEntity\n{\n    // ...\n}\n"})}),"\n",(0,t.jsx)(n.p,{children:"The role checker should then verify these roles:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-php",children:"<?php\n\n$configuration->setRoleChecker(function (string $entity, string $scope) use ($security, $provider): bool {\n    // Get entity configuration (including security roles from attributes)\n    $configuration = $provider->getConfiguration();\n    $entities = $configuration->getEntities();\n    \n    if (!isset($entities[$entity]['roles'][$scope])) {\n        // No specific roles defined, allow access\n        return true;\n    }\n    \n    $requiredRoles = $entities[$entity]['roles'][$scope];\n    \n    // Check if user has any of the required roles\n    foreach ($requiredRoles as $role) {\n        if ($security->isGranted($role)) {\n            return true;\n        }\n    }\n    \n    return false;\n});\n"})}),"\n",(0,t.jsx)(n.h2,{id:"-complex-authorization-logic",children:"\ud83e\udde9 Complex Authorization Logic"}),"\n",(0,t.jsx)(n.h3,{id:"per-entity-custom-rules",children:"Per-Entity Custom Rules"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-php",children:"<?php\n\n$configuration->setRoleChecker(function (string $entity, string $scope) use ($security, $em): bool {\n    $user = $security->getUser();\n    \n    if (null === $user) {\n        return false;\n    }\n    \n    // Check ownership-based access for certain entities\n    switch ($entity) {\n        case Order::class:\n            // Users can view their own orders' audits\n            // Admins can view all\n            if ($security->isGranted('ROLE_ADMIN')) {\n                return true;\n            }\n            \n            // This would need additional context about which order is being queried\n            return $security->isGranted('ROLE_ORDER_AUDITOR');\n            \n        case User::class:\n            // Only super admins can view user audits\n            return $security->isGranted('ROLE_SUPER_ADMIN');\n            \n        default:\n            // Default: allow managers and above\n            return $security->isGranted('ROLE_MANAGER');\n    }\n});\n"})}),"\n",(0,t.jsx)(n.h3,{id:"time-based-restrictions",children:"Time-Based Restrictions"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-php",children:"<?php\n\n$configuration->setRoleChecker(function (string $entity, string $scope) use ($security): bool {\n    // Only allow audit viewing during business hours for non-admins\n    if (!$security->isGranted('ROLE_ADMIN')) {\n        $hour = (int) date('H');\n        if ($hour < 9 || $hour > 17) {\n            return false;\n        }\n    }\n    \n    return $security->isGranted('ROLE_AUDITOR');\n});\n"})}),"\n",(0,t.jsx)(n.h2,{id:"\ufe0f-error-handling",children:"\u26a0\ufe0f Error Handling"}),"\n",(0,t.jsxs)(n.p,{children:["When the role checker returns ",(0,t.jsx)(n.code,{children:"false"}),", an ",(0,t.jsx)(n.code,{children:"AccessDeniedException"})," is thrown:"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-php",children:"<?php\n\nuse DH\\Auditor\\Exception\\AccessDeniedException;\nuse DH\\Auditor\\Provider\\Doctrine\\Persistence\\Reader\\Reader;\n\n$reader = new Reader($provider);\n\ntry {\n    $query = $reader->createQuery(SensitiveEntity::class);\n    $audits = $query->execute();\n} catch (AccessDeniedException $e) {\n    // Handle access denied\n    // $e->getMessage() contains details about the denial\n}\n"})}),"\n",(0,t.jsx)(n.h2,{id:"-no-role-checker",children:"\ud83d\udeab No Role Checker"}),"\n",(0,t.jsxs)(n.div,{className:"markdown-alert markdown-alert-caution",dir:"auto",children:["\n",(0,t.jsxs)(n.p,{className:"markdown-alert-title",dir:"auto",children:[(0,t.jsx)(n.svg,{className:"octicon",viewBox:"0 0 16 16",width:"16",height:"16","aria-hidden":"true",children:(0,t.jsx)(n.path,{d:"M4.47.22A.749.749 0 0 1 5 0h6c.199 0 .389.079.53.22l4.25 4.25c.141.14.22.331.22.53v6a.749.749 0 0 1-.22.53l-4.25 4.25A.749.749 0 0 1 11 16H5a.749.749 0 0 1-.53-.22L.22 11.53A.749.749 0 0 1 0 11V5c0-.199.079-.389.22-.53Zm.84 1.28L1.5 5.31v5.38l3.81 3.81h5.38l3.81-3.81V5.31L10.69 1.5ZM8 4a.75.75 0 0 1 .75.75v3.5a.75.75 0 0 1-1.5 0v-3.5A.75.75 0 0 1 8 4Zm0 8a1 1 0 1 1 0-2 1 1 0 0 1 0 2Z"})}),"CAUTION"]}),"\n",(0,t.jsxs)(n.p,{children:["If no role checker is configured (",(0,t.jsx)(n.code,{children:"null"}),"), all users have access to all audit logs. This is not recommended for production environments."]}),"\n"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-php",children:"// This allows everyone to view all audits\n$configuration = new Configuration([\n    'role_checker' => null,  // No access control\n]);\n"})}),"\n",(0,t.jsx)(n.h2,{id:"-best-practices",children:"\u2705 Best Practices"}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Always implement a role checker in production"})," - Don't leave audits open to everyone"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Log access attempts"})," - Consider logging who accesses audit data"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Use the principle of least privilege"})," - Only grant access where necessary"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Consider data sensitivity"})," - Some entities may contain sensitive information"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Test your rules"})," - Ensure your authorization logic works as expected"]}),"\n"]}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h2,{id:"related",children:"Related"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["\ud83c\udff7\ufe0f ",(0,t.jsx)(n.a,{href:"/auditor-docs/auditor/providers/doctrine/attributes#security",children:"Security Attribute"})]}),"\n",(0,t.jsxs)(n.li,{children:["\ud83d\udc64 ",(0,t.jsx)(n.a,{href:"/auditor-docs/auditor/configuration/user-provider",children:"User Provider Configuration"})]}),"\n",(0,t.jsxs)(n.li,{children:["\ud83d\udd10 ",(0,t.jsx)(n.a,{href:"/auditor-docs/auditor/configuration/security-provider",children:"Security Provider Configuration"})]}),"\n"]})]})}function u(e={}){const{wrapper:n}={...(0,s.R)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(d,{...e})}):d(e)}},28453(e,n,i){i.d(n,{R:()=>o,x:()=>c});var r=i(96540);const t={},s=r.createContext(t);function o(e){const n=r.useContext(s);return r.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function c(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:o(e.components),r.createElement(s.Provider,{value:n},e.children)}}}]);