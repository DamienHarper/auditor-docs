"use strict";(self.webpackChunkauditor_docs=self.webpackChunkauditor_docs||[]).push([[5273],{95241(e,n,t){t.r(n),t.d(n,{assets:()=>d,contentTitle:()=>o,default:()=>u,frontMatter:()=>s,metadata:()=>i,toc:()=>c});const i=JSON.parse('{"id":"configuration/storage","title":"Storage configuration","description":"Storage configuration is achieved using the YAML configuration file described in the General configuration section.","source":"@site/auditor-bundle_versioned_docs/version-6.x/configuration/storage.md","sourceDirName":"configuration","slug":"/configuration/storage","permalink":"/auditor-docs/auditor-bundle/6.x/configuration/storage","draft":false,"unlisted":false,"tags":[],"version":"6.x","frontMatter":{"title":"Storage configuration"},"sidebar":"docs","previous":{"title":"Configuration reference","permalink":"/auditor-docs/auditor-bundle/6.x/configuration/reference"},"next":{"title":"Contributing","permalink":"/auditor-docs/auditor-bundle/6.x/contributing"}}');var r=t(74848),a=t(28453);const s={title:"Storage configuration"},o=void 0,d={},c=[{value:"Audit tables naming format",id:"audit-tables-naming-format",level:2},{value:"Storage services",id:"storage-services",level:2},{value:"Storage mapper",id:"storage-mapper",level:2},{value:"Example",id:"example",level:3}];function l(e){const n={a:"a",admonition:"admonition",code:"code",h2:"h2",h3:"h3",li:"li",p:"p",pre:"pre",ul:"ul",...(0,a.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsxs)(n.p,{children:["Storage configuration is achieved using the YAML configuration file described in the ",(0,r.jsx)(n.a,{href:"general.html",children:"General"})," configuration section."]}),"\n",(0,r.jsx)(n.h2,{id:"audit-tables-naming-format",children:"Audit tables naming format"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.code,{children:"doctrine-provider"})}),"\n",(0,r.jsxs)(n.p,{children:["Audit table names are composed of a prefix, a name and a suffix.\nBy default, the prefix is empty and the suffix is ",(0,r.jsx)(n.code,{children:"_audit"}),". Though, they can be customized."]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:"dh_auditor:\n    providers:\n        doctrine:\n            table_prefix: ~\n            table_suffix: '_audit'\n"})}),"\n",(0,r.jsx)(n.h2,{id:"storage-services",children:"Storage services"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.code,{children:"doctrine-provider"})}),"\n",(0,r.jsxs)(n.p,{children:["By default, ",(0,r.jsx)(n.code,{children:"auditor-bundle"})," stores audits using Doctrine's default entity manager ",(0,r.jsx)(n.code,{children:"doctrine.orm.default_entity_manager"}),".\nHowever, ",(0,r.jsx)(n.code,{children:"auditor-bundle"})," lets you store audits using several entity managers by adding them to the ",(0,r.jsx)(n.code,{children:"storage_services"})," list."]}),"\n",(0,r.jsx)(n.admonition,{title:"Note",type:"info",children:(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"if one of the current audited entity operation fails, audit data is still persisted\nto the secondary database which is very bad (reference to entity data which doesn't exist\nin the main database or reference to entity data in main database which doesn't reflect changes\nlogged in audit data)"}),"\n",(0,r.jsx)(n.li,{children:"if one of the current audited entity operation succeed, audit data persistence in the\nsecondary database still can fail which is bad but can be acceptable in some use cases\n(depending on how critical audit data is for your application/business, missing audit data\ncould be acceptable)"}),"\n"]})}),"\n",(0,r.jsx)(n.h2,{id:"storage-mapper",children:"Storage mapper"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.code,{children:"doctrine-provider"})}),"\n",(0,r.jsxs)(n.p,{children:["A storage mapper is a ",(0,r.jsx)(n.code,{children:"callable"})," that routes audit events to storage services.\nIt's up to the storage mapper to choose which storage service should be used to persist audits logs for a given entity."]}),"\n",(0,r.jsxs)(n.p,{children:["A storage mapper expects 2 parameters as arguments and returns an object implementing ",(0,r.jsx)(n.code,{children:"StorageServiceInterface"})]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["an entity FQCN (",(0,r.jsx)(n.code,{children:"string"}),")"]}),"\n",(0,r.jsxs)(n.li,{children:["the list of registered storage services indexed by name (",(0,r.jsx)(n.code,{children:"array"}),")"]}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"example",children:"Example"}),"\n",(0,r.jsxs)(n.p,{children:["Below is an example of a storage mapper ",(0,r.jsx)(n.code,{children:"MyStorageMapper"})," routing audit logs from ",(0,r.jsx)(n.code,{children:"MyEntity1"})," and ",(0,r.jsx)(n.code,{children:"MyEntity2"}),"\nto a particular storage service, all other audit logs are persisted by another storage service."]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"<?php\nnamespace App;\n\nuse App\\Entity\\MyEntity1; \nuse App\\Entity\\MyEntity2; \nuse App\\Entity\\MyEntity3; \nuse DH\\Auditor\\Provider\\Service\\StorageServiceInterface;\n\n/**\n * MyStorageMapper is an invokable service\n */\nclass MyStorageMapper\n{\n    // the service expects 2 parameters and should return an object \n    // implementing StorageServiceInterface\n    public function __invoke(string $entity, array $storageServices): StorageServiceInterface {\n        return \\in_array($entity, [MyEntity1::class, MyEntity2::class], true) ? $storageServices['db1'] : $storageServices['db2'];\n    }\n}\n"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:"# config/packages/dh_auditor.yaml\ndh_auditor:\n    providers:\n        doctrine:\n            # Invokable service that maps audit events to storage services\n            storage_mapper: my_storage_mapper.map_storage\n"})})]})}function u(e={}){const{wrapper:n}={...(0,a.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(l,{...e})}):l(e)}},28453(e,n,t){t.d(n,{R:()=>s,x:()=>o});var i=t(96540);const r={},a=i.createContext(r);function s(e){const n=i.useContext(a);return i.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:s(e.components),i.createElement(a.Provider,{value:n},e.children)}}}]);