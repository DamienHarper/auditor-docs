"use strict";(self.webpackChunkauditor_docs=self.webpackChunkauditor_docs||[]).push([[73],{1641(e,n,r){r.r(n),r.d(n,{assets:()=>l,contentTitle:()=>d,default:()=>u,frontMatter:()=>s,metadata:()=>i,toc:()=>c});const i=JSON.parse('{"id":"usage/querying","title":"Querying audits","description":"auditor provides both a query object and a reader to query the full history of any audited entity and even paginate results.","source":"@site/auditor-bundle_versioned_docs/version-6.x/usage/querying.md","sourceDirName":"usage","slug":"/usage/querying","permalink":"/auditor-docs/auditor-bundle/6.x/usage/querying","draft":false,"unlisted":false,"tags":[],"version":"6.x","frontMatter":{"title":"Querying audits"},"sidebar":"docs","previous":{"title":"Cleaning up audit entries","permalink":"/auditor-docs/auditor-bundle/6.x/usage/maintenance"},"next":{"title":"Schema","permalink":"/auditor-docs/auditor-bundle/6.x/usage/schema-manipulation"}}');var t=r(4848),a=r(8453);const s={title:"Querying audits"},d=void 0,l={},c=[{value:"Reader",id:"reader",level:2},{value:"Preparing a query",id:"preparing-a-query",level:3},{value:"Retrieving audits",id:"retrieving-audits",level:3},{value:"Query",id:"query",level:2},{value:"Filters",id:"filters",level:3},{value:"Standard filter",id:"standard-filter",level:4},{value:"Range filter",id:"range-filter",level:4},{value:"Date range filter",id:"date-range-filter",level:4},{value:"Multiple filters",id:"multiple-filters",level:4},{value:"Ordering",id:"ordering",level:3},{value:"Limit &amp; offset",id:"limit--offset",level:3},{value:"Executing",id:"executing",level:3},{value:"Counting",id:"counting",level:3}];function o(e){const n={a:"a",br:"br",code:"code",h2:"h2",h3:"h3",h4:"h4",hr:"hr",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,a.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.code,{children:"auditor"})," provides both a ",(0,t.jsx)(n.a,{href:"querying.html#query",children:"query"})," object and a ",(0,t.jsx)(n.a,{href:"querying.html#reader",children:"reader"})," to query the full history of any audited entity and even paginate results."]}),"\n",(0,t.jsx)(n.h2,{id:"reader",children:"Reader"}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.code,{children:"doctrine-provider"})}),"\n",(0,t.jsxs)(n.p,{children:["The ",(0,t.jsx)(n.code,{children:"Reader"})," makes it easy to query and retrieve audits from the storage.\nIt heavily relies on the ",(0,t.jsx)(n.a,{href:"querying.html#query",children:(0,t.jsx)(n.code,{children:"Query"})})," object and takes care of checking roles and auditable state of a given entity."]}),"\n",(0,t.jsxs)(n.p,{children:["The ",(0,t.jsx)(n.code,{children:"Reader"})," takes a provider as the only parameter of its constructor."]}),"\n",(0,t.jsx)(n.p,{children:"Example:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-php",children:"$reader = new Reader($provider);\n"})}),"\n",(0,t.jsx)(n.h3,{id:"preparing-a-query",children:"Preparing a query"}),"\n",(0,t.jsxs)(n.p,{children:["Querying the audits is done by preparing a query and running it.",(0,t.jsx)(n.br,{}),"\n","Creating a query is done by calling ",(0,t.jsx)(n.code,{children:"Reader::createQuery(string $entity, array $options = []): Query"})]}),"\n",(0,t.jsx)(n.p,{children:"Example:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-php",children:"$reader = new Reader($provider);\n\n// creates a query on Author audits without any option set\n// this would return all the author audits \n$query = $reader->createQuery(Author::class);\n"})}),"\n",(0,t.jsxs)(n.p,{children:["It is possible to specify filters to be applied to the created query using the ",(0,t.jsx)(n.code,{children:"$options"})," parameter."]}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"type"})," add a filter on the audit type (",(0,t.jsx)(n.code,{children:"INSERT"}),", ",(0,t.jsx)(n.code,{children:"UPDATE"}),", ",(0,t.jsx)(n.code,{children:"REMOVE"}),", ",(0,t.jsx)(n.code,{children:"ASSOCIATE"}),", ",(0,t.jsx)(n.code,{children:"DISSOCIATE"}),")"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"object_id"})," add a filter on the audited element ID"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"transaction_hash"})," add a filter on the transaction hash"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"page"})," will select the given page of entries"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"page_size"})," defines the page size"]}),"\n"]}),"\n",(0,t.jsx)(n.p,{children:"Examples:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-php",children:"$reader = new Reader($provider);\n\n// creates a query on Author audits with a filter on the object ID\n// audits of the author which ID is not 5 will be filtered out. \n$query = $reader->createQuery(Author::class, [\n    'object_id' => 5,\n]);\n\n// the above code could also be written like this\nuse \\DH\\Auditor\\Provider\\Doctrine\\Persistence\\Reader\\Filter\\SimpleFilter;\n\n$query = $reader\n    ->createQuery(Author::class)\n    ->addFilter(new SimpleFilter(Query::OBJECT_ID, 5));\n;\n"})}),"\n",(0,t.jsx)(n.h3,{id:"retrieving-audits",children:"Retrieving audits"}),"\n",(0,t.jsx)(n.p,{children:"Once a query has been created and prepared, it has to be executed to retrieve audits."}),"\n",(0,t.jsx)(n.p,{children:"Example:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-php",children:"$reader = new Reader($provider);\n\n// creates a query on Author audits\n$query = $reader->createQuery(Author::class);\n\n// retrieves audit entries for Author entity\n/** @var DH\\Auditor\\Model\\Entry[] $audits */\n$audits = $query->execute();\n\n// retrieves audit entries for Author entity (oneliner)\n/** @var DH\\Auditor\\Model\\Entry[] $audits */\n$audits = $reader->createQuery(Author::class)->execute();\n"})}),"\n",(0,t.jsx)(n.p,{children:"Note\nRetrieving audits using the above method is scoped to a single entity.\nA transaction generally spans across multiple entities so retrieving audit entries belonging to a transaction\ncould be tough."}),"\n",(0,t.jsxs)(n.p,{children:["To make it easier, a dedicated method is available: ",(0,t.jsx)(n.code,{children:"Reader::getAuditsByTransactionHash(string $transactionHash): array"})]}),"\n",(0,t.jsx)(n.p,{children:"Example:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-php",children:"$reader = new Reader($provider);\n\n// retrieves audit entries across all entities for the given transaction hash: '123abc'\n/** @var DH\\Auditor\\Model\\Entry[] $audits */\n$audits = $reader->getAuditsByTransactionHash('123abc');\n"})}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h2,{id:"query",children:"Query"}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.code,{children:"doctrine-provider"})}),"\n",(0,t.jsxs)(n.p,{children:["The ",(0,t.jsx)(n.code,{children:"Query"})," object is a thin wrapper on top of Doctrine's ",(0,t.jsx)(n.code,{children:"Doctrine\\DBAL\\Query\\QueryBuilder"}),".\nIt allows to query and retrieve audits from the storage."]}),"\n",(0,t.jsxs)(n.p,{children:["The ",(0,t.jsx)(n.code,{children:"Query"})," object takes both a table name and a connection (Doctrine) as parameters of its constructor."]}),"\n",(0,t.jsx)(n.p,{children:"Example:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-php",children:"// create a Query object to query/retrieve data from `author_audit` table.\n$query = new Query('author_audit', $connection);\n"})}),"\n",(0,t.jsx)(n.h3,{id:"filters",children:"Filters"}),"\n",(0,t.jsxs)(n.p,{children:["By default, a query object will return ",(0,t.jsx)(n.strong,{children:"all"})," the audit entries of the related table when executed.\nThis can be a very expensive task (both time and memory consuming) and ultimately of little interest.\nBut of course, you can refine the query by adding filters."]}),"\n",(0,t.jsx)(n.p,{children:"There are three types of filters:"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"standard filter"}),"\n",(0,t.jsx)(n.li,{children:"range filter"}),"\n",(0,t.jsx)(n.li,{children:"date range filter"}),"\n"]}),"\n",(0,t.jsxs)(n.p,{children:["You can get the list of available filters by calling ",(0,t.jsx)(n.code,{children:"Query::getSupportedFilters()"})]}),"\n",(0,t.jsxs)(n.p,{children:["This method will return an array of available filters.\nThey also are available as constants of the ",(0,t.jsx)(n.code,{children:"Query"})," class."]}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"Query::TYPE"})," allows to filter by audit type (",(0,t.jsx)(n.code,{children:"INSERT"}),", ",(0,t.jsx)(n.code,{children:"UPDATE"}),", ",(0,t.jsx)(n.code,{children:"REMOVE"}),", ",(0,t.jsx)(n.code,{children:"ASSOCIATE"}),", ",(0,t.jsx)(n.code,{children:"DISSOCIATE"}),")"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"Query::CREATED_AT"})," allows to filter by audit creation date and time"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"Query::TRANSACTION_HASH"})," allows to filter by transaction hash"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"Query::OBJECT_ID"})," allows to filter by audited element ID"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"Query::USER_ID"})," allows to filter by user"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"Query::ID"})," allows to filter by audit ID"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"Query::DISCRIMINATOR"})," allows to filter by discriminator (cf. Doctrine inheritance)"]}),"\n"]}),"\n",(0,t.jsx)(n.h4,{id:"standard-filter",children:"Standard filter"}),"\n",(0,t.jsxs)(n.p,{children:["A standard filter is materialized by ",(0,t.jsx)(n.code,{children:"SimpleFilter"})," class."]}),"\n",(0,t.jsxs)(n.p,{children:["Since ",(0,t.jsx)(n.code,{children:"1.2.0"}),", method ",(0,t.jsx)(n.code,{children:"Query::addFilter(string $name, $value): self"})," is ",(0,t.jsx)(n.strong,{children:"deprecated"}),"\nin favor of ",(0,t.jsx)(n.code,{children:"Query::addFilter(FilterInterface $filter): self"})]}),"\n",(0,t.jsx)(n.p,{children:"Examples:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-php",children:"use DH\\Auditor\\Provider\\Doctrine\\Persistence\\Reader\\Filter\\SimpleFilter;\n\n// filtering audit entries whose transaction hash is exactly '123abc'\n$query = new Query('author_audit', $connection);\n$query->addFilter(new SimpleFilter(Query::TRANSACTION_HASH, '123abc'));\n\n// filtering audit entries whose transaction hash is either '123abc', '456def' or '789ghi'\n$query = new Query('author_audit', $connection);\n$query->addFilter(new SimpleFilter(Query::TRANSACTION_HASH, ['123abc', '456def', '789ghi']));\n"})}),"\n",(0,t.jsx)(n.h4,{id:"range-filter",children:"Range filter"}),"\n",(0,t.jsxs)(n.p,{children:["A range filter is materialized by ",(0,t.jsx)(n.code,{children:"RangeFilter"})," class."]}),"\n",(0,t.jsxs)(n.p,{children:["Since ",(0,t.jsx)(n.code,{children:"1.2.0"}),", method ",(0,t.jsx)(n.code,{children:"Query::addRangeFilter(string $name, $minValue = null, $maxValue = null): self"})," is ",(0,t.jsx)(n.strong,{children:"deprecated"}),"\nin favor of ",(0,t.jsx)(n.code,{children:"Query::addFilter(FilterInterface $filter): self"})]}),"\n",(0,t.jsxs)(n.p,{children:["Note\nBounds (",(0,t.jsx)("code",{children:"$minValue"})," and ",(0,t.jsx)("code",{children:"$maxValue"}),") can't be ",(0,t.jsx)("code",{children:"null"})," simultaneously."]}),"\n",(0,t.jsx)(n.p,{children:"Examples:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-php",children:"use DH\\Auditor\\Provider\\Doctrine\\Persistence\\Reader\\Filter\\RangeFilter;\n\n// filtering audit entries whose object ID (author ID) is >= 10\n$query = new Query('author_audit', $connection);\n$query->addFilter(new RangeFilter(Query::OBJECT_ID, 10));\n\n// filtering audit entries whose object ID (author ID) is <= 10\n$query = new Query('author_audit', $connection);\n$query->addFilter(new RangeFilter(Query::OBJECT_ID, null, 10));\n\n// filtering audit entries whose object ID (author ID) is >= 10 and <= 25\n$query = new Query('author_audit', $connection);\n$query->addFilter(new RangeFilter(Query::OBJECT_ID, 10, 25));\n"})}),"\n",(0,t.jsx)(n.h4,{id:"date-range-filter",children:"Date range filter"}),"\n",(0,t.jsxs)(n.p,{children:["A date range filter is materialized by ",(0,t.jsx)(n.code,{children:"DateRangeFilter"})," class."]}),"\n",(0,t.jsxs)(n.p,{children:["Since ",(0,t.jsx)(n.code,{children:"1.2.0"}),", method ",(0,t.jsx)(n.code,{children:"Query::addDateRangeFilter(string $name, ?DateTime $minValue = null, ?DateTime $maxValue = null): self"})," is ",(0,t.jsx)(n.strong,{children:"deprecated"}),"\nin favor of ",(0,t.jsx)(n.code,{children:"Query::addFilter(FilterInterface $filter): self"})]}),"\n",(0,t.jsxs)(n.p,{children:["Note\nBounds (",(0,t.jsx)("code",{children:"$minValue"})," and ",(0,t.jsx)("code",{children:"$maxValue"}),") can't be ",(0,t.jsx)("code",{children:"null"})," simultaneously."]}),"\n",(0,t.jsx)(n.p,{children:"Examples:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-php",children:"use DH\\Auditor\\Provider\\Doctrine\\Persistence\\Reader\\Filter\\DateRangeFilter;\n\n$min = DateTime::createFromFormat('Y-m-d', '2020-01-17');\n$max = DateTime::createFromFormat('Y-m-d', '2020-01-19');\n\n// filtering audit entries whose creation date is >= 2020-01-17\n$query = new Query('author_audit', $connection);\n$query->addFilter(new DateRangeFilter(Query::CREATED_AT, $min));        \n\n// filtering audit entries whose creation date is <= 2020-01-19\n$query = new Query('author_audit', $connection);\n$query->addFilter(new DateRangeFilter(Query::CREATED_AT, null, $max));  \n\n// filtering audit entries whose creation date is between 2020-01-17 and 2020-01-19\n$query = new Query('author_audit', $connection);\n$query->addFilter(new DateRangeFilter(Query::CREATED_AT, $min, $max));  \n"})}),"\n",(0,t.jsx)(n.h4,{id:"multiple-filters",children:"Multiple filters"}),"\n",(0,t.jsxs)(n.p,{children:["When adding multiple filters, they are combined with an ",(0,t.jsx)(n.code,{children:"and"})," logic."]}),"\n",(0,t.jsx)(n.h3,{id:"ordering",children:"Ordering"}),"\n",(0,t.jsxs)(n.p,{children:["Query results can be ordered by calling ",(0,t.jsx)(n.code,{children:"Query::addOrderBy(string $field, string $direction = 'DESC'): self"})]}),"\n",(0,t.jsx)(n.p,{children:"Example:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-php",children:"$query = new Query('author_audit', $connection);\n$query->addOrderBy(Query::CREATED_AT, 'ASC');\n\n$entries = $query->execute();   // entries are ordered by ascendant creation date/time \n"})}),"\n",(0,t.jsx)(n.h3,{id:"limit--offset",children:"Limit & offset"}),"\n",(0,t.jsxs)(n.p,{children:["It is possible to extract only a portion of the results at a specific offset by calling ",(0,t.jsx)(n.code,{children:"Query::limit(int $limit, int $offset = 0): self"})]}),"\n",(0,t.jsxs)(n.p,{children:["Note\n",(0,t.jsx)("code",{children:"$offset"})," starts at 0."]}),"\n",(0,t.jsx)(n.p,{children:"Example:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-php",children:"// only the first 10 results\n$query = new Query('author_audit', $connection);\n$query->limit(10);     \n\n// 10 results starting at the 6th result (from the 6th to 15th)\n$query = new Query('author_audit', $connection);\n$query->limit(10, 5);     \n"})}),"\n",(0,t.jsx)(n.h3,{id:"executing",children:"Executing"}),"\n",(0,t.jsxs)(n.p,{children:["Queries are executed by calling ",(0,t.jsx)(n.code,{children:"Query::execute(): array"})]}),"\n",(0,t.jsx)(n.p,{children:"Example:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-php",children:"// filtering audit entries whose transaction hash is exactly '123abc'\n$query = new Query('author_audit', $connection);\n$query->addFilter(Query::TRANSACTION_HASH, '123abc');\n\n$entries = $query->execute();   // $entries is populated \n"})}),"\n",(0,t.jsx)(n.h3,{id:"counting",children:"Counting"}),"\n",(0,t.jsxs)(n.p,{children:["It is possible to count results without retrieving them by calling ",(0,t.jsx)(n.code,{children:"Query::count(): int"})]}),"\n",(0,t.jsx)(n.p,{children:"Example:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-php",children:"$query = new Query('author_audit', $connection);\n$query->addFilter(Query::TRANSACTION_HASH, '123abc');\n\n$count = $query->count();   // $count holds the number of audit entries matching the applied filters\n"})})]})}function u(e={}){const{wrapper:n}={...(0,a.R)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(o,{...e})}):o(e)}},8453(e,n,r){r.d(n,{R:()=>s,x:()=>d});var i=r(6540);const t={},a=i.createContext(t);function s(e){const n=i.useContext(a);return i.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function d(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:s(e.components),i.createElement(a.Provider,{value:n},e.children)}}}]);