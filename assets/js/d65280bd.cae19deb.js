"use strict";(self.webpackChunkauditor_docs=self.webpackChunkauditor_docs||[]).push([[9934],{8264(e,n,t){t.r(n),t.d(n,{assets:()=>l,contentTitle:()=>o,default:()=>d,frontMatter:()=>c,metadata:()=>r,toc:()=>u});const r=JSON.parse('{"id":"customization/role-checker","title":"Role Checker","description":"Customize access control for the audit viewer","source":"@site/docs/auditor-bundle/customization/role-checker.md","sourceDirName":"customization","slug":"/customization/role-checker","permalink":"/auditor-docs/auditor-bundle/customization/role-checker","draft":false,"unlisted":false,"tags":[],"version":"current","frontMatter":{},"sidebar":"auditorBundleSidebar","previous":{"title":"Security Provider","permalink":"/auditor-docs/auditor-bundle/customization/security-provider"},"next":{"title":"Extra Data","permalink":"/auditor-docs/auditor-bundle/customization/extra-data"}}');var i=t(4848),s=t(8453);const c={},o="Role Checker",l={},u=[{value:"\ud83d\udcdd Interface",id:"-interface",level:2},{value:"\ud83d\udce6 Built-in Checker",id:"-built-in-checker",level:2},{value:"Default Behavior",id:"default-behavior",level:3},{value:"\u2699\ufe0f Configuring Roles",id:"\ufe0f-configuring-roles",level:2},{value:"Via YAML",id:"via-yaml",level:3},{value:"Via Attributes",id:"via-attributes",level:3},{value:"\ud83d\udd27 Creating a Custom Checker",id:"-creating-a-custom-checker",level:2},{value:"Basic Example",id:"basic-example",level:3},{value:"Registration",id:"registration",level:3},{value:"\ud83d\udcda Examples",id:"-examples",level:2},{value:"\ud83c\udfaf Entity-Specific Rules",id:"-entity-specific-rules",level:3},{value:"\ud83d\uddf3\ufe0f Using Symfony Voters",id:"\ufe0f-using-symfony-voters",level:3},{value:"\ud83d\udd17 External Authorization Service",id:"-external-authorization-service",level:3},{value:"\u23f0 Time-Based Access",id:"-time-based-access",level:3},{value:"\ud83d\ude80 Next Steps",id:"-next-steps",level:2}];function a(e){const n={a:"a",blockquote:"blockquote",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",hr:"hr",li:"li",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,s.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.header,{children:(0,i.jsx)(n.h1,{id:"role-checker",children:"Role Checker"})}),"\n",(0,i.jsxs)(n.blockquote,{children:["\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Customize access control for the audit viewer"})}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"A role checker determines if the current user can access audit logs for a specific entity."}),"\n",(0,i.jsx)(n.h2,{id:"-interface",children:"\ud83d\udcdd Interface"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-php",children:"namespace DH\\Auditor\\Security;\n\ninterface RoleCheckerInterface\n{\n    public function __invoke(string $entity, string $scope): bool;\n}\n"})}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Parameters:"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"$entity"}),": Entity FQCN (e.g., ",(0,i.jsx)(n.code,{children:"App\\Entity\\User"}),")"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"$scope"}),": Access type (currently only ",(0,i.jsx)(n.code,{children:"'view'"}),")"]}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Returns:"})," ",(0,i.jsx)(n.code,{children:"true"})," to grant access, ",(0,i.jsx)(n.code,{children:"false"})," to deny."]}),"\n",(0,i.jsx)(n.h2,{id:"-built-in-checker",children:"\ud83d\udce6 Built-in Checker"}),"\n",(0,i.jsxs)(n.p,{children:["The default ",(0,i.jsx)(n.code,{children:"DH\\AuditorBundle\\Security\\RoleChecker"}),":"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-php",children:"public function __invoke(string $entity, string $scope): bool\n{\n    $user = $this->provider->getAuditor()->getConfiguration()->getUserProvider()();\n\n    if (!$user instanceof UserInterface) {\n        return true;  // No user = grant access\n    }\n\n    $entities = $this->provider->getConfiguration()->getEntities();\n    $entityConfig = $entities[$entity] ?? null;\n    $roles = $entityConfig['roles'] ?? null;\n\n    if (null === $roles || !array_key_exists($scope, $roles)) {\n        return true;  // No roles configured = grant access\n    }\n\n    // Check if user has any of the required roles\n    return array_any($roles[$scope], fn($role) => \n        $this->authorizationChecker->isGranted($role)\n    );\n}\n"})}),"\n",(0,i.jsx)(n.h3,{id:"default-behavior",children:"Default Behavior"}),"\n",(0,i.jsxs)(n.table,{children:[(0,i.jsx)(n.thead,{children:(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.th,{children:"Scenario"}),(0,i.jsx)(n.th,{children:"Access"})]})}),(0,i.jsxs)(n.tbody,{children:[(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"No roles configured for entity"}),(0,i.jsx)(n.td,{children:"\u2705 Granted"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"No user authenticated"}),(0,i.jsx)(n.td,{children:"\u2705 Granted"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"User has required role"}),(0,i.jsx)(n.td,{children:"\u2705 Granted"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"User lacks required role"}),(0,i.jsx)(n.td,{children:"\u274c Denied"})]})]})]}),"\n",(0,i.jsx)(n.h2,{id:"\ufe0f-configuring-roles",children:"\u2699\ufe0f Configuring Roles"}),"\n",(0,i.jsx)(n.h3,{id:"via-yaml",children:"Via YAML"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:"dh_auditor:\n    providers:\n        doctrine:\n            entities:\n                App\\Entity\\User:\n                    roles:\n                        view:\n                            - ROLE_ADMIN\n                            - ROLE_AUDITOR\n                App\\Entity\\Post:\n                    roles:\n                        view:\n                            - ROLE_EDITOR\n                App\\Entity\\Comment: ~  # No restrictions\n"})}),"\n",(0,i.jsx)(n.h3,{id:"via-attributes",children:"Via Attributes"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-php",children:"use DH\\Auditor\\Provider\\Doctrine\\Auditing\\Attribute as Audit;\n\n#[Audit\\Auditable]\n#[Audit\\Security(view: ['ROLE_ADMIN', 'ROLE_AUDITOR'])]\nclass User\n{\n    // ...\n}\n"})}),"\n",(0,i.jsx)(n.h2,{id:"-creating-a-custom-checker",children:"\ud83d\udd27 Creating a Custom Checker"}),"\n",(0,i.jsx)(n.h3,{id:"basic-example",children:"Basic Example"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-php",children:"<?php\n\nnamespace App\\Audit;\n\nuse DH\\Auditor\\Security\\RoleCheckerInterface;\nuse Symfony\\Bundle\\SecurityBundle\\Security;\n\nclass CustomRoleChecker implements RoleCheckerInterface\n{\n    public function __construct(\n        private readonly Security $security,\n    ) {}\n\n    public function __invoke(string $entity, string $scope): bool\n    {\n        // Super admins can view everything\n        if ($this->security->isGranted('ROLE_SUPER_ADMIN')) {\n            return true;\n        }\n\n        // Require authentication for all audits\n        if (null === $this->security->getUser()) {\n            return false;\n        }\n\n        return $this->security->isGranted('ROLE_AUDIT_VIEWER');\n    }\n}\n"})}),"\n",(0,i.jsx)(n.h3,{id:"registration",children:"Registration"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:"# config/packages/dh_auditor.yaml\ndh_auditor:\n    role_checker: 'App\\Audit\\CustomRoleChecker'\n"})}),"\n",(0,i.jsx)(n.h2,{id:"-examples",children:"\ud83d\udcda Examples"}),"\n",(0,i.jsx)(n.h3,{id:"-entity-specific-rules",children:"\ud83c\udfaf Entity-Specific Rules"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-php",children:"<?php\n\nnamespace App\\Audit;\n\nuse App\\Entity\\User;\nuse App\\Entity\\Order;\nuse App\\Entity\\Payment;\nuse DH\\Auditor\\Security\\RoleCheckerInterface;\nuse Symfony\\Bundle\\SecurityBundle\\Security;\n\nclass EntityRoleChecker implements RoleCheckerInterface\n{\n    private const ENTITY_ROLES = [\n        User::class => ['ROLE_USER_ADMIN'],\n        Order::class => ['ROLE_ORDER_MANAGER', 'ROLE_ACCOUNTANT'],\n        Payment::class => ['ROLE_ACCOUNTANT'],\n    ];\n\n    public function __construct(\n        private readonly Security $security,\n    ) {}\n\n    public function __invoke(string $entity, string $scope): bool\n    {\n        // Super admin bypass\n        if ($this->security->isGranted('ROLE_SUPER_ADMIN')) {\n            return true;\n        }\n\n        $requiredRoles = self::ENTITY_ROLES[$entity] ?? [];\n\n        // No restriction for unlisted entities\n        if (empty($requiredRoles)) {\n            return true;\n        }\n\n        foreach ($requiredRoles as $role) {\n            if ($this->security->isGranted($role)) {\n                return true;\n            }\n        }\n\n        return false;\n    }\n}\n"})}),"\n",(0,i.jsx)(n.h3,{id:"\ufe0f-using-symfony-voters",children:"\ud83d\uddf3\ufe0f Using Symfony Voters"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-php",children:"<?php\n\nnamespace App\\Audit;\n\nuse DH\\Auditor\\Security\\RoleCheckerInterface;\nuse Symfony\\Bundle\\SecurityBundle\\Security;\n\nclass VoterRoleChecker implements RoleCheckerInterface\n{\n    public function __construct(\n        private readonly Security $security,\n    ) {}\n\n    public function __invoke(string $entity, string $scope): bool\n    {\n        // Delegate to a Symfony voter\n        return $this->security->isGranted('AUDIT_VIEW', $entity);\n    }\n}\n"})}),"\n",(0,i.jsx)(n.p,{children:"With voter:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-php",children:"<?php\n\nnamespace App\\Security\\Voter;\n\nuse Symfony\\Component\\Security\\Core\\Authentication\\Token\\TokenInterface;\nuse Symfony\\Component\\Security\\Core\\Authorization\\Voter\\Voter;\n\nclass AuditVoter extends Voter\n{\n    protected function supports(string $attribute, mixed $subject): bool\n    {\n        return $attribute === 'AUDIT_VIEW' && is_string($subject);\n    }\n\n    protected function voteOnAttribute(string $attribute, mixed $subject, TokenInterface $token): bool\n    {\n        $user = $token->getUser();\n        \n        if (null === $user) {\n            return false;\n        }\n\n        // Custom logic based on $subject (entity FQCN)\n        // and $user\n\n        return true;\n    }\n}\n"})}),"\n",(0,i.jsx)(n.h3,{id:"-external-authorization-service",children:"\ud83d\udd17 External Authorization Service"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-php",children:"<?php\n\nnamespace App\\Audit;\n\nuse App\\Security\\AuthorizationService;\nuse DH\\Auditor\\Security\\RoleCheckerInterface;\nuse Symfony\\Bundle\\SecurityBundle\\Security;\n\nclass ExternalRoleChecker implements RoleCheckerInterface\n{\n    public function __construct(\n        private readonly Security $security,\n        private readonly AuthorizationService $authService,\n    ) {}\n\n    public function __invoke(string $entity, string $scope): bool\n    {\n        $user = $this->security->getUser();\n\n        if (null === $user) {\n            return false;\n        }\n\n        return $this->authService->isAllowed(\n            $user->getUserIdentifier(),\n            'audit',\n            $entity,\n            $scope\n        );\n    }\n}\n"})}),"\n",(0,i.jsx)(n.h3,{id:"-time-based-access",children:"\u23f0 Time-Based Access"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-php",children:"<?php\n\nnamespace App\\Audit;\n\nuse DH\\Auditor\\Security\\RoleCheckerInterface;\nuse Symfony\\Bundle\\SecurityBundle\\Security;\n\nclass TimeBasedRoleChecker implements RoleCheckerInterface\n{\n    public function __construct(\n        private readonly Security $security,\n    ) {}\n\n    public function __invoke(string $entity, string $scope): bool\n    {\n        // Admins always have access\n        if ($this->security->isGranted('ROLE_ADMIN')) {\n            return true;\n        }\n\n        // Others only during business hours\n        $hour = (int) date('H');\n        $dayOfWeek = (int) date('N');\n        \n        $isBusinessHours = $hour >= 9 && $hour < 18;\n        $isWeekday = $dayOfWeek <= 5;\n\n        return $isBusinessHours && $isWeekday;\n    }\n}\n"})}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h2,{id:"-next-steps",children:"\ud83d\ude80 Next Steps"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["\ud83d\udc41\ufe0f ",(0,i.jsx)(n.a,{href:"/auditor-docs/auditor-bundle/viewer/",children:"Audit Viewer"})," - Web interface for browsing audits"]}),"\n",(0,i.jsxs)(n.li,{children:["\ud83d\udc64 ",(0,i.jsx)(n.a,{href:"/auditor-docs/auditor-bundle/customization/user-provider",children:"User Provider"})," - Customize user identification"]}),"\n",(0,i.jsxs)(n.li,{children:["\ud83d\udd12 ",(0,i.jsx)(n.a,{href:"/auditor-docs/auditor-bundle/customization/security-provider",children:"Security Provider"})," - Customize IP/context detection"]}),"\n"]})]})}function d(e={}){const{wrapper:n}={...(0,s.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(a,{...e})}):a(e)}},8453(e,n,t){t.d(n,{R:()=>c,x:()=>o});var r=t(6540);const i={},s=r.createContext(i);function c(e){const n=r.useContext(s);return r.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:c(e.components),r.createElement(s.Provider,{value:n},e.children)}}}]);