"use strict";(self.webpackChunkauditor_docs=self.webpackChunkauditor_docs||[]).push([[3510],{97380(e,n,a){a.r(n),a.d(n,{assets:()=>o,contentTitle:()=>d,default:()=>u,frontMatter:()=>s,metadata:()=>t,toc:()=>c});const t=JSON.parse('{"id":"configuration/storage","title":"Storage Configuration","description":"Configure audit storage, including multi-database setups","source":"@site/docs/auditor-bundle/configuration/storage.md","sourceDirName":"configuration","slug":"/configuration/storage","permalink":"/auditor-docs/auditor-bundle/configuration/storage","draft":false,"unlisted":false,"tags":[],"version":"current","frontMatter":{},"sidebar":"auditorBundleSidebar","previous":{"title":"Configuration Reference","permalink":"/auditor-docs/auditor-bundle/configuration/"},"next":{"title":"Entity Attributes","permalink":"/auditor-docs/auditor-bundle/configuration/attributes"}}');var i=a(74848),r=a(28453);const s={},d="Storage Configuration",o={},c=[{value:"\ud83d\uddc4\ufe0f Default Setup",id:"\ufe0f-default-setup",level:2},{value:"\ud83d\udcdd Table Naming",id:"-table-naming",level:2},{value:"\ud83d\uddc3\ufe0f Multi-Database Setup",id:"\ufe0f-multi-database-setup",level:2},{value:"Configuration",id:"configuration",level:3},{value:"1\ufe0f\u20e3 Configure Multiple Entity Managers",id:"1\ufe0f\u20e3-configure-multiple-entity-managers",level:4},{value:"2\ufe0f\u20e3 Configure Storage Services",id:"2\ufe0f\u20e3-configure-storage-services",level:4},{value:"\ud83d\uddfa\ufe0f Storage Mapper",id:"\ufe0f-storage-mapper",level:3},{value:"Creating a Storage Mapper",id:"creating-a-storage-mapper",level:4},{value:"Routing by Entity",id:"routing-by-entity",level:4},{value:"Configuration",id:"configuration-1",level:4},{value:"\ud83d\udd27 Schema Management",id:"-schema-management",level:2},{value:"Single Database",id:"single-database",level:3},{value:"Multiple Databases",id:"multiple-databases",level:3},{value:"\ud83c\udfd7\ufe0f Architecture Comparison",id:"\ufe0f-architecture-comparison",level:2},{value:"Single Database (Recommended)",id:"single-database-recommended",level:3},{value:"Separate Database",id:"separate-database",level:3},{value:"\ud83d\ude80 Next Steps",id:"-next-steps",level:2}];function l(e){const n={a:"a",blockquote:"blockquote",code:"code",div:"div",h1:"h1",h2:"h2",h3:"h3",h4:"h4",header:"header",hr:"hr",li:"li",mermaid:"mermaid",p:"p",path:"path",pre:"pre",strong:"strong",svg:"svg",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,r.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.header,{children:(0,i.jsx)(n.h1,{id:"storage-configuration",children:"Storage Configuration"})}),"\n",(0,i.jsxs)(n.blockquote,{children:["\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Configure audit storage, including multi-database setups"})}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"This guide covers audit storage configuration, including multi-database setups."}),"\n",(0,i.jsx)(n.h2,{id:"\ufe0f-default-setup",children:"\ud83d\uddc4\ufe0f Default Setup"}),"\n",(0,i.jsx)(n.p,{children:"By default, audits are stored in the same database as your entities using the default entity manager:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:"dh_auditor:\n    providers:\n        doctrine:\n            storage_services:\n                - '@doctrine.orm.default_entity_manager'\n"})}),"\n",(0,i.jsxs)(n.p,{children:["This provides ",(0,i.jsx)(n.strong,{children:"transactional integrity"}),": audit entries are part of the same database transaction as entity changes."]}),"\n",(0,i.jsx)(n.h2,{id:"-table-naming",children:"\ud83d\udcdd Table Naming"}),"\n",(0,i.jsxs)(n.p,{children:["Audit tables are named: ",(0,i.jsx)(n.code,{children:"{prefix}{entity_table}{suffix}"})]}),"\n",(0,i.jsxs)(n.table,{children:[(0,i.jsx)(n.thead,{children:(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.th,{children:"Option"}),(0,i.jsx)(n.th,{children:"Default"}),(0,i.jsxs)(n.th,{children:["Example (entity: ",(0,i.jsx)(n.code,{children:"users"}),")"]})]})}),(0,i.jsxs)(n.tbody,{children:[(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"table_prefix"})}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"''"})}),(0,i.jsxs)(n.td,{children:["\u2192 ",(0,i.jsx)(n.code,{children:"users_audit"})]})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"table_suffix"})}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"'_audit'"})}),(0,i.jsxs)(n.td,{children:["\u2192 ",(0,i.jsx)(n.code,{children:"users_audit"})]})]})]})]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:"dh_auditor:\n    providers:\n        doctrine:\n            table_prefix: 'audit_'\n            table_suffix: ''\n"})}),"\n",(0,i.jsxs)(n.p,{children:["Result: ",(0,i.jsx)(n.code,{children:"users"})," \u2192 ",(0,i.jsx)(n.code,{children:"audit_users"})]}),"\n",(0,i.jsx)(n.h2,{id:"\ufe0f-multi-database-setup",children:"\ud83d\uddc3\ufe0f Multi-Database Setup"}),"\n",(0,i.jsx)(n.p,{children:"Store audits in a separate database from your entities."}),"\n",(0,i.jsxs)(n.div,{className:"markdown-alert markdown-alert-caution",dir:"auto",children:["\n",(0,i.jsxs)(n.p,{className:"markdown-alert-title",dir:"auto",children:[(0,i.jsx)(n.svg,{className:"octicon",viewBox:"0 0 16 16",width:"16",height:"16","aria-hidden":"true",children:(0,i.jsx)(n.path,{d:"M4.47.22A.749.749 0 0 1 5 0h6c.199 0 .389.079.53.22l4.25 4.25c.141.14.22.331.22.53v6a.749.749 0 0 1-.22.53l-4.25 4.25A.749.749 0 0 1 11 16H5a.749.749 0 0 1-.53-.22L.22 11.53A.749.749 0 0 1 0 11V5c0-.199.079-.389.22-.53Zm.84 1.28L1.5 5.31v5.38l3.81 3.81h5.38l3.81-3.81V5.31L10.69 1.5ZM8 4a.75.75 0 0 1 .75.75v3.5a.75.75 0 0 1-1.5 0v-3.5A.75.75 0 0 1 8 4Zm0 8a1 1 0 1 1 0-2 1 1 0 0 1 0 2Z"})}),"CAUTION"]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Warning: Atomicity"})}),"\n",(0,i.jsxs)(n.p,{children:["Using separate databases ",(0,i.jsx)(n.strong,{children:"breaks transactional integrity"}),":"]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["Entity changes and audits are in ",(0,i.jsx)(n.strong,{children:"different transactions"})]}),"\n",(0,i.jsx)(n.li,{children:"If entity operation succeeds but audit fails \u2192 missing audit"}),"\n",(0,i.jsx)(n.li,{children:"If entity operation fails but audit succeeds \u2192 orphan audit"}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"Only use this when the trade-offs are acceptable."}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"configuration",children:"Configuration"}),"\n",(0,i.jsx)(n.h4,{id:"1\ufe0f\u20e3-configure-multiple-entity-managers",children:"1\ufe0f\u20e3 Configure Multiple Entity Managers"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:"# config/packages/doctrine.yaml\ndoctrine:\n    dbal:\n        default_connection: default\n        connections:\n            default:\n                url: '%env(DATABASE_URL)%'\n            audit:\n                url: '%env(AUDIT_DATABASE_URL)%'\n    \n    orm:\n        default_entity_manager: default\n        entity_managers:\n            default:\n                connection: default\n                mappings:\n                    App:\n                        type: attribute\n                        dir: '%kernel.project_dir%/src/Entity'\n                        prefix: 'App\\Entity'\n            audit:\n                connection: audit\n                # No mappings needed - audit tables are created dynamically\n"})}),"\n",(0,i.jsx)(n.h4,{id:"2\ufe0f\u20e3-configure-storage-services",children:"2\ufe0f\u20e3 Configure Storage Services"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:"# config/packages/dh_auditor.yaml\ndh_auditor:\n    providers:\n        doctrine:\n            storage_services:\n                - '@doctrine.orm.audit_entity_manager'\n            \n            auditing_services:\n                - '@doctrine.orm.default_entity_manager'\n            \n            entities:\n                App\\Entity\\User: ~\n"})}),"\n",(0,i.jsx)(n.h3,{id:"\ufe0f-storage-mapper",children:"\ud83d\uddfa\ufe0f Storage Mapper"}),"\n",(0,i.jsx)(n.p,{children:"When using multiple storage services, a storage mapper routes audits to the correct database."}),"\n",(0,i.jsx)(n.h4,{id:"creating-a-storage-mapper",children:"Creating a Storage Mapper"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-php",children:"<?php\n\nnamespace App\\Audit;\n\nuse DH\\Auditor\\Provider\\Service\\StorageServiceInterface;\n\nclass StorageMapper\n{\n    /**\n     * @param string $entity The audited entity FQCN\n     * @param array<string, StorageServiceInterface> $storageServices\n     */\n    public function __invoke(string $entity, array $storageServices): StorageServiceInterface\n    {\n        // All audits go to the audit database\n        return $storageServices['dh_auditor.provider.doctrine.storage_services.doctrine.orm.audit_entity_manager'];\n    }\n}\n"})}),"\n",(0,i.jsx)(n.h4,{id:"routing-by-entity",children:"Routing by Entity"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-php",children:"<?php\n\nnamespace App\\Audit;\n\nuse App\\Entity\\HighSecurityEntity;\nuse App\\Entity\\SensitiveData;\nuse DH\\Auditor\\Provider\\Service\\StorageServiceInterface;\n\nclass StorageMapper\n{\n    private const SECURE_ENTITIES = [\n        HighSecurityEntity::class,\n        SensitiveData::class,\n    ];\n\n    public function __invoke(string $entity, array $storageServices): StorageServiceInterface\n    {\n        if (in_array($entity, self::SECURE_ENTITIES, true)) {\n            return $storageServices['dh_auditor.provider.doctrine.storage_services.doctrine.orm.secure_entity_manager'];\n        }\n\n        return $storageServices['dh_auditor.provider.doctrine.storage_services.doctrine.orm.default_entity_manager'];\n    }\n}\n"})}),"\n",(0,i.jsx)(n.h4,{id:"configuration-1",children:"Configuration"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:"# config/packages/dh_auditor.yaml\ndh_auditor:\n    providers:\n        doctrine:\n            storage_services:\n                - '@doctrine.orm.default_entity_manager'\n                - '@doctrine.orm.secure_entity_manager'\n            \n            storage_mapper: 'App\\Audit\\StorageMapper'\n"})}),"\n",(0,i.jsx)(n.h2,{id:"-schema-management",children:"\ud83d\udd27 Schema Management"}),"\n",(0,i.jsx)(n.h3,{id:"single-database",children:"Single Database"}),"\n",(0,i.jsx)(n.p,{children:"Use standard Doctrine tools:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"# With migrations (recommended)\nbin/console doctrine:migrations:diff\nbin/console doctrine:migrations:migrate\n\n# Or schema tool\nbin/console doctrine:schema:update --force\n"})}),"\n",(0,i.jsx)(n.h3,{id:"multiple-databases",children:"Multiple Databases"}),"\n",(0,i.jsx)(n.p,{children:"Use the audit schema command:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"# Preview changes\nbin/console audit:schema:update --dump-sql\n\n# Apply changes\nbin/console audit:schema:update --force\n"})}),"\n",(0,i.jsx)(n.p,{children:"This command handles all configured storage services."}),"\n",(0,i.jsx)(n.h2,{id:"\ufe0f-architecture-comparison",children:"\ud83c\udfd7\ufe0f Architecture Comparison"}),"\n",(0,i.jsx)(n.h3,{id:"single-database-recommended",children:"Single Database (Recommended)"}),"\n",(0,i.jsx)(n.mermaid,{value:'flowchart TB\n    subgraph DB["Main Database"]\n        direction TB\n        subgraph ENTITIES["Entity Tables"]\n            users\n            posts\n            comments\n        end\n        subgraph AUDITS["Audit Tables"]\n            users_audit\n            posts_audit\n            comments_audit\n        end\n    end\n    \n    ENTITIES -.->|Same transaction| AUDITS\n    \n    style DB fill:#e8f5e9'}),"\n",(0,i.jsxs)(n.p,{children:["\u2705 ",(0,i.jsx)(n.strong,{children:"Same transaction = Data integrity"})]}),"\n",(0,i.jsx)(n.h3,{id:"separate-database",children:"Separate Database"}),"\n",(0,i.jsx)(n.mermaid,{value:'flowchart LR\n    subgraph MAIN["Main Database"]\n        direction TB\n        users\n        posts\n    end\n    \n    subgraph AUDIT["Audit Database"]\n        direction TB\n        users_audit\n        posts_audit\n    end\n    \n    MAIN -.->|Different transactions| AUDIT\n    \n    style MAIN fill:#e3f2fd\n    style AUDIT fill:#fff3e0'}),"\n",(0,i.jsxs)(n.p,{children:["\u26a0\ufe0f ",(0,i.jsx)(n.strong,{children:"Different transactions = Possible inconsistency"})]}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h2,{id:"-next-steps",children:"\ud83d\ude80 Next Steps"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["\u2699\ufe0f ",(0,i.jsx)(n.a,{href:"/auditor-docs/auditor-bundle/configuration/",children:"Configuration Reference"})," - All options"]}),"\n",(0,i.jsxs)(n.li,{children:["\u2b06\ufe0f ",(0,i.jsx)(n.a,{href:"/auditor-docs/auditor-bundle/upgrade/",children:"Upgrade Guide"})," - Managing audit tables"]}),"\n",(0,i.jsxs)(n.li,{children:["\ud83d\udd27 ",(0,i.jsx)(n.a,{href:"/auditor-docs/auditor-bundle/customization/",children:"Customization"})," - Custom providers"]}),"\n"]})]})}function u(e={}){const{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(l,{...e})}):l(e)}},28453(e,n,a){a.d(n,{R:()=>s,x:()=>d});var t=a(96540);const i={},r=t.createContext(i);function s(e){const n=t.useContext(r);return t.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function d(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:s(e.components),t.createElement(r.Provider,{value:n},e.children)}}}]);